<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Nix_flakes_tips | NixOS Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Shallow Clone Nixpkgs

     



Shallow clone nixpkgs, the full Git history isn&rsquo;t always necessary and this
can speed up build times.


The only issue I&rsquo;ve had is nix-index-database not working well with the
shallow clone&hellip; Other than that no issues after running for a few months.

# flake.nix
inputs = {
    nixpkgs.url = &#34;git&#43;https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable&#34;;
};

Some times when you might need a full clone are debugging and working with
repository history but those are rare.

Import your Non-Flake Wallpaper Repo

Importing your non-flake wallpapers repo:

# flake.nix
inputs = {
    wallpapers = {
      url = &#34;github:saylesss88/wallpapers&#34;;
      flake = false;
    };
}

After adding the input I can access individual wallpapers by adding the inputs argument and
something like path = &quot;${inputs.wallpapers}/Aesthetic Scenery.jpg&quot;;

Understanding @-patterns

Understanding @-patterns, being able to reference your outputs argument set as a whole. An
@-pattern is a way for a function can access variadic attributes (i.e. varying number of
arguments).

# flake.nix
inputs = {
    home-manager.url = &#34;github:nix-community/home-manager/master&#34;;
    home-manager.inputs.nixpkgs.follows = &#34;nixpkgs&#34;;
    stylix.url = &#34;github:danth/stylix&#34;;
};
outputs = {
    self,
    nixpkgs,
    home-manager,
} @ inputs:
With the above example to add the modules to your nixosConfigurations you would add something
like this:">
<meta name="author" content="T Sawyer">
<link rel="canonical" href="http://localhost:1313/posts/nix_flakes_tips/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/nix_flakes_tips/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="NixOS Blog (Alt + H)">NixOS Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Nix_flakes_tips
    </h1>
    <div class="post-meta"><span title='2025-05-14 19:24:27 -0400 EDT'>May 14, 2025</span>&nbsp;·&nbsp;T Sawyer

</div>
  </header> 
  <div class="post-content"><h1 id="shallow-clone-nixpkgs">Shallow Clone Nixpkgs<a hidden class="anchor" aria-hidden="true" href="#shallow-clone-nixpkgs">#</a></h1>
<figure>
    <img loading="lazy" src="/images/gruv8.png"
         alt="gruv8" width="1000"/> 
</figure>

<ol>
<li>Shallow clone nixpkgs, the full Git history isn&rsquo;t always necessary and this
can speed up build times.</li>
</ol>
<ul>
<li>The only issue I&rsquo;ve had is <code>nix-index-database</code> not working well with the
shallow clone&hellip; Other than that no issues after running for a few months.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable&#34;</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>Some times when you might need a full clone are debugging and working with
repository history but those are rare.</li>
</ul>
<h2 id="import-your-non-flake-wallpaper-repo">Import your Non-Flake Wallpaper Repo<a hidden class="anchor" aria-hidden="true" href="#import-your-non-flake-wallpaper-repo">#</a></h2>
<ol start="2">
<li>Importing your non-flake wallpapers repo:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    wallpapers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:saylesss88/wallpapers&#34;</span>;
</span></span><span style="display:flex;"><span>      flake <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>After adding the input I can access individual wallpapers by adding the <code>inputs</code> argument and
something like <code>path = &quot;${inputs.wallpapers}/Aesthetic Scenery.jpg&quot;;</code></li>
</ul>
<h2 id="understanding--patterns">Understanding @-patterns<a hidden class="anchor" aria-hidden="true" href="#understanding--patterns">#</a></h2>
<ol start="3">
<li>Understanding <code>@-patterns</code>, being able to reference your outputs argument set as a whole. An
<code>@-pattern</code> is a way for a function can access variadic attributes (i.e. varying number of
arguments).</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    home-manager<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:nix-community/home-manager/master&#34;</span>;
</span></span><span style="display:flex;"><span>    home-manager<span style="color:#f92672">.</span>inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    stylix<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:danth/stylix&#34;</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>outputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    home-manager<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>} <span style="color:#f92672">@</span> inputs:
</span></span></code></pre></div><p>With the above example to add the modules to your nixosConfigurations you would add something
like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>nixosConfigurations<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>host<span style="color:#e6db74">}</span> <span style="color:#f92672">=</span> nixpkgs<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>nixosSystem {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>  specialArgs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">inherit</span> inputs username host email systemSettings;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>modules <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">./hosts</span><span style="color:#960050;background-color:#1e0010">/$</span>{host}<span style="color:#e6db74">/config.nix</span>
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">.</span>stylix<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>stylix
</span></span><span style="display:flex;"><span>  home-manager<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>home-manager
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># .. snip ..</span>
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><ul>
<li>Notice that since home-manager was explicitly listed in the outputs arguments:
<code>outputs = { self, nixpkgs, home-manager, }; </code> the <code>inputs</code> prefix is unnecessary.
If home-manager was removed from the outputs arguments: <code>outputs = { self, ... }</code>
then you would need <code>modules = [ inputs.home-manager.nixosModules.home-manager];</code> This can be confusing
because many docs assume your not using an @-pattern so if you have one in your flake you need to prefix
with <code>inputs</code>. I use this to reference my personal wallpapers repo mentioned earlier.</li>
</ul>
<h2 id="understanding-specialargs">Understanding <code>specialArgs</code><a hidden class="anchor" aria-hidden="true" href="#understanding-specialargs">#</a></h2>
<ol start="4">
<li>Understanding <code>specialArgs</code> (nixos) and <code>extraSpecialArgs</code> (home-manager). Building on the @-patterns, using
<code>specialArgs</code> and <code>extraSpecialArgs</code> is a way to pass arguments from your flake to your NixOS and home-manager
modules.</li>
</ol>
<p>For example, here is a snippet of some variables I set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>outputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  nixpkgs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  home-manager<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>} <span style="color:#f92672">@</span> inputs: <span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>  system <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;x86_64-linux&#34;</span>;
</span></span><span style="display:flex;"><span>  host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;magic&#34;</span>;
</span></span><span style="display:flex;"><span>  username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jr&#34;</span>;
</span></span><span style="display:flex;"><span>  userVars <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    timezone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;America/New_York&#34;</span>;
</span></span><span style="display:flex;"><span>    locale <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;en_US.UTF-8&#34;</span>;
</span></span><span style="display:flex;"><span>    gitUsername <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;TSawyer87&#34;</span>;
</span></span><span style="display:flex;"><span>    dotfilesDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;~/.dotfiles&#34;</span>;
</span></span><span style="display:flex;"><span>    wm <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hyprland&#34;</span>;
</span></span><span style="display:flex;"><span>    browser <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firefox&#34;</span>;
</span></span><span style="display:flex;"><span>    term <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ghostty&#34;</span>;
</span></span><span style="display:flex;"><span>    editor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hx&#34;</span>;
</span></span><span style="display:flex;"><span>    keyboardLayout <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;us&#34;</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">in</span>
</span></span></code></pre></div><p>Now I can pass them as special args like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>nixosConfigurations <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">${</span>host<span style="color:#e6db74">}</span> <span style="color:#f92672">=</span> nixpkgs<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>nixosSystem {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>        specialArgs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">inherit</span>
</span></span><span style="display:flex;"><span>            inputs
</span></span><span style="display:flex;"><span>            username
</span></span><span style="display:flex;"><span>            system
</span></span><span style="display:flex;"><span>            host
</span></span><span style="display:flex;"><span>            userVars
</span></span><span style="display:flex;"><span>            ;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        modules <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">./hosts</span><span style="color:#960050;background-color:#1e0010">/$</span>{host}<span style="color:#e6db74">/configuration.nix</span>
</span></span><span style="display:flex;"><span>        home-manager<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>home-manager
</span></span><span style="display:flex;"><span>        inputs<span style="color:#f92672">.</span>stylix<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>stylix
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          home-manager<span style="color:#f92672">.</span>useGlobalPkgs <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>          home-manager<span style="color:#f92672">.</span>useUserPackages <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>          home-manager<span style="color:#f92672">.</span>users<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>username<span style="color:#e6db74">}</span> <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">./hosts</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#e6db74">${</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">/home.nix</span>;
</span></span><span style="display:flex;"><span>          home-manager<span style="color:#f92672">.</span>backupFileExtension <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;backup&#34;</span>;
</span></span><span style="display:flex;"><span>          home-manager<span style="color:#f92672">.</span>extraSpecialArgs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">inherit</span>
</span></span><span style="display:flex;"><span>              inputs
</span></span><span style="display:flex;"><span>              username
</span></span><span style="display:flex;"><span>              system
</span></span><span style="display:flex;"><span>              host
</span></span><span style="display:flex;"><span>              userVars
</span></span><span style="display:flex;"><span>              ;
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ];
</span></span></code></pre></div><ul>
<li>To access values in <code>userVars</code> for example:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># git.nix</span>
</span></span><span style="display:flex;"><span>{ userVars<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }: {
</span></span><span style="display:flex;"><span>  programs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    git <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>      userName <span style="color:#f92672">=</span> userVars<span style="color:#f92672">.</span>gitUsername;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="set-up-flake-check-and-formatter-outputs">Set up Flake Check and Formatter Outputs<a hidden class="anchor" aria-hidden="true" href="#set-up-flake-check-and-formatter-outputs">#</a></h2>
<ol start="5">
<li>Set up <code>checks</code> and <code>formatter</code> outputs with <code>treefmt-nix</code>. Add <code>treefmt-nix</code> to your inputs and outputs arguments.
Inside the <code>let</code> expression from tip 4 I would add:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... snip ...</span>
</span></span><span style="display:flex;"><span>pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> nixpkgs {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>allowUnfree <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>treefmtEval <span style="color:#f92672">=</span> treefmt-nix<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>evalModule pkgs <span style="color:#e6db74">./treefmt.nix</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  checks<span style="color:#f92672">.</span>x86_64-linux<span style="color:#f92672">.</span>style <span style="color:#f92672">=</span> treefmtEval<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>build<span style="color:#f92672">.</span>check self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  formatter<span style="color:#f92672">.</span>x86_64-linux <span style="color:#f92672">=</span> treefmtEval<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>build<span style="color:#f92672">.</span>wrapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># ... snip ...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And in the <code>treefmt.nix</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># treefmt.nix</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>projectRootFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flake.nix&#34;</span>;
</span></span><span style="display:flex;"><span>programs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  deadnix<span style="color:#f92672">.</span>enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  statix<span style="color:#f92672">.</span>enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  keep-sorted<span style="color:#f92672">.</span>enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  nixfmt <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    strict <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>settings<span style="color:#f92672">.</span>excludes <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*.age&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*.jpg&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*.nu&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;.jj/*&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;flake.lock&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;justfile&#34;</span>
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span>settings<span style="color:#f92672">.</span>formatter <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  deadnix <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  statix <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  nixfmt <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>Use <code>treefmt-nix</code> to manage code formatters and linters as flake outputs. This ensures consistent styling
and catches issues with tools like <code>deadnix</code>, <code>statix</code>, and <code>nixfmt</code>.</p>
</li>
<li>
<p>Use <code>nix fmt</code> in the flake directory to format your whole configuration.</p>
</li>
<li>
<p>Now you can run <code>nix flake check</code> to run your checks. Running <code>nix flake show</code> will list your outputs.</p>
</li>
<li>
<p>Tools like <code>nix-fast-build</code> rely on flake checks and can be used after setting this up.</p>
</li>
</ul>
<h3 id="add-a-devshell-output">Add a devShell Output<a hidden class="anchor" aria-hidden="true" href="#add-a-devshell-output">#</a></h3>
<ol start="6">
<li>Make a devShell output:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span> in
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      checks<span style="color:#f92672">.</span>x86_64-linux<span style="color:#f92672">.</span>style <span style="color:#f92672">=</span> treefmtEval<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>build<span style="color:#f92672">.</span>check self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      formatter<span style="color:#f92672">.</span>x86_64-linux <span style="color:#f92672">=</span> treefmtEval<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>build<span style="color:#f92672">.</span>wrapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      devShells<span style="color:#f92672">.</span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#f92672">.</span>default <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">./lib/dev-shell.nix</span> { <span style="color:#66d9ef">inherit</span> inputs; };
</span></span></code></pre></div><p>and in the <code>dev-shell.nix</code> you could put something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># dev-shell.nix</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  system <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;x86_64-linux&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>}:
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Instantiate nixpkgs with the given system and allow unfree packages</span>
</span></span><span style="display:flex;"><span>  pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> inputs<span style="color:#f92672">.</span>nixpkgs {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">inherit</span> system;
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>allowUnfree <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    overlays <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Add overlays if needed, e.g., inputs.neovim-nightly-overlay.overlays.default</span>
</span></span><span style="display:flex;"><span>    ];
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>pkgs<span style="color:#f92672">.</span>mkShell {
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixos-dev&#34;</span>;
</span></span><span style="display:flex;"><span>  packages <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> pkgs; [
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Nix tools</span>
</span></span><span style="display:flex;"><span>    nixfmt-rfc-style <span style="color:#75715e"># Formatter</span>
</span></span><span style="display:flex;"><span>    deadnix <span style="color:#75715e"># Dead code detection</span>
</span></span><span style="display:flex;"><span>    nixd <span style="color:#75715e"># Nix language server</span>
</span></span><span style="display:flex;"><span>    nil <span style="color:#75715e"># Alternative Nix language server</span>
</span></span><span style="display:flex;"><span>    nh <span style="color:#75715e"># Nix helper</span>
</span></span><span style="display:flex;"><span>    nix-diff <span style="color:#75715e"># Compare Nix derivations</span>
</span></span><span style="display:flex;"><span>    nix-tree <span style="color:#75715e"># Visualize Nix dependencies</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Code editing</span>
</span></span><span style="display:flex;"><span>    helix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># General utilities</span>
</span></span><span style="display:flex;"><span>    git
</span></span><span style="display:flex;"><span>    ripgrep
</span></span><span style="display:flex;"><span>    jq
</span></span><span style="display:flex;"><span>    tree
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  shellHook <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;Welcome to the NixOS development shell!&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;System: </span><span style="color:#e6db74">${</span>system<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;Tools available: nixfmt, deadnix, nixd, nil, nh, nix-diff, nix-tree, helix, git, ripgrep, jq, tree&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#39;&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>You can enter this devshell with <code>nix develop</code> or automatically with <code>direnv</code>.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">NixOS Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
