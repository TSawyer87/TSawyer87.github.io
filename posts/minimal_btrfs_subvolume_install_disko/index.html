<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Minimal_btrfs_subvolume_install_disko | NixOS Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Minimal BTRFS-Subvol Install with Disko and Flakes
Why I Chose BTRFS
I chose BTRFS because I was already familiar with it from using it with Arch
Linux and I found it to be very easy to use. From what I&rsquo;ve read, there are
licensing issues between the Linux Kernel and ZFS which means that ZFS is not
part of the Linux Kernel; it&rsquo;s maintained by the OpenZFS project and available
as a separate kernel module. This can cause issues and make you think more about
your filesystem than I personally want to at this point.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/minimal_btrfs_subvolume_install_disko/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/minimal_btrfs_subvolume_install_disko/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="NixOS Blog (Alt + H)">NixOS Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Minimal_btrfs_subvolume_install_disko
    </h1>
    <div class="post-meta"><span title='2025-06-15 18:14:54 -0400 EDT'>June 15, 2025</span>

</div>
  </header> 
  <div class="post-content"><h1 id="minimal-btrfs-subvol-install-with-disko-and-flakes">Minimal BTRFS-Subvol Install with Disko and Flakes<a hidden class="anchor" aria-hidden="true" href="#minimal-btrfs-subvol-install-with-disko-and-flakes">#</a></h1>
<h2 id="why-i-chose-btrfs">Why I Chose BTRFS<a hidden class="anchor" aria-hidden="true" href="#why-i-chose-btrfs">#</a></h2>
<p>I chose BTRFS because I was already familiar with it from using it with Arch
Linux and I found it to be very easy to use. From what I&rsquo;ve read, there are
licensing issues between the Linux Kernel and ZFS which means that ZFS is not
part of the Linux Kernel; it&rsquo;s maintained by the OpenZFS project and available
as a separate kernel module. This can cause issues and make you think more about
your filesystem than I personally want to at this point.</p>
<p>While ZFS is a solid choice and offers some benefits over BTRFS, I recommend
looking into it before making your own decision.</p>
<p>If you have a ton of RAM you could most likely skip the minimal install and just
set your system up as needed or just use
<a href="https://elis.nu/blog/2020/05/nixos-tmpfs-as-root/">tmpfs as root</a></p>
<h2 id="getting-started-with-disko">Getting Started with Disko<a hidden class="anchor" aria-hidden="true" href="#getting-started-with-disko">#</a></h2>
<p>Disko allows you to declaratively partition and format your disks, and then
mount them to your system. I recommend checking out the
<a href="https://github.com/nix-community/disko/tree/master?tab=readme-ov-file">README</a>
as it is a <strong>disk destroyer</strong> if used incorrectly.</p>
<p>We will mainly be following the
<a href="https://github.com/nix-community/disko/blob/master/docs/quickstart.md">disko quickstart guide</a></p>
<p>Figure 2: <strong>Disko Logo</strong>: Image of the logo for Disko, the NixOS declarative
disk partitioning tool. Sourced from the
<a href="https://github.com/nix-community/disko">Disko project</a>
<img alt="disko logo" loading="lazy" src="../images/disko1.png"></p>
<ol>
<li>
<p>Get the
<a href="https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso">Nixos Minimal ISO</a>
Get it on a usb stick, I use Ventoy with Ventoy2Disk.sh. The following is the
link to the
<a href="https://sourceforge.net/projects/ventoy/files/v1.1.05/ventoy-1.1.05-linux.tar.gz/download">Ventoy TarBall</a>
download, untar it with <code>tar -xzf ventoy-1.1.05-linux.tar.gz</code>, and make it
executable with <code>chmod +x Ventoy2Disk.sh</code>, and finally execute it with
<code>sudo bash Ventoy2Disk.sh</code> Follow the prompts to finish the install.</p>
</li>
<li>
<p>The minimal installer uses <code>wpa_supplicant</code> instead of NetworkManager, to
enable networking run the following:</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl start wpa_supplicant
</span></span><span style="display:flex;"><span>wpa_cli
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; add_network
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; set_network <span style="color:#ae81ff">0</span> ssid <span style="color:#e6db74">&#34;myhomenetwork&#34;</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; set_network <span style="color:#ae81ff">0</span> psk <span style="color:#e6db74">&#34;mypassword&#34;</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; enable_network <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>To exit type <code>quit</code>, then check your connection with <code>ping google.com</code>.</p>
<p>Another option is to do the following, so either the above method or the below
method after starting <code>wpa_supplicant</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Alternative for quick setup (less interactive, but often faster)</span>
</span></span><span style="display:flex;"><span>sudo wpa_passphrase <span style="color:#e6db74">&#34;myhomenetwork&#34;</span> <span style="color:#e6db74">&#34;mypassword&#34;</span> &gt;&gt; /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
</span></span><span style="display:flex;"><span>sudo systemctl restart wpa_supplicant@wlan0.service
</span></span></code></pre></div><ol start="3">
<li>Get your Disk Name with <code>lsblk</code></li>
</ol>
<p>The output should be something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
</span></span><span style="display:flex;"><span>nvme0n1     259:0    <span style="color:#ae81ff">0</span>   1,8T  <span style="color:#ae81ff">0</span> disk
</span></span></code></pre></div><ol start="4">
<li>Copy the disk configuration to your machine. You can choose one from the
<a href="https://github.com/nix-community/disko/tree/master/example">examples directory</a>.
I chose the btrfs-subvolumes layout so I ran the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /tmp
</span></span><span style="display:flex;"><span>curl https://raw.githubusercontent.com/nix-community/disko/refs/heads/master/example/btrfs-subvolumes.nix -o /tmp/disk-config.nix
</span></span></code></pre></div><ol start="5">
<li>Make Necessary changes, I set mine up for impermanence with the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nano /tmp/disk-config.nix
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  disko<span style="color:#f92672">.</span>devices <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    disk <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      main <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;disk&#34;</span>;
</span></span><span style="display:flex;"><span>        device <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/dev/nvme0n1&#34;</span>;
</span></span><span style="display:flex;"><span>        content <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gpt&#34;</span>;
</span></span><span style="display:flex;"><span>          partitions <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            ESP <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>              priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>              name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ESP&#34;</span>;
</span></span><span style="display:flex;"><span>              start <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1M&#34;</span>;
</span></span><span style="display:flex;"><span>              end <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;512M&#34;</span>;
</span></span><span style="display:flex;"><span>              type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EF00&#34;</span>;
</span></span><span style="display:flex;"><span>              content <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;filesystem&#34;</span>;
</span></span><span style="display:flex;"><span>                format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vfat&#34;</span>;
</span></span><span style="display:flex;"><span>                mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/boot&#34;</span>;
</span></span><span style="display:flex;"><span>                mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;umask=0077&#34;</span>];
</span></span><span style="display:flex;"><span>              };
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            root <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>              size <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;100%&#34;</span>;
</span></span><span style="display:flex;"><span>              content <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;btrfs&#34;</span>;
</span></span><span style="display:flex;"><span>                extraArgs <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;-f&#34;</span>]; <span style="color:#75715e"># Override existing partition</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Subvolumes must set a mountpoint in order to be mounted,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># unless their parent is mounted</span>
</span></span><span style="display:flex;"><span>                subvolumes <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e"># Subvolume name is different from mountpoint</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/root&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>;
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=root&#34;</span> <span style="color:#e6db74">&#34;compress=zstd&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>];
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e"># Subvolume name is the same as the mountpoint</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/home&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=home&#34;</span> <span style="color:#e6db74">&#34;compress=zstd&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>];
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home&#34;</span>;
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e"># Sub(sub)volume doesn&#39;t need a mountpoint as its parent is mounted</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/home/user&#34;</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e"># Parent is not mounted so the mountpoint must be set</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/nix&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;subvol=nix&#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;compress=zstd&#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;noatime&#34;</span>
</span></span><span style="display:flex;"><span>                    ];
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/nix&#34;</span>;
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/persist&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/persist&#34;</span>;
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=persist&#34;</span> <span style="color:#e6db74">&#34;compress=zstd&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>];
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/log&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/log&#34;</span>;
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=log&#34;</span> <span style="color:#e6db74">&#34;compress=zstd&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>];
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/lib&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/lib&#34;</span>;
</span></span><span style="display:flex;"><span>                    mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=lib&#34;</span> <span style="color:#e6db74">&#34;compress=zstd&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>];
</span></span><span style="display:flex;"><span>                  };
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e"># This subvolume will be created but not mounted</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;/test&#34;</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>              };
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  fileSystems<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/persist&#34;</span><span style="color:#f92672">.</span>neededForBoot <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  fileSystems<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/var/log&#34;</span><span style="color:#f92672">.</span>neededForBoot <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  fileSystems<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/var/lib&#34;</span><span style="color:#f92672">.</span>neededForBoot <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>You may choose to add a swapfile to the above <code>disk-config.nix</code>, I haven&rsquo;t
included it here because I manage it with the impermanence module. If you were
to add it here you could just add under say the <code>&quot;/lib&quot;</code> section add:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># Persistent subvolume for swapfile</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/persist/swap&#34;</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  mountpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/persist/swap&#34;</span>;
</span></span><span style="display:flex;"><span>  mountOptions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;subvol=persist/swap&#34;</span> <span style="color:#e6db74">&#34;noatime&#34;</span>]; <span style="color:#75715e"># No compression for swap</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>fileSystems<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/persist/swap&#34;</span><span style="color:#f92672">.</span>neededForBoot <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span></code></pre></div><ol start="6">
<li>Run disko to partition, format and mount your disks. <strong>Warning</strong> this will
wipe <strong>EVERYTHING</strong> on your disk. Disko doesn&rsquo;t work with dual boot.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nix --experimental-features <span style="color:#e6db74">&#34;nix-command flakes&#34;</span> run github:nix-community/disko/latest -- --mode destroy,format,mount /tmp/disk-config.nix
</span></span></code></pre></div><p>Check it with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount | grep /mnt
</span></span></code></pre></div><p>The output for an <code>nvme0n1</code> disk would be similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#... snip ...</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>285,subvol<span style="color:#f92672">=</span>/root<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/persist type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>261,subvol<span style="color:#f92672">=</span>/persist<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/etc type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>261,subvol<span style="color:#f92672">=</span>/persist<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/nix type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>260,subvol<span style="color:#f92672">=</span>/nix<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/var/lib type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>258,subvol<span style="color:#f92672">=</span>/lib<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/var/log type btrfs <span style="color:#f92672">(</span>rw,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>259,subvol<span style="color:#f92672">=</span>/log<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/dev/nvme0n1p2 on /mnt/nix/store type btrfs <span style="color:#f92672">(</span>ro,noatime,compress<span style="color:#f92672">=</span>zstd:3,ssd,discard<span style="color:#f92672">=</span>async,space_cache<span style="color:#f92672">=</span>v2,subvolid<span style="color:#f92672">=</span>260,subvol<span style="color:#f92672">=</span>/nix<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... snip ...</span>
</span></span></code></pre></div><ol start="7">
<li>Generate necessary files, here we use <code>--no-filesystems</code> because disko
handles the <code>fileSystems</code> attribute for us.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nixos-generate-config --no-filesystems --root /mnt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mv /tmp/disk-config.nix /mnt/etc/nixos
</span></span></code></pre></div><h3 id="setting-a-flake-for-your-minimal-install">Setting a Flake for your minimal Install<a hidden class="anchor" aria-hidden="true" href="#setting-a-flake-for-your-minimal-install">#</a></h3>
<ol start="8">
<li>Create the flake in your home directory, then move it to <code>/mnt/etc/nixos</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir flake <span style="color:#f92672">&amp;&amp;</span> cd flake
</span></span><span style="display:flex;"><span>nix-shell -p git yazi helix
</span></span><span style="display:flex;"><span>export NIX_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;experimental-features = nix-command flakes&#39;</span>
</span></span><span style="display:flex;"><span>export EDITOR<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hx&#39;</span>
</span></span><span style="display:flex;"><span>hx flake.nix
</span></span></code></pre></div><blockquote>
<p>You&rsquo;ll change <code>hostname = nixpkgs.lib.nixosSystem</code> to your chosen hostname,
(e.g. <code>magic = nixpkgs.lib.nixosSystem</code>). This will be the same as your
<code>networking.hostName = &quot;magic&quot;;</code> in your <code>configuration.nix</code> that we will set
up shortly.</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># flake.nix</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NixOS configuration&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span>;
</span></span><span style="display:flex;"><span>    disko<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:nix-community/disko/latest&#34;</span>;
</span></span><span style="display:flex;"><span>    disko<span style="color:#f92672">.</span>inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>follows <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nixpkgs&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># impermanence.url = &#34;github:nix-community/impermanence&#34;;</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> inputs<span style="color:#f92672">@</span>{ nixpkgs<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }: {
</span></span><span style="display:flex;"><span>    nixosConfigurations <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      hostname <span style="color:#f92672">=</span> nixpkgs<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>nixosSystem {
</span></span><span style="display:flex;"><span>        system <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;x86_64-linux&#34;</span>;
</span></span><span style="display:flex;"><span>        modules <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">./configuration.nix</span>
</span></span><span style="display:flex;"><span>          inputs<span style="color:#f92672">.</span>disko<span style="color:#f92672">.</span>nixosModules<span style="color:#f92672">.</span>disko
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># inputs.impermanence.nixosModules.impermanence</span>
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Move all the files into your flake:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /mnt/etc/nixos/
</span></span><span style="display:flex;"><span>sudo mv disk-config.nix hardware-configuration.nix configuration.nix ~/flake
</span></span></code></pre></div><ol start="9">
<li>Edit <code>configuration.nix</code> with what is required, the following is required, I
clone my original flake repo and move the pieces into place but it&rsquo;s fairly
easy to just type it all out:</li>
</ol>
<ul>
<li>
<p>Bootloader</p>
</li>
<li>
<p>User, the example uses <code>username</code> change this to your chosen username. If you
don&rsquo;t set your hostname it will be <code>nixos</code>.</p>
</li>
<li>
<p>Networking</p>
</li>
<li>
<p><code>hardware-configuration.nix</code> &amp; <code>disk-config.nix</code> for this setup</p>
</li>
<li>
<p><code>initialHashedPassword</code>: Run <code>mkpasswd -m SHA-512 -s</code>, then enter your desired
password. Example output,</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Password: your_secret_password
</span></span><span style="display:flex;"><span>Retype password: your_secret_password
</span></span><span style="display:flex;"><span>$6$random_salt$your_hashed_password_string_here_this_is_very_long_and_complex
</span></span></code></pre></div><p>copy the hashed password and use it for the value of your
<code>initialHashedPassword</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span><span style="color:#75715e"># configuration.nix</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  lib<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  pkgs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}: {
</span></span><span style="display:flex;"><span>  imports <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Include the results of the hardware scan.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">./hardware-configuration.nix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">./disk-config.nix</span>
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  networking<span style="color:#f92672">.</span>hostName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;magic&#34;</span>; <span style="color:#75715e"># This will match the `hostname` of your flake</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  networking<span style="color:#f92672">.</span>networkmanager<span style="color:#f92672">.</span>enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  boot<span style="color:#f92672">.</span>loader<span style="color:#f92672">.</span>systemd-boot<span style="color:#f92672">.</span>enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; <span style="color:#75715e"># (for UEFI systems only)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># List packages installed in system profile.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># You can use https://search.nixos.org/ to find more packages (and options).</span>
</span></span><span style="display:flex;"><span>  environment<span style="color:#f92672">.</span>systemPackages <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> pkgs; [
</span></span><span style="display:flex;"><span>    vim <span style="color:#75715e"># Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   wget</span>
</span></span><span style="display:flex;"><span>    git
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  time<span style="color:#f92672">.</span>timeZone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;America/New_York&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  users<span style="color:#f92672">.</span>users<span style="color:#f92672">.</span>nixos <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    isNormalUser <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    extraGroups <span style="color:#f92672">=</span> [ <span style="color:#e6db74">&#34;wheel&#34;</span> <span style="color:#e6db74">&#34;networkmanager&#34;</span> ]; <span style="color:#75715e"># Add &#34;wheel&#34; for sudo access</span>
</span></span><span style="display:flex;"><span>    initialHashedPassword <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;COPY_YOUR_MKPASSWD_OUTPUT_HERE&#34;</span>; <span style="color:#75715e"># &lt;-- This is where it goes!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># home = &#34;/home/nixos&#34;; # Optional: Disko typically handles home subvolumes</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  console<span style="color:#f92672">.</span>keyMap <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;us&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  nixpkgs<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>allowUnfree <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  system<span style="color:#f92672">.</span>stateVersion <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;25.05&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="10">
<li>Move the flake to <code>/mnt/etc/nixos</code> and run <code>nixos-install</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mv ~/flake /mnt/etc/nixos/
</span></span><span style="display:flex;"><span>sudo nixos-install --flake /mnt/etc/nixos/flake .#hostname
</span></span></code></pre></div><ul>
<li>
<p>You will be prompted to enter a new password if everything succeeds.</p>
</li>
<li>
<p>If everything checks out, reboot the system and you should be prompted to
enter your <code>user</code> and <code>password</code> to login to a shell to get started.</p>
</li>
<li>
<p>The flake will be placed at <code>/etc/nixos/flake</code>, I choose to move it to my home
directory. Since the file was first in <code>/etc</code> you&rsquo;ll need to adjust the
permissions with something like <code>sudo chown username:users ~/flake</code>(<code>username</code>
will be your username) and then you can work on it without privilege
escalation.</p>
</li>
<li>
<p>To continue following along and set up impermanence
<a href="https://saylesss88.github.io/nix/impermanence.html">Click Here</a></p>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">NixOS Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
