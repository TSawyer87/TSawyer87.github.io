<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Btrfs_impermanence | NixOS Blog</title><meta name=keywords content><meta name=description content="Unencrypted BTRFS Impermanence with Flakes
Figure 1: Impermanence Logo: Image of the Impermanence logo. Sourced from
the
This guide is for an unencrypted setup, there are a few links at the end for
encrypted setups. This guide follows the previous
minimal install guide but
you should be able to adjust it carefully to meet your needs.
This section details how to set up impermanence on your NixOS system using BTRFS
subvolumes. With impermanence, your operating system&rsquo;s root filesystem will
reset to a pristine state on each reboot, while designated directories and files
remain persistent. This provides a highly reliable and rollback-friendly system."><meta name=author content><link rel=canonical href=https://tsawyer87.github.io/posts/btrfs_impermanence/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/btrfs_impermanence/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/btrfs_impermanence/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Btrfs_impermanence"><meta property="og:description" content="Unencrypted BTRFS Impermanence with Flakes Figure 1: Impermanence Logo: Image of the Impermanence logo. Sourced from the
This guide is for an unencrypted setup, there are a few links at the end for encrypted setups. This guide follows the previous minimal install guide but you should be able to adjust it carefully to meet your needs.
This section details how to set up impermanence on your NixOS system using BTRFS subvolumes. With impermanence, your operating system’s root filesystem will reset to a pristine state on each reboot, while designated directories and files remain persistent. This provides a highly reliable and rollback-friendly system."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-15T18:15:13-04:00"><meta property="article:modified_time" content="2025-06-15T18:15:13-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Btrfs_impermanence"><meta name=twitter:description content="Unencrypted BTRFS Impermanence with Flakes
Figure 1: Impermanence Logo: Image of the Impermanence logo. Sourced from
the
This guide is for an unencrypted setup, there are a few links at the end for
encrypted setups. This guide follows the previous
minimal install guide but
you should be able to adjust it carefully to meet your needs.
This section details how to set up impermanence on your NixOS system using BTRFS
subvolumes. With impermanence, your operating system&rsquo;s root filesystem will
reset to a pristine state on each reboot, while designated directories and files
remain persistent. This provides a highly reliable and rollback-friendly system."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Btrfs_impermanence","item":"https://tsawyer87.github.io/posts/btrfs_impermanence/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Btrfs_impermanence","name":"Btrfs_impermanence","description":"Unencrypted BTRFS Impermanence with Flakes Figure 1: Impermanence Logo: Image of the Impermanence logo. Sourced from the\nThis guide is for an unencrypted setup, there are a few links at the end for encrypted setups. This guide follows the previous minimal install guide but you should be able to adjust it carefully to meet your needs.\nThis section details how to set up impermanence on your NixOS system using BTRFS subvolumes. With impermanence, your operating system\u0026rsquo;s root filesystem will reset to a pristine state on each reboot, while designated directories and files remain persistent. This provides a highly reliable and rollback-friendly system.\n","keywords":[],"articleBody":"Unencrypted BTRFS Impermanence with Flakes Figure 1: Impermanence Logo: Image of the Impermanence logo. Sourced from the\nThis guide is for an unencrypted setup, there are a few links at the end for encrypted setups. This guide follows the previous minimal install guide but you should be able to adjust it carefully to meet your needs.\nThis section details how to set up impermanence on your NixOS system using BTRFS subvolumes. With impermanence, your operating system’s root filesystem will reset to a pristine state on each reboot, while designated directories and files remain persistent. This provides a highly reliable and rollback-friendly system.\nImpermanence: The Concept and Its BTRFS Implementation In a traditional Linux system, most of this state is stored on the disk and persists indefinitely unless manually deleted or modified. However, this can lead to configuration drift, where the system accumulates changes (e.g., log files, temporary files, or unintended configuration tweaks) that make it harder to reproduce or maintain.\nImpermanence, in the context of operating systems, refers to a setup where the majority of the system’s root filesystem (/) is reset to a pristine state on every reboot. This means any changes made to the system (e.g., installing new packages, modifying system files outside of configuration management, creating temporary files) are discarded upon shutdown or reboot.\nWhat Does Impermanence Do? Impermanence is a NixOS approach that makes the system stateless (or nearly stateless) by wiping the root filesystem (/) on each boot, ensuring a clean, predictable starting point. Only explicitly designated data (persistent state) is preserved across reboots, typically stored in specific locations like the /persist subvolume. This achieves:\nClean Root Filesystem: The root subvolume is deleted and recreated on each boot, erasing transient state (e.g., temporary files, runtime data).\nThis ensures the system starts fresh, reducing clutter and making it behave closer to a declarative system defined by your NixOS configuration.\nSelective Persistence: Critical state (e.g., user files, logs, system configuration) is preserved in designated persistent subvolumes (e.g., /persist, /var/log, /var/lib) or files.\nYou control exactly what state persists by configuring environment.persistence.\"/persist\" or other mechanisms.\nReproducibility and Security: By wiping transient state, impermanence prevents unintended changes from accumulating, making the system more reproducible.\nIt enhances security by ensuring sensitive temporary data (e.g., /tmp, runtime credentials) is erased on reboot.\nGetting Started Add impermanence to your flake.nix. You will change the hostname in the flake to match your networking.hostName. # flake.nix { description = \"NixOS configuration\"; inputs = { nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\"; disko.url = \"github:nix-community/disko/latest\"; disko.inputs.nixpkgs.follows = \"nixpkgs\"; impermanence.url = \"github:nix-community/impermanence\"; }; outputs = inputs@{ nixpkgs, ... }: { nixosConfigurations = { hostname = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [ ./configuration.nix inputs.disko.nixosModules.disko inputs.impermanence.nixosModules.impermanence ]; }; }; }; } Discover where your root subvolume is located with findmnt: Before configuring impermanence, it’s crucial to know the device path and subvolume path of your main BTRFS partition where the root filesystem (/) is located. This information is needed for the mount command within the impermanence script.\nfindmnt / TARGET SOURCE FSTYPE OPTIONS / /dev/disk/by-partlabel/disk-main-root[/root] btrfs rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=275,sub From the SOURCE column, note the full path, including the device (e.g., /dev/disk/by-partlabel/disk-main-root) and the subvolume in brackets (e.g., [/root]). You will use the device path in the next step\n/dev/disk/by-partlabel/disk-main-root is a symlink to the actual device path (e.g. /dev/nvme0n1p2), but using the partlabel is generally more robust for scripts.\nCreate an impermanence.nix: Now, create a new file named impermanence.nix in your configuration directory (i.e. your flake directory). This file will contain all the specific settings for your impermanent setup, including BTRFS subvolume management and persistent data locations\n{lib, ...}: { # Reset root subvolume on boot boot.initrd.postResumeCommands = lib.mkAfter '' mkdir /btrfs_tmp mount /dev/disk/by-partlabel/disk-main-root /btrfs_tmp # CONFIRM THIS IS CORRECT FROM findmnt if [[ -e /btrfs_tmp/root ]]; then mkdir -p /btrfs_tmp/old_roots timestamp=$(date --date=\"@$(stat -c %Y /btrfs_tmp/root)\" \"+%Y-%m-%-d_%H:%M:%S\") mv /btrfs_tmp/root \"/btrfs_tmp/old_roots/$timestamp\" fi delete_subvolume_recursively() { IFS=$'\\n' for i in $(btrfs subvolume list -o \"$1\" | cut -f 9- -d ' '); do delete_subvolume_recursively \"/btrfs_tmp/$i\" done btrfs subvolume delete \"$1\" } for i in $(find /btrfs_tmp/old_roots/ -maxdepth 1 -mtime +30); do delete_subvolume_recursively \"$i\" done btrfs subvolume create /btrfs_tmp/root umount /btrfs_tmp ''; # Use /persist as the persistence root, matching Disko's mountpoint environment.persistence.\"/persist\" = { hideMounts = true; directories = [ \"/etc\" # System configuration (Keep this here for persistence via bind-mount) \"/var/spool\" # Mail queues, cron jobs \"/srv\" # Web server data, etc. \"/root\" # Root user's home # \"/var/log\" # Persist logs are handled by disko ]; files = [ #\"/persist/swapfile\" # Persist swapfile (impermanence manages this file) ]; }; # Swapfile configuration (definition for Systemd) swapDevices = [ { device = \"/persist/swapfile\"; # Points to the persistent location of the swapfile size = 8192; # 8 GB in MiB } ]; # --- SWAPFILE INITIALIZATION \u0026 FORMATTING (CRITICAL for activation) --- # 1. Ensure the swapfile exists at the specified size with correct permissions early via tmpfiles. # The ${toString (8 * 1024 * 1024 * 1024)} converts 8GB to bytes. systemd.tmpfiles.rules = [ \"f /persist/swapfile 0600 - - ${toString (8 * 1024 * 1024 * 1024)} -\" ]; # 2. Format the swapfile *only if it's not already formatted* during boot. boot.initrd.postDeviceCommands = lib.mkAfter '' if ! blkid -p /persist/swapfile | grep -q 'TYPE=\"swap\"'; then echo \"NixOS: Formatting /persist/swapfile...\" mkswap /persist/swapfile fi ''; # --- END SWAPFILE INITIALIZATION \u0026 FORMATTING --- } Applying Your Impermanence Configuration Once you have completed all the steps and created or modified the necessary files (flake.nix, impermanence.nix), you need to apply these changes to your NixOS system.\nNavigate to your NixOS configuration directory (where your flake.nix is located). cd /path/to/your/flake Rebuild and Switch: Execute the nixos-rebuild switch command. This command will: Evaluate your flake.nix and the modules it imports (including your new impermanence.nix).\nBuild a new NixOS system closure based on your updated configuration.\nActivate the new system configuration, making it the current running system.\nsudo nixos-rebuild switch --flake .#hostname # Replace 'hostname' with your actual system hostname Perform an Impermanence Test (Before Reboot): Before you reboot, create a temporary directory and file in a non-persistent location. Since you haven’t explicitly added /imperm_test to your environment.persistence.\"/persist\" directories, this file should not survive a reboot. mkdir /imperm_test echo \"This should be Gone after Reboot\" | sudo tee /imperm_test/testfile ls -l /imperm_test/testfile # Verify the file exists cat /imperm_test/testfile # Verify content Reboot Your System: For the impermanence setup to take full effect and for your root filesystem to be reset for the first time, you must reboot your machine. sudo reboot Verify Impermanence (After Reboot): After the system has rebooted, check if the test directory and file still exist: ls -l /imperm_test/testfile You should see an output like ls: cannot access '/imperm_test/testfile': No such file or directory. This confirms that the /imperm_test directory and its contents were indeed ephemeral and were removed during the reboot process, indicating your impermanence setup is working correctly!\nYour system should now come up with a fresh root filesystem, and only the data specified in your environment.persistence.\"/persist\" configuration will be persistent.\nRelated Material erase your darlings\nGuide for Btrfs with LUKS\nnotashelf impermanence\nNixOS wiki Impermanence\nnix-community impermanence module\n","wordCount":"1187","inLanguage":"en","datePublished":"2025-06-15T18:15:13-04:00","dateModified":"2025-06-15T18:15:13-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/btrfs_impermanence/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<a href=/index.xml title="RSS Feed"><img src=/rss.png alt="RSS Feed" style=width:24px;height:24px></a></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Btrfs_impermanence</h1><div class=post-meta><span title='2025-06-15 18:15:13 -0400 EDT'>June 15, 2025</span></div></header><div class=post-content><h1 id=unencrypted-btrfs-impermanence-with-flakes>Unencrypted BTRFS Impermanence with Flakes<a hidden class=anchor aria-hidden=true href=#unencrypted-btrfs-impermanence-with-flakes>#</a></h1><p>Figure 1: <strong>Impermanence Logo</strong>: Image of the Impermanence logo. Sourced from
the</p><p>This guide is for an unencrypted setup, there are a few links at the end for
encrypted setups. This guide follows the previous
<a href=https://saylesss88.github.io/nix/impermanence.html>minimal install guide</a> but
you should be able to adjust it carefully to meet your needs.</p><p>This section details how to set up impermanence on your NixOS system using BTRFS
subvolumes. With impermanence, your operating system&rsquo;s root filesystem will
reset to a pristine state on each reboot, while designated directories and files
remain persistent. This provides a highly reliable and rollback-friendly system.</p><h2 id=impermanence-the-concept-and-its-btrfs-implementation>Impermanence: The Concept and Its BTRFS Implementation<a hidden class=anchor aria-hidden=true href=#impermanence-the-concept-and-its-btrfs-implementation>#</a></h2><p>In a traditional Linux system, most of this state is stored on the disk and
persists indefinitely unless manually deleted or modified. However, this can
lead to configuration drift, where the system accumulates changes (e.g., log
files, temporary files, or unintended configuration tweaks) that make it harder
to reproduce or maintain.</p><p>Impermanence, in the context of operating systems, refers to a setup where the
majority of the system&rsquo;s root filesystem (<code>/</code>) is reset to a pristine state on
every reboot. This means any changes made to the system (e.g., installing new
packages, modifying system files outside of configuration management, creating
temporary files) are discarded upon shutdown or reboot.</p><h3 id=what-does-impermanence-do>What Does Impermanence Do?<a hidden class=anchor aria-hidden=true href=#what-does-impermanence-do>#</a></h3><p>Impermanence is a NixOS approach that makes the system stateless (or nearly
stateless) by wiping the root filesystem (<code>/</code>) on each boot, ensuring a clean,
predictable starting point. Only explicitly designated data (persistent state)
is preserved across reboots, typically stored in specific locations like the
<code>/persist</code> subvolume. This achieves:</p><ol><li>Clean Root Filesystem:</li></ol><ul><li><p>The root subvolume is deleted and recreated on each boot, erasing transient
state (e.g., temporary files, runtime data).</p></li><li><p>This ensures the system starts fresh, reducing clutter and making it behave
closer to a declarative system defined by your NixOS configuration.</p></li></ul><ol start=2><li>Selective Persistence:</li></ol><ul><li><p>Critical state (e.g., user files, logs, system configuration) is preserved in
designated persistent subvolumes (e.g., <code>/persist</code>, <code>/var/log</code>, <code>/var/lib</code>) or
files.</p></li><li><p>You control exactly what state persists by configuring
<code>environment.persistence."/persist"</code> or other mechanisms.</p></li></ul><ol start=3><li>Reproducibility and Security:</li></ol><ul><li><p>By wiping transient state, impermanence prevents unintended changes from
accumulating, making the system more reproducible.</p></li><li><p>It enhances security by ensuring sensitive temporary data (e.g., <code>/tmp</code>,
runtime credentials) is erased on reboot.</p></li></ul><h3 id=getting-started>Getting Started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h3><ol><li>Add impermanence to your <code>flake.nix</code>. You will change the <code>hostname</code> in the
flake to match your <code>networking.hostName</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NixOS configuration&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span>;
</span></span><span style=display:flex><span>    disko<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nix-community/disko/latest&#34;</span>;
</span></span><span style=display:flex><span>    disko<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    impermanence<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nix-community/impermanence&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> inputs<span style=color:#f92672>@</span>{ nixpkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      hostname <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>./configuration.nix</span>
</span></span><span style=display:flex><span>          inputs<span style=color:#f92672>.</span>disko<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>disko
</span></span><span style=display:flex><span>          inputs<span style=color:#f92672>.</span>impermanence<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>impermanence
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>Discover where your root subvolume is located with <code>findmnt</code>:</li></ol><p>Before configuring impermanence, it&rsquo;s crucial to know the device path and
subvolume path of your main BTRFS partition where the root filesystem (<code>/</code>) is
located. This information is needed for the mount command within the
impermanence script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>findmnt /
</span></span><span style=display:flex><span>TARGET   SOURCE         FSTYPE OPTIONS
</span></span><span style=display:flex><span>/        /dev/disk/by-partlabel/disk-main-root<span style=color:#f92672>[</span>/root<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                        btrfs  rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>275,sub
</span></span></code></pre></div><p>From the SOURCE column, note the full path, including the device (e.g.,
<code>/dev/disk/by-partlabel/disk-main-root</code>) and the subvolume in brackets (e.g.,
<code>[/root]</code>). You will use the device path in the next step</p><p><code>/dev/disk/by-partlabel/disk-main-root</code> is a symlink to the actual device path
(e.g. <code>/dev/nvme0n1p2</code>), but using the partlabel is generally more robust for
scripts.</p><ol start=3><li>Create an <code>impermanence.nix</code>:</li></ol><p>Now, create a new file named <code>impermanence.nix</code> in your configuration directory
(i.e. your flake directory). This file will contain all the specific settings
for your impermanent setup, including BTRFS subvolume management and persistent
data locations</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  <span style=color:#75715e># Reset root subvolume on boot</span>
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>initrd<span style=color:#f92672>.</span>postResumeCommands <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkAfter <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mkdir /btrfs_tmp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mount /dev/disk/by-partlabel/disk-main-root /btrfs_tmp # CONFIRM THIS IS CORRECT FROM findmnt
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if [[ -e /btrfs_tmp/root ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mkdir -p /btrfs_tmp/old_roots
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      timestamp=$(date --date=&#34;@$(stat -c %Y /btrfs_tmp/root)&#34; &#34;+%Y-%m-%-d_%H:%M:%S&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mv /btrfs_tmp/root &#34;/btrfs_tmp/old_roots/$timestamp&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    delete_subvolume_recursively() {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      IFS=$&#39;\n&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      for i in $(btrfs subvolume list -o &#34;$1&#34; | cut -f 9- -d &#39; &#39;); do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        delete_subvolume_recursively &#34;/btrfs_tmp/$i&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      btrfs subvolume delete &#34;$1&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for i in $(find /btrfs_tmp/old_roots/ -maxdepth 1 -mtime +30); do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      delete_subvolume_recursively &#34;$i&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    btrfs subvolume create /btrfs_tmp/root
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    umount /btrfs_tmp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Use /persist as the persistence root, matching Disko&#39;s mountpoint</span>
</span></span><span style=display:flex><span>  environment<span style=color:#f92672>.</span>persistence<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/persist&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    hideMounts <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    directories <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/etc&#34;</span> <span style=color:#75715e># System configuration (Keep this here for persistence via bind-mount)</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/var/spool&#34;</span> <span style=color:#75715e># Mail queues, cron jobs</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/srv&#34;</span> <span style=color:#75715e># Web server data, etc.</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/root&#34;</span> <span style=color:#75715e># Root user&#39;s home</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># &#34;/var/log&#34; # Persist logs are handled by disko</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    files <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e>#&#34;/persist/swapfile&#34; # Persist swapfile (impermanence manages this file)</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Swapfile configuration (definition for Systemd)</span>
</span></span><span style=display:flex><span>  swapDevices <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/persist/swapfile&#34;</span>; <span style=color:#75715e># Points to the persistent location of the swapfile</span>
</span></span><span style=display:flex><span>      size <span style=color:#f92672>=</span> <span style=color:#ae81ff>8192</span>; <span style=color:#75715e># 8 GB in MiB</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># --- SWAPFILE INITIALIZATION &amp; FORMATTING (CRITICAL for activation) ---</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 1. Ensure the swapfile exists at the specified size with correct permissions early via tmpfiles.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#    The ${toString (8 * 1024 * 1024 * 1024)} converts 8GB to bytes.</span>
</span></span><span style=display:flex><span>  systemd<span style=color:#f92672>.</span>tmpfiles<span style=color:#f92672>.</span>rules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;f /persist/swapfile 0600 - - </span><span style=color:#e6db74>${</span>toString (<span style=color:#ae81ff>8</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74> -&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 2. Format the swapfile *only if it&#39;s not already formatted* during boot.</span>
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>initrd<span style=color:#f92672>.</span>postDeviceCommands <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkAfter <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if ! blkid -p /persist/swapfile | grep -q &#39;TYPE=&#34;swap&#34;&#39;; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      echo &#34;NixOS: Formatting /persist/swapfile...&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mkswap /persist/swapfile
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e># --- END SWAPFILE INITIALIZATION &amp; FORMATTING ---</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=applying-your-impermanence-configuration>Applying Your Impermanence Configuration<a hidden class=anchor aria-hidden=true href=#applying-your-impermanence-configuration>#</a></h3><p>Once you have completed all the steps and created or modified the necessary
files (<code>flake.nix</code>, <code>impermanence.nix</code>), you need to apply these changes to your
NixOS system.</p><ol><li>Navigate to your NixOS configuration directory (where your <code>flake.nix</code> is
located).</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /path/to/your/flake
</span></span></code></pre></div><ol start=2><li>Rebuild and Switch: Execute the <code>nixos-rebuild switch</code> command. This command
will:</li></ol><ul><li><p>Evaluate your <code>flake.nix</code> and the modules it imports (including your new
<code>impermanence.nix</code>).</p></li><li><p>Build a new NixOS system closure based on your updated configuration.</p></li><li><p>Activate the new system configuration, making it the current running system.</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nixos-rebuild switch --flake .#hostname <span style=color:#75715e># Replace &#39;hostname&#39; with your actual system hostname</span>
</span></span></code></pre></div><ol start=3><li>Perform an Impermanence Test (Before Reboot):</li></ol><ul><li>Before you reboot, create a temporary directory and file in a non-persistent
location. Since you haven&rsquo;t explicitly added <code>/imperm_test</code> to your
<code>environment.persistence."/persist"</code> directories, this file should not survive
a reboot.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /imperm_test
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;This should be Gone after Reboot&#34;</span> | sudo tee /imperm_test/testfile
</span></span><span style=display:flex><span>ls -l /imperm_test/testfile <span style=color:#75715e># Verify the file exists</span>
</span></span><span style=display:flex><span>cat /imperm_test/testfile <span style=color:#75715e># Verify content</span>
</span></span></code></pre></div><ol start=4><li>Reboot Your System: For the impermanence setup to take full effect and for
your root filesystem to be reset for the first time, you must reboot your
machine.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo reboot
</span></span></code></pre></div><ol start=5><li>Verify Impermanence (After Reboot):</li></ol><ul><li>After the system has rebooted, check if the test directory and file still
exist:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /imperm_test/testfile
</span></span></code></pre></div><p>You should see an output like <code>ls: cannot access '/imperm_test/testfile'</code>: No
such file or directory. This confirms that the <code>/imperm_test</code> directory and its
contents were indeed ephemeral and were removed during the reboot process,
indicating your impermanence setup is working correctly!</p><p>Your system should now come up with a fresh root filesystem, and only the data
specified in your <code>environment.persistence."/persist"</code> configuration will be
persistent.</p><h4 id=related-material>Related Material<a hidden class=anchor aria-hidden=true href=#related-material>#</a></h4><ul><li><p><a href=https://grahamc.com/blog/erase-your-darlings/>erase your darlings</a></p></li><li><p><a href=https://haseebmajid.dev/posts/2024-07-30-how-i-setup-btrfs-and-luks-on-nixos-using-disko/>Guide for Btrfs with LUKS</a></p></li><li><p><a href=https://notashelf.dev/posts/impermanence>notashelf impermanence</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/Impermanence>NixOS wiki Impermanence</a></p></li><li><p><a href=https://github.com/nix-community/impermanence>nix-community impermanence module</a></p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>