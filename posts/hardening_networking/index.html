<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hardening_networking | NixOS Blog</title><meta name=keywords content><meta name=description content="Hardening Networking

⚠️ While I am not a security expert, I have carefully researched and tested
the configurations in this chapter. The advice presented here is grounded in
widely accepted best practices and is generally safe and effective.

However, since networks and systems vary, some adjustments may cause
unexpected issues, especially around critical components like DNS or
firewalls. Always review and test changes in a controlled environment before
applying them broadly."><meta name=author content><link rel=canonical href=https://tsawyer87.github.io/posts/hardening_networking/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/hardening_networking/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/hardening_networking/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Hardening_networking"><meta property="og:description" content="Hardening Networking ⚠️ While I am not a security expert, I have carefully researched and tested the configurations in this chapter. The advice presented here is grounded in widely accepted best practices and is generally safe and effective.
However, since networks and systems vary, some adjustments may cause unexpected issues, especially around critical components like DNS or firewalls. Always review and test changes in a controlled environment before applying them broadly."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-14T08:21:11-04:00"><meta property="article:modified_time" content="2025-08-14T08:21:11-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hardening_networking"><meta name=twitter:description content="Hardening Networking

⚠️ While I am not a security expert, I have carefully researched and tested
the configurations in this chapter. The advice presented here is grounded in
widely accepted best practices and is generally safe and effective.

However, since networks and systems vary, some adjustments may cause
unexpected issues, especially around critical components like DNS or
firewalls. Always review and test changes in a controlled environment before
applying them broadly."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Hardening_networking","item":"https://tsawyer87.github.io/posts/hardening_networking/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hardening_networking","name":"Hardening_networking","description":"Hardening Networking ⚠️ While I am not a security expert, I have carefully researched and tested the configurations in this chapter. The advice presented here is grounded in widely accepted best practices and is generally safe and effective.\nHowever, since networks and systems vary, some adjustments may cause unexpected issues, especially around critical components like DNS or firewalls. Always review and test changes in a controlled environment before applying them broadly.\n","keywords":[],"articleBody":"Hardening Networking ⚠️ While I am not a security expert, I have carefully researched and tested the configurations in this chapter. The advice presented here is grounded in widely accepted best practices and is generally safe and effective.\nHowever, since networks and systems vary, some adjustments may cause unexpected issues, especially around critical components like DNS or firewalls. Always review and test changes in a controlled environment before applying them broadly.\nUnderstand the trade-offs and tailor the settings to your threat model and workflow. Take what’s useful, adapt as needed, and seek expert guidance for more advanced scenarios.\nIntroduction This chapter offers a comprehensive set of network and privacy hardening practices suitable for Linux, especially NixOS. You can confidently implement the entire guide to strengthen your security and privacy.\nThat said, every setup is unique, feel free to adapt or skip sections based on your needs. Start with the basics and build up as you gain confidence. The goal is practical, tested hardening tailored to you.\nPractice Safe Browsing Hygiene Adopt Encrypted DNS and HTTPS Everywhere\nConfigure your system and browsers to use DNS over HTTPS (DoH), DNS over TLS (DoT), or DNSCrypt to prevent DNS leakage. Use HTTPS-Only mode in browsers to encrypt all web traffic. Prefer browsers with strong privacy defaults or add recommended extensions.\nDisable browser “remember password” and autofill features, clear cookies and site data upon exit, and carefully vet suspicious URLs with tools like VirusTotal.\nLimit Account Linking and Use Unique Credentials\nCreate separate accounts with unique passwords instead of signing in with Google, Facebook, or similar services to limit broad data exposure from compromises. Use Metadata Cleaning Tools\nMany files like images, PDFs, and office documents contain hidden metadata information such as location data, device details, and more that can reveal your identity or other sensitive information when you share files publicly.\nTo protect your privacy, always sanitize files by removing this metadata before sharing. Tools like mat2 are designed to strip metadata from a wide range of media files efficiently. (pkgs.mat2)\nUse Anonymous File-Sharing Tools\nFor sensitive transfers, consiter tools like OnionShare that provide anonymity and security.(pkgs.onionshare) Avoid Scanning Random QR Codes Without Verification\nUse QR code scanner apps that check for malicious content before loading links. Understand Your Threat Model\nApply these basics universally, but tailor advanced hardening according to your unique environment, connectivity needs, and risk profile. Delete cookies and site data when the browser is closed. (security not usability).\nUse Strong, Unique Passwords and a Password Manager\nAvoid reused passwords by using reliable password managers like KeePassXC or Bitwarden, both available on NixOS. Pair this with enabling two-factor authentication (2FA) wherever possible. environment.systemPackages = [ pkgs.keepassxc pkgs.kpcli # KeePass CLI # OR pkgs.bitwarden-desktop pkgs.bitwarden-cli ]; I’ve never agreed with the argument, “I’m not doing anything illegal, so I don’t mind if they spy on me and profit from my data.” Whatever your online activities may be, your privacy is your right alone. Why make it easier for others to access your personal information when you have the power to limit your exposure?\nWhy Follow These Basics? These recommended steps help protect your privacy and security while maintaining usability and minimizing system interruptions. They catch common threats like network eavesdropping, password reuse, fingerprinting, and data leakage, providing a solid foundation to build on.\nA vast majority of secure and privacy-focused browsers available for NixOS are based on Firefox. Chromium derivatives like Ungoogled Chromium and Brave do exist in Nixpkgs, but are less recommended by privacy advocates.\nChoosing Secure Browsers and Search Engines On a hardened Linux system, the browser is most often the weakest link exposed to the internet, and so security, privacy, and anti-tracking features of browsers are now as important, or even more important than platform-level protections.\nTor Browser Tor is a modified version of Firefox specifically designed for use with Tor.\nTor routes your internet traffic through a global volunteer-operated network, masking your IP address and activities from local observers, ISPs, websites, and surveillance systems. This helps you protect personal information and maintain anonymity when browsing, communicating, or using online services.\nAdding browser plugins to Tor can de-anonymize you, don’t do it. Tor is already built with the necessary plugins and privacy protecting rules, so adding more is unnecessary and actually dangerous for your anonymity.\nYou can visit both the regular web and .onion sites on Tor. Only the hidden .onion sites are end-to-end encrypted. Bridges are only necessary in countries that don’t allow people to use Tor. Using Bridges when they aren’t needed takes resources away from people in oppressive regimes that need, only use them if necessary. Read the guides, and use Tails OS when it really matters.\nTor on NixOS Tor Browser User Manual\nTor staying-anonymous\nHow to Use Tor\nCool Graphic Showing Secure Connections with Tor\nMullvad-Browser Mullvad-Browser is free and open-source and was developed by the Tor Project in collaboration with Mullvad VPN.(Another Firefox Derivative)\nIt is the Tor Browser without the Tor Network, allowing you to use the privacy features Tor created along with a VPN if you so choose.\nMullvad-Browser, is in Nixpkgs as: pkgs.mullvad-browser LibreWolf LibreWolf is an open-source fork of Firefox with a strong focus on privacy, security, and user freedom. LibreWolf enables always HTTPS, includes uBlockOrigin, and only includes privacy focused search engines by default such as:\nSearXNG an open-source, privacy-respecting metasearch engine that aggregates results from various search services, such as Google, DuckDuckGo, etc without tracking you or profiling your searches.\nExample LibreWolf config implementing many of the STIG recommendations:\n# librewolf.nix {pkgs, lib, config, ...}: let cfg = config.custom.librewolf; in { options.custom.librewolf = { enable = lib.mkOption { type = lib.types.bool; default = true; description = \"Enable the LibreWolf Module\"; }; }; config = lib.mkIf cfg.enable { programs.librewolf = { enable = true; policies = { # A bit annoying DontCheckDefaultBrowser = true; # Pocket is insecure according to DoD DisablePocket = true; # No imperative updates DisableAppUpdate = true; }; settings = { # // SV-16925 - DTBF030 \"security.enable_tls\" = true; # // SV-16925 - DTBF030 \"security.tls.version.min\" = 2; # // SV-16925 - DTBF030 \"security.tls.version.max\" = 4; # // SV-111841 - DTBF210 \"privacy.trackingprotection.fingerprinting.enabled\" = true; # // V-252881 - Retaining Data Upon Shutdown \"browser.sessionstore.privacy_level\" = 0; # // SV-251573 - Customizing the New Tab Page \"browser.newtabpage.activity-stream.enabled\" = false; \"browser.newtabpage.activity-stream.feeds.section.topstories\" = false; \"browser.newtabpage.activity-stream.showSponsored\" = false; \"browser.newtabpage.activity-stream.feeds.snippets\" = false; # // V-251580 - Disabling Feedback Reporting \"browser.chrome.toolbar_tips\" = false; \"browser.selfsupport.url\" = \"\"; \"extensions.abuseReport.enabled\" = false; \"extensions.abuseReport.url\" = \"\"; # // V-251558 - Controlling Data Submission \"datareporting.policy.dataSubmissionEnabled\" = false; \"datareporting.healthreport.uploadEnabled\" = false; \"datareporting.policy.firstRunURL\" = \"\"; \"datareporting.policy.notifications.firstRunURL\" = \"\"; \"datareporting.policy.requiredURL\" = \"\"; # // V-252909 - Disabling Firefox Studies \"app.shield.optoutstudies.enabled\" = false; \"app.normandy.enabled\" = false; \"app.normandy.api_url\" = \"\"; # // V-252908 - Disabling Pocket \"extensions.pocket.enabled\" = false; # // V-251555 - Preventing Improper Script Execution \"dom.disable_window_flip\" = true; # // V-251554 - Restricting Window Movement and Resizing \"dom.disable_window_move_resize\" = true; # // V-251551 - Disabling Form Fill Assistance \"browser.formfill.enable\" = false; # // V-251550 - Blocking Unauthorized MIME Types \"plugin.disable_full_page_plugin_for_types\" = \"application/pdf,application/fdf,application/xfdf,application/lso,application/lss,application/iqy,application/rqy,application/lsl,application/xlk,application/xls,application/xlt,application/pot,application/pps,application/ppt,application/dos,application/dot,application/wks,application/bat,application/ps,application/eps,application/wch,application/wcm,application/wb1,application/wb3,application/rtf,application/doc,application/mdb,application/mde,application/wbk,application/ad,application/adp\"; }; }; xdg.desktopEntries.librewolf = { name = \"LibreWolf\"; exec = \"${pkgs.librewolf}/bin/librewolf\"; }; xdg.mimeApps = { enable = true; defaultApplications = { \"text/html\" = \"librewolf.desktop\"; \"x-scheme-handler/http\" = \"librewolf.desktop\"; \"x-scheme-handler/https\" = \"librewolf.desktop\"; \"x-scheme-handler/about\" = \"librewolf.desktop\"; \"x-scheme-handler/unknown\" = \"librewolf.desktop\"; }; }; }; } And enable it in your home.nix or equivalent with:\n# home.nix custom.librewolf.enable = true; The xdg settings at the end make LibreWolf the defaults for what is listed.\nThanks to JosefKatic for putting the above STIG settings in NixOS format.\nYou can test your browser to see how well you are protected from tracking and fingerprinting at Cover Your Tracks.\nman page machine-id(5)\nThe following example is adapted from Firejail All About Tor section, adapted for NixOS.\nSave the following script as cleanup.sh, change Your-User to your username:\n#!/bin/sh -e USER=\"Your-User\" HOME_DIR=\"/home/$USER\" # clear user cache directly as root sudo -u \"$USER\" rm -fr \"$HOME_DIR/.cache\" # generate a new machine-id rm -f /var/lib/machine-id dbus-uuidgen \u003e /var/lib/machine-id cp /var/lib/machine-id /etc/machine-id chmod 444 /etc/machine-id exit 0 The ~/.cache directory is where most programs store runtime information: webpages you visited, torrent trackers you connected to, and deleted emails. It’s a good idea to remove them at shutdown. –Firejail all-about-tor\nCheck /etc/machine-id \u0026 ~/.cache before running the script:\ncat /etc/machine-id # Output 0b46feb27a20469da0ee62baaeb51c5c ls ~/.cache chmod +x cleanup.sh sudo ./cleanup.sh Recheck your machine-id and ~/.cache directories, you should have a newly generated machine-id and minimal files in the ~/.cache directory. The Firejail example shows a systemd unit that runs the above script at every shutdown but that may be overkill, I suggest running it occasionally to make it harder for sites to link your machine-id to you.\nPrivacy protection doesn’t need to be perfect to make a difference. The best protection against tracking and fingerprinting available is to use Tor. For your daily driver, tools like Ghostery, UblockOrigin, Privacy Badger, Disconnect, and NoScript reduce fingerprinting significantly but not completely. Some privacy guides will suggest not to use add-ons at all because they make your browser unique, this isn’t one of them. Just use Tor when it truly matters.\nSurveillance Self-Defense How to: Use Tor There are more hardening parameters that can be set but this should be a good starting point for a hardened version of LibreWolf. When testing with Cover your tracks, customized LibreWolf tested as having stronger tracking protection than default Mullvad-Browser and NoScript significantly cuts down the data available for fingerprinting by disabling JavaScript.\nThe Garuda Privacy-Guide has good tips and recommendations for browser add-ons. Virtual Private Networks (VPNs) A VPN (Virtual Private Network) encrypts your Internet connection and routes your traffic through a VPN provider’s servers, masking your IP address from local network observers, ISPs, and websites. Using a VPN can prevent your ISP or local Wi-Fi owner from tracking what sites you visit (they only see a connection to the VPN), and can help circumvent some regional restrictions or filtering.\nHowever, VPNs simply shift your trust: Instead of your ISP seeing your activity, your VPN provider can, so you must trust their privacy policies and infrastructure. Quality and privacy protections vary widely from one VPN company to another.\nYou can use a VPN with Tor, but it’s not recommended unless you’re an advanced user who knows how to configure both in a way that doesn’t compromise your privacy.\nPopular VPNs on NixOS\nMullvad VPN Mullvad VPN uses WireGuard under the hood and only works if systemd-resolvd is enabled.\nWireGuard VPN\nTailscale\nOpenVPN\nSetting up Tailscale I was surprised at how easy this actually was to set up. Either go to https://www.tailscale.com and/or download the app for either Android or IOS, sign up with your identity provider, and click Start connecting devices -\u003e\nTailscale quickstart To add tailscale to NixOS:\n# tailscale.nix {...}: { services.tailscale.enable = true; # Tell the firewall to implicitly trust packets routed over Tailscale: networking.firewall.trustedInterfaces = [\"tailscale0\"]; } Tailscale will automatically use the hostname of your device as the name of the network. If you want to change it to something else:\nsudo tailscale set --hostname= # You can also give your account a nickname sudo tailscale set --nickname= This allows you to refer to your network by name rather than IP address.\nTailscale uses MagicDNS which is enabled by default, and they recommend you keep it enabled.\nThe docs say that by default, devices in your tailnet prefer their local DNS settings and only use the tailnet’s DNS servers when needed. I had to completely disable my Androids DNS settings for tailscale to access the internet through MagicDNS.\nsudo tailscale set --accept-dns=false To connect to tailscale after rebuilding you can run:\nsudo tailscale up Use nslookup to review and debug DNS responses:\nnslookup google.com Server: 127.0.0.1 Address: 127.0.0.1#53 Non-authoritative answer: Name: google.com Address: 142.251.40.206 Name: google.com Address: 2a00:1450:4001:827::200e The 127.0.0.1#53 indicate that instead of using the DNS server pushed by your ISP, router, or Tailscale’s MagicDNS, the system is sending all DNS requests through the loopback device to dnscrypt-proxy in my case. Get the status of your connections to other Tailscale devices:\ntailscale status 1 2 3 4 5 100.1.2.3 device-a apenwarr@ linux active; direct , tx 1116 rx 1124 100.4.5.6 device-b crawshaw@ macOS active; relay , tx 1351 rx 4262 100.7.8.9 device-c danderson@ windows idle; tx 1214 rx 50 100.0.1.2 device-d ross@ iOS — Tailscale Best Practices\nTailscale CLI\nThere is much more you can do with Tailscale, including integrating Mullvad-VPN and using Exit Nodes.\nEncrypted DNS DNS (Domain Name System) resolution is the process of translating a website’s domain name into its corresponding IP address. By default, this traffic isn’t encrypted, which means anyone on the network, from your ISP to potential hackers, can see the websites you’re trying to visit. Encrypted DNS uses protocols to scramble this information, protecting your queries and responses from being intercepted and viewed by others.\nThere are 3 main types of DNS protection:\nDNS over HTTPS (DoH): Uses the HTTPS protocol to encrypt data between the client and the resolver.\nDNS over TLS (DoT): Similar to (DoH), differs in the methods used for encryption and delivery using a separate port from HTTPS.\nDNSCrypt: Uses end-to-end encryption with the added benefit of being able to prevent DNS spoofing attacks.\nUseful resources:\nNixOS Wiki Encrypted DNS\nDomain Name System (DNS)\nWikipedia DNS over HTTPS (DoH)\nWikipedia DNS over TLS (DoT)\nCloudflare Dns Encryption Explained\nNordVPN Encrypted Dns Traffic\nThe following sets up dnscrypt-proxy using DoH (DNS over HTTPS) with an oisd blocklist, they both come directly from the Wiki:\nAdd oisd to your flake inputs:\n# flake.nix inputs = { oisd = { url = \"https://big.oisd.nl/domainswild\"; flake = false; }; }; ❗ NOTE: The oisd blocklist is a plain text file that updates frequently. This can cause nh os switch to fail with a NarHash mismatch error. To fix this, you need to run nix flake update to refresh the blocklist and its hash in your flake.lock file. After that, you can run your nh command again.\nAnd the import the following into your configuration.nix:\n# dnscrypt-proxy.nix { pkgs, lib, inputs, ... }: let blocklist_base = builtins.readFile inputs.oisd; extraBlocklist = ''''; blocklist_txt = pkgs.writeText \"blocklist.txt\" '' ${extraBlocklist} ${blocklist_base} ''; hasIPv6Internet = true; StateDirectory = \"dnscrypt-proxy\"; in { networking = { # Set DNS nameservers to the local host addresses for iPv4 (`127.0.0.1`) \u0026 iPv6 (::1) nameservers = [\"127.0.0.1\" \"::1\"]; # If using dhcpcd # dhcpcd.extraConfig = \"nohook resolv.conf\"; # If using NetworkManager networkmanager.dns = \"none\"; }; services.resolved.enable = lib.mkForce false; # See https://wiki.nixos.org/wiki/Encrypted_DNS services.dnscrypt-proxy2 = { enable = true; # See https://github.com/DNSCrypt/dnscrypt-proxy/blob/master/dnscrypt-proxy/example-dnscrypt-proxy.toml settings = { # See https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md sources.public-resolvers = { urls = [ \"https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md\" \"https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md\" ]; minisign_key = \"RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3\"; cache_file = \"/var/lib/${StateDirectory}/public-resolvers.md\"; }; # Use servers reachable over IPv6 -- Do not enable if you don't have IPv6 connectivity ipv6_servers = hasIPv6Internet; block_ipv6 = ! hasIPv6Internet; blocked_names.blocked_names_file = blocklist_txt; require_dnssec = true; # Logs can get large very quickly... require_nolog = false; require_nofilter = true; # If you want, choose a specific set of servers that come from your sources. # Here it's from https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md # If you don't specify any, dnscrypt-proxy will automatically rank servers # that match your criteria and choose the best one. # server_names = [ ... ]; }; }; systemd.services.dnscrypt-proxy2.serviceConfig.StateDirectory = StateDirectory; } Above, we have a local DNS proxy that encrypts and forwards queries. # You should see that dnscrypt-proxy chooses the Server with the lowest initial latency sudo systemctl status dnscrypt-proxy2 # verify that dnscrypt-proxy is listening sudo ss -lnp | grep 53 # Test a DNS query, if you get valid responses it's working dig @127.0.0.1 example.com +short # check the logs sudo journalctl -u dnscrypt-proxy2 dnscrypt-proxy2 acts as your local DNS resolver listening on your machine (127.0.0.1) for IPv4 and ::1 for iPv6.\nThe system’s DNS settings (networking.nameservers) point to localhost, so all DNS queries from the computer go to dnscrypt-proxy.\ninputs.oisd refers to the flake input oisd blocklist, it prevents your device from connecting to unwanted or harmful domains.\ndnscrypt-proxy2 then encrypts and forwards our DNS requests to third-party public DNSCrypt or DoH servers.\nFirewalls NixOS includes an integrated firewall based on iptables/nftables.\nCloudflare What is a Firewall\nBeginners guide to nftables\nArch Wiki nftables\nThe following firewall setup is based on the dnscrypt setup above utilizing nftables.\nThis nftables firewall configuration is a strong recommended practice for enforcing encrypted DNS on your system by restricting all outbound DNS traffic to a local dnscrypt-proxy process. It greatly reduces DNS leak risks and enforces privacy by limiting DNS queries to trusted, encrypted upstream servers.(This was edited on 08-08-25) replace with the UID given from the command ps -o uid,user,pid,cmd -C dnscrypt-proxy:\n{ ... }: { networking.nftables = { enable = true; ruleset = '' table inet filter { chain output { type filter hook output priority 0; policy accept; # Allow localhost DNS for dnscrypt-proxy2 ip daddr 127.0.0.1 udp dport 53 accept ip6 daddr ::1 udp dport 53 accept ip daddr 127.0.0.1 tcp dport 53 accept ip6 daddr ::1 tcp dport 53 accept # Allow dnscrypt-proxy2 to talk to upstream servers # Replace with: # ps -o uid,user,pid,cmd -C dnscrypt-proxy meta skuid udp dport { 443, 853 } accept meta skuid tcp dport { 443, 853 } accept # Block all other outbound DNS udp dport { 53, 853 } drop tcp dport { 53, 853 } drop } } ''; }; networking.firewall = { enable = true; allowedTCPPorts = [ # Ports open for inbound connections. # Limit these to reduce the attack surface. 22 # SSH – Keep open only if you need remote access. # To change the SSH port in NixOS: # services.openssh.ports = [ 2222 ]; # Update this list to match the new port. # 53 # DNS – Only if running a public DNS server. # 80 # HTTP – Only if hosting a website. # 443 # HTTPS – Only if hosting a secure website. ]; allowedUDPPorts = [ # Ports open for inbound UDP traffic. # Most NixOS workstations won't need any here. # 53 # DNS – Only if running a public DNS server. ]; }; } ❗ TIP: Reduce SSH noise by changing the default port On most systems, SSH listens on TCP port 22 — which means automated bots and scanners will hit it constantly. While this doesn’t replace real security measures, moving SSH to a different port drastically cuts down on drive-by brute-force attempts you’ll see in your logs.\nIn NixOS, change both the SSH daemon port and your firewall rule:\n# Example: Move SSH to port 2222 networking.firewall.allowedTCPPorts = [ 2222 ]; services.openssh.ports = [ 2222 ]; After rebuilding, test from another terminal/session before closing your existing one: ssh -p 2222 user@host nft is a cli tool used to set up, maintain and inspect packet filtering and classification rules in the Linux kernel, in the nftables framework. The Linux kernel subsystem is known as nftables, and ’nf’ stands for Netfilter.–man nft\nsudo nft list ruleset Since we declare our firewall, we’ll only use nft to inspect our ruleset. NixOS Firewall vs nftables Ruleset networking.nftables: This section provides a raw nftables ruleset that gives you granular, low-level control. The rules here are more specific and are meant to handle the intricate logic of the DNS proxy setup. They will be applied directly to the kernel’s nftables subsystem and prevent DNS leaks.\nnetworking.firewall: This is a higher-level, simpler NixOS option that uses iptables rules to open ports for inbound traffic. The rules defined here (allowing port 22) is for incoming SSH connections to the machine, not for outbound traffic, so they do not interfere with the nftables rules that filter the outgoing traffic. (Make sure to comment out or remove this if you don’t SSH into your machine).\nThe firewall ensures only authorized, local encrypted DNS proxy process can speak DNS with the outside world, and that all other DNS requests from any other process are blocked unless they’re to 127.0.0.1 (our local proxy). This is a robust policy against both DNS leaks and local compromise.\nTesting Review listening ports: After each rebuild, use ss -tlpn, nmap or netstat to see which services are accepting connections. Close or firewall anything unnecessary.\nYou can also test firewall DNS restrictions using dig:\ndig @127.0.0.1 example.com # Should work dig @8.8.8.8 example.com # Should fail/time out for normal users This test is actually what alerted me of an improper configuration in the above firewalls nftables rules allowing me to fix it. Initially the second dig command gave results letting me know that the restrictions weren’t being applied correctly. Since we defined an output chain inside table inet filter with the line:\ntype filter hook output priority 0; policy accept; This attaches the chain to the kernel’s OUTPUT hook, so all locally generated packets, including DNS queries are filtered by this chain.\nWithin this chain, the rules:\nExplicitly allow DNS queries to localhost addresses (127.0.0.1 and ::1).\nAllow the dnscrypt-proxy process (running with UID 62396) to send DNS queries on ports 443 and 853 (for DNS-over-HTTPS and DNS-over-TLS).\nDrop all other outbound DNS traffic on ports 53 and 853.\nBecause of this setup, dig queries to your local resolver at 127.0.0.1 pass, but queries directly to public DNS servers like 8.8.8.8 are blocked for users/processes other than the allowed DNS proxy.\nOpenSnitch NixOS Wiki OpenSnitch Opensnitch is an open-source application firewall that focuses on monitoring and controlling outgoing network connections on a per-application basis.\nThis can be used to block apps from accessing the internet that shouldn’t need to (i.e., block telemetry and more). Opensnitch will report that the app has attempted to make an outbound internet connection and block it or allow it based on the rules you set.\nResources Cloudflare What is HTTPS\nWhat is Fingerprinting, more than you realize is being tracked constantly.\nSurveillance Self-Defence has a lot of helpful info to protect your privacy.\noisd.nl the oisd website\nFor potentially dangerous file types like PDFs, office documents, or images, especially those downloaded from untrusted sources such as torrents, consider converting them to a safe PDF format with dangerzone. Dangerzone not only removes metadata but also applies robust sanitization to neutralize malicious content.\nNixOS Wiki LibreWolf, the options in the wiki make it less secure and aren’t recommended settings to use. They explicitly disable several of LibreWolf’s default privacy-enhancing features, such as fingerprinting resistance and clearing session data on shutdown.\nLibreWolf Features You still need to enable DNS over HTTPS through privacy settings.\nSearXNG on NixOS\nWelcome to SearXNG Firefox Hardening Guide\nSTIG Firefox Hardening\nMozilla Firefox Security Technical Implementation Guide The STIG for Mozilla Firefox (Security Technical Implementation Guide) is a set of security configuration standards developed by the U.S. Department of Defense. They are created by the Defense Information Systems Agency (DISA) to secure and harden DoD information systems and software.\n","wordCount":"3812","inLanguage":"en","datePublished":"2025-08-14T08:21:11-04:00","dateModified":"2025-08-14T08:21:11-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/hardening_networking/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<a href=/index.xml title="RSS Feed"><img src=/rss.png alt="RSS Feed" style=width:24px;height:24px></a></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Hardening_networking</h1><div class=post-meta><span title='2025-08-14 08:21:11 -0400 EDT'>August 14, 2025</span></div></header><div class=post-content><h1 id=hardening-networking>Hardening Networking<a hidden class=anchor aria-hidden=true href=#hardening-networking>#</a></h1><blockquote><p>⚠️ While I am not a security expert, I have carefully researched and tested
the configurations in this chapter. The advice presented here is grounded in
widely accepted best practices and is generally safe and effective.</p></blockquote><blockquote><p>However, since networks and systems vary, some adjustments may cause
unexpected issues, especially around critical components like DNS or
firewalls. Always review and test changes in a controlled environment before
applying them broadly.</p></blockquote><blockquote><p>Understand the trade-offs and tailor the settings to your threat model and
workflow. Take what’s useful, adapt as needed, and seek expert guidance for
more advanced scenarios.</p></blockquote><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>This chapter offers a comprehensive set of network and privacy hardening
practices suitable for Linux, especially NixOS. You can confidently implement
the entire guide to strengthen your security and privacy.</p><p>That said, every setup is unique, feel free to adapt or skip sections based on
your needs. Start with the basics and build up as you gain confidence. The goal
is practical, tested hardening tailored to you.</p><h3 id=practice-safe-browsing-hygiene>Practice Safe Browsing Hygiene<a hidden class=anchor aria-hidden=true href=#practice-safe-browsing-hygiene>#</a></h3><p><strong>Adopt Encrypted DNS and HTTPS Everywhere</strong></p><ul><li><p>Configure your system and browsers to use DNS over HTTPS (DoH), DNS over TLS
(DoT), or DNSCrypt to prevent DNS leakage. Use HTTPS-Only mode in browsers to
encrypt all web traffic. Prefer browsers with strong privacy defaults or add
recommended extensions.</p></li><li><p>Disable browser &ldquo;remember password&rdquo; and autofill features, clear cookies and
site data upon exit, and carefully vet suspicious URLs with tools like
<a href=https://www.virustotal.com/gui/home/url>VirusTotal</a>.</p></li></ul><p><strong>Limit Account Linking and Use Unique Credentials</strong></p><ul><li>Create separate accounts with unique passwords instead of signing in with
Google, Facebook, or similar services to limit broad data exposure from
compromises.</li></ul><p><strong>Use Metadata Cleaning Tools</strong></p><ul><li><p>Many files like images, PDFs, and office documents contain hidden metadata
information such as location data, device details, and more that can reveal
your identity or other sensitive information when you share files publicly.</p></li><li><p>To protect your privacy, always sanitize files by removing this metadata
before sharing. Tools like <a href=https://0xacab.org/jvoisin/mat2>mat2</a> are
designed to strip metadata from a wide range of media files efficiently.
(<code>pkgs.mat2</code>)</p></li></ul><p><strong>Use Anonymous File-Sharing Tools</strong></p><ul><li>For sensitive transfers, consiter tools like
<a href=https://github.com/onionshare/onionshare>OnionShare</a> that provide anonymity
and security.(<code>pkgs.onionshare</code>)</li></ul><p><strong>Avoid Scanning Random QR Codes Without Verification</strong></p><ul><li>Use QR code scanner apps that check for malicious content before loading
links.</li></ul><p><strong>Understand Your Threat Model</strong></p><ul><li>Apply these basics universally, but tailor advanced hardening according to
your unique environment, connectivity needs, and risk profile.</li></ul><p><strong>Delete cookies and site data when the browser is closed</strong>. (security not
usability).</p><p><strong>Use Strong, Unique Passwords and a Password Manager</strong></p><ul><li>Avoid reused passwords by using reliable password managers like KeePassXC or
Bitwarden, both available on NixOS. Pair this with enabling two-factor
authentication <strong>(2FA) wherever possible</strong>.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>keepassxc
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>kpcli     <span style=color:#75715e># KeePass CLI</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># OR</span>
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>bitwarden-desktop
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>bitwarden-cli
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><p>I’ve never agreed with the argument, &ldquo;I’m not doing anything illegal, so I don’t
mind if they spy on me and profit from my data.&rdquo; Whatever your online activities
may be, your privacy is your right alone. Why make it easier for others to
access your personal information when you have the power to limit your exposure?</p><h3 id=why-follow-these-basics>Why Follow These Basics?<a hidden class=anchor aria-hidden=true href=#why-follow-these-basics>#</a></h3><p>These recommended steps help protect your privacy and security while maintaining
usability and minimizing system interruptions. They catch common threats like
network eavesdropping, password reuse, fingerprinting, and data leakage,
providing a solid foundation to build on.</p><p>A vast majority of secure and privacy-focused browsers available for NixOS are
based on Firefox. Chromium derivatives like Ungoogled Chromium and Brave do
exist in Nixpkgs, but are less recommended by privacy advocates.</p><h3 id=choosing-secure-browsers-and-search-engines>Choosing Secure Browsers and Search Engines<a hidden class=anchor aria-hidden=true href=#choosing-secure-browsers-and-search-engines>#</a></h3><p>On a hardened Linux system, the browser is most often the weakest link exposed
to the internet, and so security, privacy, and anti-tracking features of
browsers are now as important, or even more important than platform-level
protections.</p><h4 id=tor-browser>Tor Browser<a hidden class=anchor aria-hidden=true href=#tor-browser>#</a></h4><p>Tor is a modified version of Firefox specifically designed for use with Tor.</p><p>Tor routes your internet traffic through a global volunteer-operated network,
masking your IP address and activities from local observers, ISPs, websites, and
surveillance systems. This helps you protect personal information and maintain
anonymity when browsing, communicating, or using online services.</p><p>Adding browser plugins to Tor can de-anonymize you, don&rsquo;t do it. Tor is already
built with the necessary plugins and privacy protecting rules, so adding more is
unnecessary and actually dangerous for your anonymity.</p><p>You can visit both the regular web and <code>.onion</code> sites on Tor. Only the hidden
<code>.onion</code> sites are end-to-end encrypted. Bridges are only necessary in countries
that don&rsquo;t allow people to use Tor. Using Bridges when they aren&rsquo;t needed takes
resources away from people in oppressive regimes that need, only use them if
necessary. Read the guides, and use Tails OS when it really matters.</p><ul><li><a href=https://wiki.nixos.org/wiki/Tor>Tor on NixOS</a><ul><li><p><a href=https://tb-manual.torproject.org/>Tor Browser User Manual</a></p></li><li><p><a href=https://support.torproject.org/faq/staying-anonymous/>Tor staying-anonymous</a></p></li><li><p><a href=https://ssd.eff.org/module/how-to-use-tor>How to Use Tor</a></p></li><li><p><a href=https://torproject.github.io/manual/secure-connections/>Cool Graphic Showing Secure Connections with Tor</a></p></li></ul></li></ul><h4 id=mullvad-browser>Mullvad-Browser<a hidden class=anchor aria-hidden=true href=#mullvad-browser>#</a></h4><p>Mullvad-Browser is free and open-source and was developed by the Tor Project in
collaboration with Mullvad VPN.(Another Firefox Derivative)</p><p>It is the Tor Browser without the Tor Network, allowing you to use the privacy
features Tor created along with a VPN if you so choose.</p><ul><li><a href=https://mullvad.net/en/browser>Mullvad-Browser</a>, is in Nixpkgs as:
<code>pkgs.mullvad-browser</code></li></ul><h2 id=librewolf>LibreWolf<a hidden class=anchor aria-hidden=true href=#librewolf>#</a></h2><p><strong>LibreWolf</strong> is an open-source fork of Firefox with a strong focus on privacy,
security, and user freedom. LibreWolf enables always HTTPS, includes
uBlockOrigin, and only includes privacy focused search engines by default such
as:</p><p><strong>SearXNG</strong> an open-source, privacy-respecting metasearch engine that aggregates
results from various search services, such as Google, DuckDuckGo, etc without
tracking you or profiling your searches.</p><p>Example LibreWolf config implementing many of the STIG recommendations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># librewolf.nix</span>
</span></span><span style=display:flex><span>{pkgs<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>librewolf;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>librewolf <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>bool;
</span></span><span style=display:flex><span>      default <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enable the LibreWolf Module&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkIf cfg<span style=color:#f92672>.</span>enable {
</span></span><span style=display:flex><span>    programs<span style=color:#f92672>.</span>librewolf <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      policies <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># A bit annoying</span>
</span></span><span style=display:flex><span>        DontCheckDefaultBrowser <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e># Pocket is insecure according to DoD</span>
</span></span><span style=display:flex><span>        DisablePocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e># No imperative updates</span>
</span></span><span style=display:flex><span>        DisableAppUpdate <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># // SV-16925 - DTBF030</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;security.enable_tls&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e># // SV-16925 - DTBF030</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;security.tls.version.min&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e># // SV-16925 - DTBF030</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;security.tls.version.max&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // SV-111841 - DTBF210</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;privacy.trackingprotection.fingerprinting.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-252881 - Retaining Data Upon Shutdown</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.sessionstore.privacy_level&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // SV-251573 - Customizing the New Tab Page</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.newtabpage.activity-stream.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.newtabpage.activity-stream.feeds.section.topstories&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.newtabpage.activity-stream.showSponsored&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.newtabpage.activity-stream.feeds.snippets&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251580 - Disabling Feedback Reporting</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.chrome.toolbar_tips&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.selfsupport.url&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;extensions.abuseReport.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;extensions.abuseReport.url&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251558 - Controlling Data Submission</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;datareporting.policy.dataSubmissionEnabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;datareporting.healthreport.uploadEnabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;datareporting.policy.firstRunURL&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;datareporting.policy.notifications.firstRunURL&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;datareporting.policy.requiredURL&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-252909 - Disabling Firefox Studies</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app.shield.optoutstudies.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app.normandy.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app.normandy.api_url&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-252908 - Disabling Pocket</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;extensions.pocket.enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251555 - Preventing Improper Script Execution</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dom.disable_window_flip&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251554 - Restricting Window Movement and Resizing</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dom.disable_window_move_resize&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251551 - Disabling Form Fill Assistance</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;browser.formfill.enable&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># // V-251550 - Blocking Unauthorized MIME Types</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;plugin.disable_full_page_plugin_for_types&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application/pdf,application/fdf,application/xfdf,application/lso,application/lss,application/iqy,application/rqy,application/lsl,application/xlk,application/xls,application/xlt,application/pot,application/pps,application/ppt,application/dos,application/dot,application/wks,application/bat,application/ps,application/eps,application/wch,application/wcm,application/wb1,application/wb3,application/rtf,application/doc,application/mdb,application/mde,application/wbk,application/ad,application/adp&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    xdg<span style=color:#f92672>.</span>desktopEntries<span style=color:#f92672>.</span>librewolf <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LibreWolf&#34;</span>;
</span></span><span style=display:flex><span>      exec <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>librewolf<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/librewolf&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    xdg<span style=color:#f92672>.</span>mimeApps <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      defaultApplications <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;text/html&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;librewolf.desktop&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x-scheme-handler/http&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;librewolf.desktop&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x-scheme-handler/https&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;librewolf.desktop&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x-scheme-handler/about&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;librewolf.desktop&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x-scheme-handler/unknown&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;librewolf.desktop&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And enable it in your <code>home.nix</code> or equivalent with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># home.nix</span>
</span></span><span style=display:flex><span>custom<span style=color:#f92672>.</span>librewolf<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span></code></pre></div><p>The <code>xdg</code> settings at the end make LibreWolf the defaults for what is listed.</p><p>Thanks to <code>JosefKatic</code> for putting the above STIG settings in NixOS format.</p><p>You can test your browser to see how well you are protected from tracking and
fingerprinting at <a href=https://coveryourtracks.eff.org/>Cover Your Tracks</a>.</p><ul><li><p><a href=https://www.man7.org/linux/man-pages/man5/machine-id.5.html>man page machine-id(5)</a></p></li><li><p>The following example is adapted from
<a href=https://firejail.wordpress.com/all-about-tor/>Firejail All About Tor</a>
section, adapted for NixOS.</p></li></ul><p>Save the following script as <code>cleanup.sh</code>, change <code>Your-User</code> to your username:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh -e
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Your-User&#34;</span>
</span></span><span style=display:flex><span>HOME_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/</span>$USER<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># clear user cache directly as root</span>
</span></span><span style=display:flex><span>sudo -u <span style=color:#e6db74>&#34;</span>$USER<span style=color:#e6db74>&#34;</span> rm -fr <span style=color:#e6db74>&#34;</span>$HOME_DIR<span style=color:#e6db74>/.cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># generate a new machine-id</span>
</span></span><span style=display:flex><span>rm -f /var/lib/machine-id
</span></span><span style=display:flex><span>dbus-uuidgen &gt; /var/lib/machine-id
</span></span><span style=display:flex><span>cp /var/lib/machine-id /etc/machine-id
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>444</span> /etc/machine-id
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>The <code>~/.cache</code> directory is where most programs store runtime information:
webpages you visited, torrent trackers you connected to, and deleted emails.
It&rsquo;s a good idea to remove them at shutdown. &ndash;Firejail all-about-tor</p><p>Check <code>/etc/machine-id</code> & <code>~/.cache</code> before running the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /etc/machine-id
</span></span><span style=display:flex><span><span style=color:#75715e># Output</span>
</span></span><span style=display:flex><span>0b46feb27a20469da0ee62baaeb51c5c
</span></span><span style=display:flex><span>ls ~/.cache
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x cleanup.sh
</span></span><span style=display:flex><span>sudo ./cleanup.sh
</span></span></code></pre></div><p>Recheck your <code>machine-id</code> and <code>~/.cache</code> directories, you should have a newly
generated <code>machine-id</code> and minimal files in the <code>~/.cache</code> directory. The
Firejail example shows a systemd unit that runs the above script at every
shutdown but that may be overkill, I suggest running it occasionally to make it
harder for sites to link your <code>machine-id</code> to you.</p><p>Privacy protection doesn&rsquo;t need to be perfect to make a difference. The best
protection against tracking and fingerprinting available is to use Tor. For your
daily driver, tools like Ghostery, UblockOrigin, Privacy Badger, Disconnect, and
NoScript reduce fingerprinting significantly but not completely. Some privacy
guides will suggest not to use add-ons at all because they make your browser
unique, this isn&rsquo;t one of them. Just use Tor when it truly matters.</p><ul><li><a href=https://ssd.eff.org/module/how-to-use-tor>Surveillance Self-Defense How to: Use Tor</a></li></ul><p>There are more hardening parameters that can be set but this should be a good
starting point for a hardened version of LibreWolf. When testing with Cover your
tracks, customized LibreWolf tested as having stronger tracking protection than
default Mullvad-Browser and NoScript significantly cuts down the data available
for fingerprinting by disabling JavaScript.</p><ul><li>The <a href=https://wiki.garudalinux.org/en/privacy-guide>Garuda Privacy-Guide</a> has
good tips and recommendations for browser add-ons.</li></ul><h3 id=virtual-private-networks-vpns>Virtual Private Networks (VPNs)<a hidden class=anchor aria-hidden=true href=#virtual-private-networks-vpns>#</a></h3><p>A <strong>VPN</strong> (Virtual Private Network) encrypts your Internet connection and routes
your traffic through a VPN provider’s servers, masking your IP address from
local network observers, ISPs, and websites. Using a VPN can prevent your ISP or
local Wi-Fi owner from tracking what sites you visit (they only see a connection
to the VPN), and can help circumvent some regional restrictions or filtering.</p><p>However, VPNs simply shift your trust: Instead of your ISP seeing your activity,
your VPN provider can, so you must trust their privacy policies and
infrastructure. Quality and privacy protections vary widely from one VPN company
to another.</p><p>You can use a VPN with Tor, but it&rsquo;s not recommended unless you&rsquo;re an advanced
user who knows how to configure both in a way that doesn&rsquo;t compromise your
privacy.</p><p><strong>Popular VPNs on NixOS</strong></p><ul><li><p><a href=https://wiki.nixos.org/wiki/Mullvad_VPN>Mullvad VPN</a> Mullvad VPN uses
WireGuard under the hood and only works if <code>systemd-resolvd</code> is enabled.</p></li><li><p><a href=https://wiki.nixos.org/wiki/WireGuard>WireGuard VPN</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/Tailscale>Tailscale</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/OpenVPN>OpenVPN</a></p></li></ul><h3 id=setting-up-tailscale>Setting up Tailscale<a hidden class=anchor aria-hidden=true href=#setting-up-tailscale>#</a></h3><p>I was surprised at how easy this actually was to set up. Either go to
<a href=https://www.tailscale.com>https://www.tailscale.com</a> and/or download the app for either Android or IOS,
sign up with your identity provider, and click <code>Start connecting devices -></code></p><ul><li><a href=https://tailscale.com/kb/1017/install>Tailscale quickstart</a></li></ul><p>To add tailscale to NixOS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># tailscale.nix</span>
</span></span><span style=display:flex><span>{<span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>tailscale<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e># Tell the firewall to implicitly trust packets routed over Tailscale:</span>
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>firewall<span style=color:#f92672>.</span>trustedInterfaces <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;tailscale0&#34;</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Tailscale will automatically use the hostname of your device as the name of the
network. If you want to change it to something else:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tailscale set --hostname<span style=color:#f92672>=</span>&lt;name&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># You can also give your account a nickname</span>
</span></span><span style=display:flex><span>sudo tailscale set --nickname<span style=color:#f92672>=</span>&lt;name&gt;
</span></span></code></pre></div><p>This allows you to refer to your network by <code>name</code> rather than IP address.</p><p>Tailscale uses <a href=https://tailscale.com/kb/1081/magicdns>MagicDNS</a> which is
enabled by default, and they recommend you keep it enabled.</p><p>The docs say that by default, devices in your tailnet prefer their local DNS
settings and only use the tailnet&rsquo;s DNS servers when needed. I had to completely
disable my Androids DNS settings for tailscale to access the internet through
MagicDNS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tailscale set --accept-dns<span style=color:#f92672>=</span>false
</span></span></code></pre></div><p>To connect to tailscale after rebuilding you can run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tailscale up
</span></span></code></pre></div><p>Use <code>nslookup</code> to review and debug DNS responses:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nslookup google.com
</span></span><span style=display:flex><span>Server:         127.0.0.1
</span></span><span style=display:flex><span>Address:        127.0.0.1#53
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Non-authoritative answer:
</span></span><span style=display:flex><span>Name:   google.com
</span></span><span style=display:flex><span>Address: 142.251.40.206
</span></span><span style=display:flex><span>Name:   google.com
</span></span><span style=display:flex><span>Address: 2a00:1450:4001:827::200e
</span></span></code></pre></div><ul><li>The <code>127.0.0.1#53</code> indicate that instead of using the DNS server pushed by
your ISP, router, or Tailscale&rsquo;s MagicDNS, the system is sending all DNS
requests through the loopback device to <code>dnscrypt-proxy</code> in my case.</li></ul><p>Get the status of your connections to other Tailscale devices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tailscale status
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>           <span style=color:#ae81ff>2</span>         <span style=color:#ae81ff>3</span>           <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>100.1.2.3   device-a  apenwarr@   linux     active; direct &lt;ip-port&gt;, tx <span style=color:#ae81ff>1116</span> rx <span style=color:#ae81ff>1124</span>
</span></span><span style=display:flex><span>100.4.5.6   device-b  crawshaw@   macOS     active; relay &lt;relay-server&gt;, tx <span style=color:#ae81ff>1351</span> rx <span style=color:#ae81ff>4262</span>
</span></span><span style=display:flex><span>100.7.8.9   device-c  danderson@  windows   idle; tx <span style=color:#ae81ff>1214</span> rx <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>100.0.1.2   device-d  ross@       iOS       —
</span></span></code></pre></div><ul><li><p><a href=https://tailscale.com/kb/1196/security-hardening>Tailscale Best Practices</a></p></li><li><p><a href=https://tailscale.com/kb/1080/cli>Tailscale CLI</a></p></li><li><p>There is much more you can do with Tailscale, including integrating
Mullvad-VPN and using Exit Nodes.</p></li></ul><h2 id=encrypted-dns>Encrypted DNS<a hidden class=anchor aria-hidden=true href=#encrypted-dns>#</a></h2><p>DNS (Domain Name System) resolution is the process of translating a website&rsquo;s
domain name into its corresponding IP address. By default, this traffic isn&rsquo;t
encrypted, which means anyone on the network, from your ISP to potential
hackers, can see the websites you&rsquo;re trying to visit. <strong>Encrypted DNS</strong> uses
protocols to scramble this information, protecting your queries and responses
from being intercepted and viewed by others.</p><p>There are 3 main types of DNS protection:</p><ul><li><p><strong>DNS over HTTPS (DoH)</strong>: Uses the HTTPS protocol to encrypt data between the
client and the resolver.</p></li><li><p><strong>DNS over TLS (DoT)</strong>: Similar to (DoH), differs in the methods used for
encryption and delivery using a separate port from HTTPS.</p></li><li><p><strong>DNSCrypt</strong>: Uses end-to-end encryption with the added benefit of being able
to prevent DNS spoofing attacks.</p></li></ul><p>Useful resources:</p><ul><li><p><a href=https://wiki.nixos.org/wiki/Encrypted_DNS>NixOS Wiki Encrypted DNS</a></p></li><li><p><a href=https://www.cloudflare.com/learning/dns/what-is-dns/>Domain Name System (DNS)</a></p></li><li><p><a href=https://en.wikipedia.org/wiki/DNS_over_HTTPS>Wikipedia DNS over HTTPS (DoH)</a></p></li><li><p><a href=https://en.wikipedia.org/wiki/DNS_over_TLS>Wikipedia DNS over TLS (DoT)</a></p></li><li><p><a href=https://blog.cloudflare.com/dns-encryption-explained/>Cloudflare Dns Encryption Explained</a></p></li><li><p><a href=https://nordvpn.com/blog/encrypted-dns-traffic/>NordVPN Encrypted Dns Traffic</a></p></li></ul><p>The following sets up dnscrypt-proxy using DoH (DNS over HTTPS) with an oisd
blocklist, they both come directly from the Wiki:</p><p>Add <code>oisd</code> to your flake inputs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    oisd <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://big.oisd.nl/domainswild&#34;</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><blockquote><p>❗ NOTE: The <code>oisd</code> blocklist is a plain text file that updates frequently.
This can cause <code>nh os switch</code> to fail with a <code>NarHash</code> mismatch error. To fix
this, you need to run <code>nix flake update</code> to refresh the blocklist and its hash
in your <code>flake.lock</code> file. After that, you can run your <code>nh</code> command again.</p></blockquote><p>And the import the following into your <code>configuration.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># dnscrypt-proxy.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  blocklist_base <span style=color:#f92672>=</span> builtins<span style=color:#f92672>.</span>readFile inputs<span style=color:#f92672>.</span>oisd;
</span></span><span style=display:flex><span>  extraBlocklist <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;&#39;</span>;
</span></span><span style=display:flex><span>  blocklist_txt <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>writeText <span style=color:#e6db74>&#34;blocklist.txt&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>${</span>extraBlocklist<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>${</span>blocklist_base<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>  hasIPv6Internet <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  StateDirectory <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dnscrypt-proxy&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  networking <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set DNS nameservers to the local host addresses for iPv4 (`127.0.0.1`) &amp; iPv6 (::1)</span>
</span></span><span style=display:flex><span>    nameservers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;127.0.0.1&#34;</span> <span style=color:#e6db74>&#34;::1&#34;</span>];
</span></span><span style=display:flex><span>    <span style=color:#75715e># If using dhcpcd</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># dhcpcd.extraConfig = &#34;nohook resolv.conf&#34;;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If using NetworkManager</span>
</span></span><span style=display:flex><span>    networkmanager<span style=color:#f92672>.</span>dns <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;none&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>resolved<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkForce <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e># See https://wiki.nixos.org/wiki/Encrypted_DNS</span>
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>dnscrypt-proxy2 <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># See https://github.com/DNSCrypt/dnscrypt-proxy/blob/master/dnscrypt-proxy/example-dnscrypt-proxy.toml</span>
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e># See https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md</span>
</span></span><span style=display:flex><span>      sources<span style=color:#f92672>.</span>public-resolvers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        urls <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md&#34;</span>
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>        minisign_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3&#34;</span>;
</span></span><span style=display:flex><span>        cache_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/var/lib/</span><span style=color:#e6db74>${</span>StateDirectory<span style=color:#e6db74>}</span><span style=color:#e6db74>/public-resolvers.md&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Use servers reachable over IPv6 -- Do not enable if you don&#39;t have IPv6 connectivity</span>
</span></span><span style=display:flex><span>      ipv6_servers <span style=color:#f92672>=</span> hasIPv6Internet;
</span></span><span style=display:flex><span>      block_ipv6 <span style=color:#f92672>=</span> <span style=color:#f92672>!</span> hasIPv6Internet;
</span></span><span style=display:flex><span>      blocked_names<span style=color:#f92672>.</span>blocked_names_file <span style=color:#f92672>=</span> blocklist_txt;
</span></span><span style=display:flex><span>      require_dnssec <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#75715e># Logs can get large very quickly...</span>
</span></span><span style=display:flex><span>      require_nolog <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      require_nofilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># If you want, choose a specific set of servers that come from your sources.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Here it&#39;s from https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># If you don&#39;t specify any, dnscrypt-proxy will automatically rank servers</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># that match your criteria and choose the best one.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># server_names = [ ... ];</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  systemd<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>dnscrypt-proxy2<span style=color:#f92672>.</span>serviceConfig<span style=color:#f92672>.</span>StateDirectory <span style=color:#f92672>=</span> StateDirectory;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Above, we have a local DNS proxy that encrypts and forwards queries.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># You should see that dnscrypt-proxy chooses the Server with the lowest initial latency</span>
</span></span><span style=display:flex><span>sudo systemctl status dnscrypt-proxy2
</span></span><span style=display:flex><span><span style=color:#75715e># verify that dnscrypt-proxy is listening</span>
</span></span><span style=display:flex><span>sudo ss -lnp | grep <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Test a DNS query, if you get valid responses it&#39;s working</span>
</span></span><span style=display:flex><span>dig @127.0.0.1 example.com +short
</span></span><span style=display:flex><span><span style=color:#75715e># check the logs</span>
</span></span><span style=display:flex><span>sudo journalctl -u dnscrypt-proxy2
</span></span></code></pre></div><p><code>dnscrypt-proxy2</code> acts as your local DNS resolver listening on your machine
(<code>127.0.0.1</code>) for IPv4 and <code>::1</code> for iPv6.</p><p>The system&rsquo;s DNS settings (<code>networking.nameservers</code>) point to localhost, so
<strong>all DNS queries from the computer</strong> go to dnscrypt-proxy.</p><p><code>inputs.oisd</code> refers to the flake input oisd blocklist, it prevents your device
from connecting to unwanted or harmful domains.</p><p><code>dnscrypt-proxy2</code> then encrypts and forwards our DNS requests to third-party
public DNSCrypt or DoH servers.</p><h2 id=firewalls>Firewalls<a hidden class=anchor aria-hidden=true href=#firewalls>#</a></h2><p>NixOS includes an integrated firewall based on iptables/nftables.</p><p><a href=https://www.cloudflare.com/learning/security/what-is-a-firewall/>Cloudflare What is a Firewall</a></p><p><a href=https://linux-audit.com/networking/nftables/nftables-beginners-guide-to-traffic-filtering/>Beginners guide to nftables</a></p><p><a href=https://wiki.archlinux.org/title/Nftables>Arch Wiki nftables</a></p><p>The following firewall setup is based on the dnscrypt setup above utilizing
nftables.</p><p>This nftables firewall configuration is a strong recommended practice for
enforcing encrypted DNS on your system by restricting all outbound DNS traffic
to a local dnscrypt-proxy process. It greatly reduces DNS leak risks and
enforces privacy by limiting DNS queries to trusted, encrypted upstream
servers.(This was edited on 08-08-25) replace <code>&lt;DNSCRYPT-UID></code> with the UID
given from the command <code>ps -o uid,user,pid,cmd -C dnscrypt-proxy</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>nftables <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ruleset <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      table inet filter {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        chain output {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          type filter hook output priority 0; policy accept;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          # Allow localhost DNS for dnscrypt-proxy2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          ip daddr 127.0.0.1 udp dport 53 accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          ip6 daddr ::1 udp dport 53 accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          ip daddr 127.0.0.1 tcp dport 53 accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          ip6 daddr ::1 tcp dport 53 accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          # Allow dnscrypt-proxy2 to talk to upstream servers
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          # Replace &lt;DNSCRYPT-UID&gt; with:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          # ps -o uid,user,pid,cmd -C dnscrypt-proxy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          meta skuid &lt;DNSCRYPT-UID&gt; udp dport { 443, 853 } accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          meta skuid &lt;DNSCRYPT-UID&gt; tcp dport { 443, 853 } accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          # Block all other outbound DNS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          udp dport { 53, 853 } drop
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          tcp dport { 53, 853 } drop
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>firewall <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    allowedTCPPorts <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e># Ports open for inbound connections.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Limit these to reduce the attack surface.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>22</span> <span style=color:#75715e># SSH – Keep open only if you need remote access.</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e># To change the SSH port in NixOS:</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e># services.openssh.ports = [ 2222 ];</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e># Update this list to match the new port.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># 53  # DNS – Only if running a public DNS server.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># 80  # HTTP – Only if hosting a website.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># 443 # HTTPS – Only if hosting a secure website.</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    allowedUDPPorts <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e># Ports open for inbound UDP traffic.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Most NixOS workstations won&#39;t need any here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># 53 # DNS – Only if running a public DNS server.</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>❗ TIP: Reduce SSH noise by changing the default port On most systems, SSH
listens on TCP port 22 — which means automated bots and scanners will hit it
constantly. While this doesn’t replace real security measures, moving SSH to a
different port drastically cuts down on drive-by brute-force attempts you’ll
see in your logs.</p><p>In NixOS, change both the SSH daemon port and your firewall rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span> <span style=color:#75715e># Example: Move SSH to port 2222</span>
</span></span><span style=display:flex><span> networking<span style=color:#f92672>.</span>firewall<span style=color:#f92672>.</span>allowedTCPPorts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>2222</span> ];
</span></span><span style=display:flex><span> services<span style=color:#f92672>.</span>openssh<span style=color:#f92672>.</span>ports <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>2222</span> ];
</span></span></code></pre></div><ul><li>After rebuilding, test from another terminal/session before closing your
existing one:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -p <span style=color:#ae81ff>2222</span> user@host
</span></span></code></pre></div></blockquote><p><code>nft</code> is a cli tool used to set up, maintain and inspect packet filtering and
classification rules in the Linux kernel, in the nftables framework. The Linux
kernel subsystem is known as nftables, and &rsquo;nf&rsquo; stands for Netfilter.&ndash;<code>man nft</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft list ruleset
</span></span></code></pre></div><ul><li>Since we declare our firewall, we&rsquo;ll only use <code>nft</code> to inspect our ruleset.</li></ul><h2 id=nixos-firewall-vs-nftables-ruleset>NixOS Firewall vs <code>nftables</code> Ruleset<a hidden class=anchor aria-hidden=true href=#nixos-firewall-vs-nftables-ruleset>#</a></h2><p><code>networking.nftables</code>: This section provides a raw <code>nftables</code> ruleset that gives
you granular, low-level control. The rules here are more specific and are meant
to handle the intricate logic of the DNS proxy setup. They will be applied
directly to the kernel&rsquo;s <code>nftables</code> subsystem and prevent DNS leaks.</p><p><code>networking.firewall</code>: This is a higher-level, simpler NixOS option that uses
<code>iptables</code> rules to open ports for inbound traffic. The rules defined here
(allowing port 22) is for incoming SSH connections to the machine, not for
outbound traffic, so they do not interfere with the <code>nftables</code> rules that filter
the outgoing traffic. (Make sure to comment out or remove this if you don&rsquo;t SSH
into your machine).</p><p>The firewall ensures only authorized, local encrypted DNS proxy process can
speak DNS with the outside world, and that all other DNS requests from any other
process are blocked unless they&rsquo;re to <code>127.0.0.1</code> (our local proxy). This is a
robust policy against both DNS leaks and local compromise.</p><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>Review listening ports: After each rebuild, use <code>ss -tlpn</code>, <code>nmap</code> or <code>netstat</code>
to see which services are accepting connections. Close or firewall anything
unnecessary.</p><p>You can also test firewall DNS restrictions using <code>dig</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig @127.0.0.1 example.com  <span style=color:#75715e># Should work</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dig @8.8.8.8 example.com    <span style=color:#75715e># Should fail/time out for normal users</span>
</span></span></code></pre></div><ul><li>This test is actually what alerted me of an improper configuration in the
above firewalls nftables rules allowing me to fix it. Initially the second
<code>dig</code> command gave results letting me know that the restrictions weren&rsquo;t being
applied correctly.</li></ul><p>Since we defined an <code>output</code> chain inside <code>table inet filter</code> with the line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>type filter hook output priority 0; policy accept;
</span></span></code></pre></div><p>This attaches the chain to the kernel’s OUTPUT hook, so all locally generated
packets, including DNS queries are filtered by this chain.</p><p>Within this chain, the rules:</p><ul><li><p>Explicitly allow DNS queries to localhost addresses (<code>127.0.0.1</code> and <code>::1</code>).</p></li><li><p>Allow the <code>dnscrypt-proxy</code> process (running with UID <code>62396</code>) to send DNS
queries on ports 443 and 853 (for DNS-over-HTTPS and DNS-over-TLS).</p></li><li><p>Drop all other outbound DNS traffic on ports <code>53</code> and <code>853</code>.</p></li></ul><p>Because of this setup, dig queries to your local resolver at <code>127.0.0.1</code> pass,
but queries directly to public DNS servers like <code>8.8.8.8</code> are blocked for
users/processes other than the allowed DNS proxy.</p><h2 id=opensnitch>OpenSnitch<a hidden class=anchor aria-hidden=true href=#opensnitch>#</a></h2><ul><li><a href=https://wiki.nixos.org/wiki/OpenSnitch>NixOS Wiki OpenSnitch</a></li></ul><p><a href=https://github.com/evilsocket/opensnitch>Opensnitch</a> is an open-source
application firewall that focuses on monitoring and controlling outgoing network
connections on a per-application basis.</p><p>This can be used to block apps from accessing the internet that shouldn&rsquo;t need
to (i.e., block telemetry and more). Opensnitch will report that the app has
attempted to make an outbound internet connection and block it or allow it based
on the rules you set.</p><h3 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h3><ul><li><p><a href=https://cloudflare.com/learning/ssl/what-is-https>Cloudflare What is HTTPS</a></p></li><li><p><a href=https://ssd.eff.org/module/what-fingerprinting>What is Fingerprinting</a>, more
than you realize is being tracked constantly.</p></li><li><p><a href=https://ssd.eff.org/>Surveillance Self-Defence</a> has a lot of helpful info to
protect your privacy.</p></li><li><p><a href=https://oisd.nl/>oisd.nl</a> the oisd website</p></li><li><p>For potentially dangerous file types like PDFs, office documents, or images,
especially those downloaded from untrusted sources such as torrents, consider
converting them to a safe PDF format with
<a href=https://github.com/freedomofpress/dangerzone>dangerzone</a>. Dangerzone not
only removes metadata but also applies robust sanitization to neutralize
malicious content.</p></li><li><p><a href=https://wiki.nixos.org/wiki/Librewolf>NixOS Wiki LibreWolf</a>, the options in
the wiki make it less secure and aren&rsquo;t recommended settings to use. They
explicitly disable several of LibreWolf&rsquo;s default privacy-enhancing features,
such as fingerprinting resistance and clearing session data on shutdown.</p></li><li><p><a href=https://librewolf.net/docs/features/>LibreWolf Features</a> You still need to
enable DNS over HTTPS through privacy settings.</p></li><li><p><a href=https://wiki.nixos.org/wiki/SearXNG>SearXNG on NixOS</a></p><ul><li><a href=https://docs.searxng.org/>Welcome to SearXNG</a></li></ul></li><li><p><a href=https://brainfucksec.github.io/firefox-hardening-guide>Firefox Hardening Guide</a></p></li><li><p><a href=https://simeononsecurity.com/guides/enhance-firefox-security-configuring-guide/>STIG Firefox Hardening</a></p></li><li><p><a href=https://stigviewer.com/stigs/mozilla_firefox>Mozilla Firefox Security Technical Implementation Guide</a>
The STIG for Mozilla Firefox (Security Technical Implementation Guide) is a
set of security configuration standards developed by the U.S. Department of
Defense. They are created by the Defense Information Systems Agency (DISA) to
secure and harden DoD information systems and software.</p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>