<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Encrypted_disko_install | NixOS Blog</title><link rel=icon href=favicon.svg sizes=any type=image/svg+xml><meta property="og:url" content="https://TSawyer87.github.io/posts/encrypted_disko_install/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Encrypted_disko_install"><meta property="og:description" content="Encrypted Manual Setup This guide walks you through a manual, encrypted NixOS installation using Disko for disk management and Btrfs for subvolumes. It is designed for users who want full disk encryption and a modern filesystem layout. If you prefer an unencrypted setup, you can skip the LUKS and encryption steps, but this guide focuses on security and flexibility.
If you choose to set up impermanence, ensure it matches your install. Encrypted Setup with Encrypted Impermanence and Unencrypted Setup with Unencrypted Impermanence."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-26T14:35:24-04:00"><meta property="article:modified_time" content="2025-06-26T14:35:24-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Encrypted_disko_install"><meta name=twitter:description content="Encrypted Manual Setup This guide walks you through a manual, encrypted NixOS installation using Disko for disk management and Btrfs for subvolumes. It is designed for users who want full disk encryption and a modern filesystem layout. If you prefer an unencrypted setup, you can skip the LUKS and encryption steps, but this guide focuses on security and flexibility.
If you choose to set up impermanence, ensure it matches your install. Encrypted Setup with Encrypted Impermanence and Unencrypted Setup with Unencrypted Impermanence."><link rel=stylesheet href=/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H+ZeT/jBpieRZ8=" crossorigin=anonymous><link rel=stylesheet href=/css/bundle.min.ffb26980ae2df7bdfe47815d8a3f0130f36070ee4a3320a5f22d16842be2537f.css integrity="sha256-/7JpgK4t973+R4Fdij8BMPNgcO5KMyCl8i0WhCviU38=" crossorigin=anonymous><script src=/js/bundle.995e4ec99401021e081ec256bee66154ef7f4e5136809432513b2e6d014b4b1d.js integrity="sha256-mV5OyZQBAh4IHsJWvuZhVO9/TlE2gJQyUTsubQFLSx0=" crossorigin=anonymous></script><script defer src=/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js integrity="sha256-ZFlLEl97eL30+oMWlVkiu+uxzWuu8/FmVL/KIDCfGPg="></script><script defer src=/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js integrity="sha256-HZgPhN8R8+t8jF8X9UHUmgYRYI3xed10+n8GIl61as4="></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://TSawyer87.github.io/ style=color:inherit>NixOS Blog</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
<svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://TSawyer87.github.io/><span itemprop=name>Home</span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://TSawyer87.github.io/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>Encrypted_disko_install</h1><time class=dim datetime=2025-06-26T14:35:24-04:00>June 26, 2025</time></div><section class=page-section><h1 id=encrypted-manual-setup>Encrypted Manual Setup</h1><p>This guide walks you through a manual, encrypted NixOS installation using Disko
for disk management and Btrfs for subvolumes. It is designed for users who want
full disk encryption and a modern filesystem layout. If you prefer an
unencrypted setup, you can skip the LUKS and encryption steps, but this guide
focuses on security and flexibility.</p><p>If you choose to set up impermanence, ensure it matches your install. Encrypted
Setup with Encrypted Impermanence and Unencrypted Setup with Unencrypted
Impermanence.</p><ol><li><p>Get the
<a href=https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso>Nixos Minimal ISO</a>
Get it on a usb stick, I use Ventoy with Ventoy2Disk.sh. The following is the
link to the
<a href=https://sourceforge.net/projects/ventoy/files/v1.1.05/ventoy-1.1.05-linux.tar.gz/download>Ventoy TarBall</a>
download, untar it with <code>tar -xzf ventoy-1.1.05-linux.tar.gz</code>, and make it
executable with <code>chmod +x Ventoy2Disk.sh</code>, and finally execute it with
<code>sudo bash Ventoy2Disk.sh</code> Follow the prompts to finish the install.</p></li><li><p>Configuring Networking</p></li></ol><p>The minimal installer uses <code>wpa_supplicant</code> instead of NetworkManager. Choose
one of the following methods to enable networking:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start wpa_supplicant
</span></span><span style=display:flex><span>wpa_cli
</span></span></code></pre></div><h3 id=option-a-interactive-wpa_cli>Option A: Interactive <code>wpa_cli</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; add_network
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; set_network <span style=color:#ae81ff>0</span> ssid <span style=color:#e6db74>&#34;myhomenetwork&#34;</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; set_network <span style=color:#ae81ff>0</span> psk <span style=color:#e6db74>&#34;mypassword&#34;</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; enable_network <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>OK
</span></span></code></pre></div><p>To exit type <code>quit</code>, then check your connection with <code>ping google.com</code>.</p><h3 id=option-b-non-interactive-wpa_passphrase>Option B: Non-Interactive <code>wpa_passphrase</code></h3><p>This method is quicker for known networks and persists the configuration for the
live environment.</p><p>First, identify your wireless interface name (e.g., <code>wlan0</code>) using <code>ip a</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start wpa_supplicant <span style=color:#75715e># Ensure wpa_supplicant is running</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This command generates the config and appends it to a file specific to wlan0</span>
</span></span><span style=display:flex><span>sudo wpa_passphrase <span style=color:#e6db74>&#34;myhomenetwork&#34;</span> <span style=color:#e6db74>&#34;mypassword&#34;</span> | sudo tee /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
</span></span><span style=display:flex><span>sudo systemctl restart wpa_supplicant@wlan0.service
</span></span></code></pre></div><p>After either method, exit <code>wpa_cli</code> with <code>quit</code>. Then test your connection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ping google.com
</span></span></code></pre></div><ol start=3><li>Get your Disk Name with <code>lsblk</code></li></ol><p>The output should be something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
</span></span><span style=display:flex><span>nvme0n1     259:0    <span style=color:#ae81ff>0</span>   1,8T  <span style=color:#ae81ff>0</span> disk
</span></span></code></pre></div><ol start=4><li>Copy the disk configuration to your machine. You can choose one from the
<a href=https://github.com/nix-community/disko/tree/master/example>examples directory</a>.</li></ol><ul><li>There is still a starter repo that can save you some typing, make sure to
carefully review if you decide to use it:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export NIX_CONFIG<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;experimental-features = nix-command flakes&#39;</span>
</span></span><span style=display:flex><span>export EDITOR<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hx&#39;</span> <span style=color:#75715e># or &#39;vi&#39;</span>
</span></span><span style=display:flex><span>nix-shell -p git yazi helix mkpasswd
</span></span><span style=display:flex><span>git config --global user.name <span style=color:#e6db74>&#34;gitUsername&#34;</span>
</span></span><span style=display:flex><span>git config --global user.email <span style=color:#e6db74>&#34;gitEmail&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># starter repo containing disk-config set up for impermanence</span>
</span></span><span style=display:flex><span>git clone https://github.com/saylesss88/my-flake.git
</span></span></code></pre></div><ul><li><p>I prefer <code>helix</code> here as it&rsquo;s defaults are great. (i.e., auto closing brackets
and much more)</p></li><li><p>I&rsquo;ve moved away from trying to configure <code>sops</code> pre install, it adds
unnecessary complexity to a minimal install in my opinion.</p></li><li><p>If you click on the layout you want then click the <code>Raw</code> button near the top,
then copy the url and use it in the following command:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /tmp
</span></span><span style=display:flex><span>curl https://raw.githubusercontent.com/nix-community/disko/refs/heads/master/example/luks-btrfs-subvolumes.nix -o /tmp/disk-config.nix
</span></span></code></pre></div><ul><li>The above curl command is to the <code>luks-btrfs-subvolumes.nix</code> layout.</li></ul><ol start=5><li>Make Necessary changes, I prepared mine for impermanence with the following:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>hx /tmp/disk-config.nix
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  disko<span style=color:#f92672>.</span>devices <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    disk <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      nvme0n1 <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;disk&#34;</span>;
</span></span><span style=display:flex><span>        device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/dev/nvme0n1&#34;</span>;
</span></span><span style=display:flex><span>        content <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gpt&#34;</span>;
</span></span><span style=display:flex><span>          partitions <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            ESP <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>              label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;boot&#34;</span>;
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ESP&#34;</span>;
</span></span><span style=display:flex><span>              size <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;512M&#34;</span>;
</span></span><span style=display:flex><span>              type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;EF00&#34;</span>;
</span></span><span style=display:flex><span>              content <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;filesystem&#34;</span>;
</span></span><span style=display:flex><span>                format <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vfat&#34;</span>;
</span></span><span style=display:flex><span>                mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/boot&#34;</span>;
</span></span><span style=display:flex><span>                mountOptions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                  <span style=color:#e6db74>&#34;defaults&#34;</span>
</span></span><span style=display:flex><span>                ];
</span></span><span style=display:flex><span>              };
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            luks <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>              size <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;100%&#34;</span>;
</span></span><span style=display:flex><span>              label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;luks&#34;</span>;
</span></span><span style=display:flex><span>              content <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;luks&#34;</span>;
</span></span><span style=display:flex><span>                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cryptroot&#34;</span>;
</span></span><span style=display:flex><span>                content <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                  type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;btrfs&#34;</span>;
</span></span><span style=display:flex><span>                  extraArgs <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;-L&#34;</span> <span style=color:#e6db74>&#34;nixos&#34;</span> <span style=color:#e6db74>&#34;-f&#34;</span>];
</span></span><span style=display:flex><span>                  subvolumes <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/root&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=root&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/root-blank&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=root-blank&#34;</span> <span style=color:#e6db74>&#34;nodatacow&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/home&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/home&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=home&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/nix&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/nix&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=nix&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/persist&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/persist&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=persist&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/log&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/var/log&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=log&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;/lib&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                      mountpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/var/lib&#34;</span>;
</span></span><span style=display:flex><span>                      mountOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;subvol=lib&#34;</span> <span style=color:#e6db74>&#34;compress=zstd&#34;</span> <span style=color:#e6db74>&#34;noatime&#34;</span>];
</span></span><span style=display:flex><span>                    };
</span></span><span style=display:flex><span>                  };
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>              };
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/persist&#34;</span><span style=color:#f92672>.</span>neededForBoot <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/var/log&#34;</span><span style=color:#f92672>.</span>neededForBoot <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/var/lib&#34;</span><span style=color:#f92672>.</span>neededForBoot <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=create-a-blank-snapshot-of-root>Create a Blank Snapshot of /root</h2><p>This will give us more options when it comes to impermanence. (i.e. being able
to rollback to a fresh snapshot of root on reboot)</p><p>To access all of the subvolumes, we have to mount the Btrfs partitions
top-level.</p><ol><li>Unlock the LUKS device:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cryptsetup open /dev/disk/by-partlabel/luks cryptroot
</span></span></code></pre></div><ol start=2><li>Mount the Btrfs top-level (subvolid=5):</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mount -o subvolid<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> /dev/mapper/cryptroot /mnt
</span></span></code></pre></div><ol start=3><li>List the contents:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls /mnt
</span></span><span style=display:flex><span><span style=color:#75715e># you should see something like</span>
</span></span><span style=display:flex><span>root   home  nix  persist  log  lib  ...
</span></span></code></pre></div><ol start=4><li>Now we can take a snapshot of the <code>root</code> subvolume:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo btrfs subvolume snapshot -r /mnt/root /mnt/root-blank
</span></span></code></pre></div><ol start=5><li>Make sure to unmount:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo umount /mnt
</span></span></code></pre></div><h2 id=lets-copy-all-of-our-files-to-a-persistent-location>Lets copy all of our files to a persistent location</h2><p>The following is a one time operation, we&rsquo;re just getting it out of the way now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /persist/etc
</span></span><span style=display:flex><span>sudo mkdir -p /persist/var/lib
</span></span><span style=display:flex><span>sudo mkdir -p /persist/var/log
</span></span><span style=display:flex><span>sudo mkdir -p /persist/home
</span></span><span style=display:flex><span>sudo mkdir -p /persist/root
</span></span><span style=display:flex><span>sudo cp -a /etc/. /persist/etc/
</span></span><span style=display:flex><span>sudo cp -a /var/lib/. /persist/var/lib
</span></span><span style=display:flex><span>sudo cp -a /var/log/. /persist/var/log
</span></span><span style=display:flex><span>sudo cp -a /home/. /persist/home/
</span></span><span style=display:flex><span>sudo cp -a /root/. /persist/root/
</span></span></code></pre></div><h2 id=setting-up-zram-and-tmp-on-ram>Setting up zram and /tmp on RAM</h2><p>While <code>/tmp</code> is handled by <code>tmpfs</code> (as shown the below <code>configuration.nix</code>), you
can further enhance memory efficiency with <code>zram</code> for compressed swap, as shown
below.</p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>zram;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>zram <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkEnableOption <span style=color:#e6db74>&#34;Enable utils module&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkIf cfg<span style=color:#f92672>.</span>enable {
</span></span><span style=display:flex><span>    zramSwap <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#75715e># one of &#34;lzo&#34;, &#34;lz4&#34;, &#34;zstd&#34;</span>
</span></span><span style=display:flex><span>      algorithm <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zstd&#34;</span>;
</span></span><span style=display:flex><span>       priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>       memoryPercent <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And in your <code>configuration.nix</code> you would add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>custom <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    zram<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></blockquote><p>After adding the above module and rebuilding, you can see it with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>swapon --show
</span></span><span style=display:flex><span>NAME       TYPE      SIZE USED PRIO
</span></span><span style=display:flex><span>/dev/zram0 partition 7.5G   0B    <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><ol start=6><li>Run disko to partition, format and mount your disks. <strong>Warning</strong> this will
wipe <strong>EVERYTHING</strong> on your disk. Disko doesn&rsquo;t work with dual boot.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nix --experimental-features <span style=color:#e6db74>&#34;nix-command flakes&#34;</span> run github:nix-community/disko/latest -- --mode destroy,format,mount /tmp/disk-config.nix
</span></span></code></pre></div><p>Check it with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mount | grep /mnt
</span></span></code></pre></div><p>The output for an <code>nvme0n1</code> disk would be similar to the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#... snip ...</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>285,subvol<span style=color:#f92672>=</span>/root<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/persist type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>261,subvol<span style=color:#f92672>=</span>/persist<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/etc type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>261,subvol<span style=color:#f92672>=</span>/persist<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/nix type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>260,subvol<span style=color:#f92672>=</span>/nix<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/var/lib type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>258,subvol<span style=color:#f92672>=</span>/lib<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/var/log type btrfs <span style=color:#f92672>(</span>rw,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>259,subvol<span style=color:#f92672>=</span>/log<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/dev/nvme0n1p2 on /mnt/nix/store type btrfs <span style=color:#f92672>(</span>ro,noatime,compress<span style=color:#f92672>=</span>zstd:3,ssd,discard<span style=color:#f92672>=</span>async,space_cache<span style=color:#f92672>=</span>v2,subvolid<span style=color:#f92672>=</span>260,subvol<span style=color:#f92672>=</span>/nix<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span></code></pre></div><ol start=7><li>Generate necessary files, here we use <code>--no-filesystems</code> because disko
handles the <code>fileSystems</code> attribute for us.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nixos-generate-config --no-filesystems --root /mnt
</span></span></code></pre></div><ul><li>The above command will place a <code>configuration.nix</code> and
<code>hardware-configuration.nix</code> in <code>/mnt/etc/nixos/</code></li></ul><p>It may be helpful to add a couple things to your <code>configuration.nix</code> now, while
it&rsquo;s in it&rsquo;s default location. You can just add what you want and rebuild once
with <code>sudo nixos-rebuild switch</code> and move on. (i.e. <code>git</code>, an editor, etc.).</p><h3 id=setting-a-flake-for-your-minimal-install>Setting a Flake for your minimal Install</h3><ol start=8><li>Create the flake in your home directory to avoid needing to use sudo for
every command:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd   <span style=color:#75715e># Move to home directory</span>
</span></span><span style=display:flex><span>mkdir flake
</span></span><span style=display:flex><span>cd /mnt/etc/nixos/
</span></span><span style=display:flex><span>sudo mv hardware-configuration.nix configuration.nix ~/flake/
</span></span><span style=display:flex><span>sudo mv /tmp/disk-config.nix ~/flake/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd flake
</span></span><span style=display:flex><span>hx flake.nix
</span></span></code></pre></div><blockquote><p>You&rsquo;ll change <code>hostName = nixpkgs.lib.nixosSystem</code> to your chosen hostname,
(e.g. <code>magic = nixpkgs.lib.nixosSystem</code>). This will be the same as your
<code>networking.hostName = "magic";</code> in your <code>configuration.nix</code> that we will set
up shortly.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NixOS configuration&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span>;
</span></span><span style=display:flex><span>    disko<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nix-community/disko/latest&#34;</span>;
</span></span><span style=display:flex><span>    disko<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># impermanence.url = &#34;github:nix-community/impermanence&#34;;</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> inputs<span style=color:#f92672>@</span>{ nixpkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e># Change `hostName` to your chosen host name</span>
</span></span><span style=display:flex><span>      nixos <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>./configuration.nix</span>
</span></span><span style=display:flex><span>          inputs<span style=color:#f92672>.</span>disko<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>disko
</span></span><span style=display:flex><span>          <span style=color:#75715e># inputs.impermanence.nixosModules.impermanence</span>
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=9><li>Edit <code>configuration.nix</code> with what is required, the following are required, I
clone my original flake repo and move the pieces into place but it&rsquo;s fairly
easy to just type it all out:</li></ol><ul><li><p>Bootloader, (e.g., <code>boot.loader.systemd-boot.enable = true;</code>)</p></li><li><p>User, the example uses <code>username</code> change this to your chosen username. If you
don&rsquo;t set your hostname it will be <code>nixos</code>.</p></li><li><p>Networking, <code>networking.networkmanager.enable = true;</code></p></li><li><p><code>hardware-configuration.nix</code> & <code>disk-config.nix</code> for this setup</p></li><li><p>If you type this out by hand and mess up a single character, you will have to
start over completely. A fairly safe way to do this is with <code>vim</code> or <code>hx</code> and
redirect the hashed pass to a <code>/tmp/pass.txt</code>, you can then read it into your
<code>users.nix</code>:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkpasswd -m SHA-512 -s &gt; /tmp/pass.txt
</span></span><span style=display:flex><span><span style=color:#75715e># Enter your chosen password</span>
</span></span></code></pre></div><p>And then when inside <code>configuration.nix</code>, move to the line where you want the
hashed password and type <code>:r /tmp/pass.txt</code> to read the hash into your current
file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: {
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#75715e># Include the results of the hardware scan.</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./hardware-configuration.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./disk-config.nix</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># initrd encrypted disk setup</span>
</span></span><span style=display:flex><span>    boot<span style=color:#f92672>.</span>initrd<span style=color:#f92672>.</span>luks<span style=color:#f92672>.</span>devices <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    cryptroot <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/dev/disk/by-partlabel/luks&#34;</span>;
</span></span><span style=display:flex><span>      allowDiscards <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      preLVM <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Enable autoScrub for btrfs</span>
</span></span><span style=display:flex><span>    services<span style=color:#f92672>.</span>btrfs<span style=color:#f92672>.</span>autoScrub <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;weekly&#34;</span>;
</span></span><span style=display:flex><span>    fileSystems <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;/&#34;</span>];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># This complements using zram, putting /tmp on RAM</span>
</span></span><span style=display:flex><span>  boot <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    tmp <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      useTmpfs <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      tmpfsSize <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;50%&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Change me!</span>
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>hostName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixos&#34;</span>; <span style=color:#75715e># This will match the `hostname` of your flake</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>networkmanager<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>systemd-boot<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># (for UEFI systems only)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># List packages installed in system profile.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># You can use https://search.nixos.org/ to find more packages (and options).</span>
</span></span><span style=display:flex><span>  environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>    vim <span style=color:#75715e># Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#   wget</span>
</span></span><span style=display:flex><span>    git
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  time<span style=color:#f92672>.</span>timeZone <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;America/New_York&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Change me to your chosen username (i.e. change nixosUser to your username)</span>
</span></span><span style=display:flex><span>  users<span style=color:#f92672>.</span>users<span style=color:#f92672>.</span>nixosUser <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    isNormalUser <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    extraGroups <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;wheel&#34;</span> <span style=color:#e6db74>&#34;networkmanager&#34;</span> ]; <span style=color:#75715e># Add &#34;wheel&#34; for sudo access</span>
</span></span><span style=display:flex><span>    initialHashedPassword <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;READ_MKPASSWD_OUTPUT_HERE&#34;</span>; <span style=color:#75715e># &lt;-- This is where it goes!</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># home = &#34;/home/nixos&#34;; # Optional: Disko typically handles home subvolumes</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  console<span style=color:#f92672>.</span>keyMap <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nixpkgs<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;25.05&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Although, just adding the <code>disk-config.nix</code> works for prompting you for your
encryption passphrase adding the following is a more robust way of ensuring Nix
is aware of this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>    boot<span style=color:#f92672>.</span>initrd<span style=color:#f92672>.</span>luks<span style=color:#f92672>.</span>devices <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    cryptroot <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/dev/disk/by-partlabel/luks&#34;</span>;
</span></span><span style=display:flex><span>      allowDiscards <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      preLVM <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><ol start=10><li>Move the flake to <code>/mnt/etc/nixos</code> and run <code>nixos-install</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mv ~/flake /mnt/etc/nixos/
</span></span></code></pre></div><ul><li>Give everything a quick once over, insuring your host is set in both your
<code>flake.nix</code>, and <code>configuration.nix</code>. Ensure you changed the username in the
<code>configuration.nix</code> from <code>nixos</code> to your chosen name, this is the name you&rsquo;ll
use to login after you enter your encryption passphrase.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nixos-install --flake /mnt/etc/nixos/flake#hostname
</span></span></code></pre></div><ul><li><p>You will be prompted to enter a new password if everything succeeds.</p></li><li><p>If everything checks out, reboot the system and you should be prompted to
enter your <code>user</code> and <code>password</code> to login to a shell to get started.</p></li><li><p>The flake will be placed at <code>/etc/nixos/flake</code> after the install and reboot, I
choose to move it to my home directory. Since the file was first in <code>/etc</code>
you&rsquo;ll need to adjust the permissions with something like
<code>sudo chown -R $USER:users ~/flake</code> and then you can work on it without
privilege escalation.</p></li><li><p>You can check the layout of your btrfs system with:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo btrfs subvolume list /
</span></span></code></pre></div><ul><li><p><a href=https://btrfs.readthedocs.io/en/latest/Subvolumes.html>BTRFS Subvolumes</a></p></li><li><p>To set up impermanence for this specific layout, follow the link
<a href=https://saylesss88.github.io/nix/encrypted_impermanence.html>Encrypted Impermanence</a></p></li></ul></section></main><footer id=main-footer><div class=footer><a href=#>Scroll to Top</a><div class=footer-copyright><div class=dim>© 2025</div><div>Made with ❤️ and powered by <a href=https://github.com/math-queiroz/rusty-typewriter target=_blank>Rusty Typewriter</a> theme for <a href=https://gohugo.io/ target=_blank>Hugo</a></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>1877 words</span>
<span>14 - 18 minutes read</span></div><h3>Table Of Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#option-a-interactive-wpa_cli>Option A: Interactive <code>wpa_cli</code></a></li><li><a href=#option-b-non-interactive-wpa_passphrase>Option B: Non-Interactive <code>wpa_passphrase</code></a></li></ul></li><li><a href=#create-a-blank-snapshot-of-root>Create a Blank Snapshot of /root</a></li><li><a href=#lets-copy-all-of-our-files-to-a-persistent-location>Lets copy all of our files to a persistent location</a></li><li><a href=#setting-up-zram-and-tmp-on-ram>Setting up zram and /tmp on RAM</a><ul><li><a href=#setting-a-flake-for-your-minimal-install>Setting a Flake for your minimal Install</a></li></ul></li></ul></nav></aside></div></div></body></html>