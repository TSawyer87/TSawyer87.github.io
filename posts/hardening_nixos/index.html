<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hardening_NixOS | NixOS Blog</title><meta name=keywords content><meta name=description content="Hardening NixOS

     


Securing your NixOS system begins with a philosophy of minimalism, explicit
configuration, and proactive control.

⚠️ Warning: I am not a security expert. This guide presents various options
for hardening NixOS, but it is your responsibility to evaluate whether each
adjustment suits your specific needs and environment. Security hardening and
process isolation can introduce stability challenges, compatibility issues, or
unexpected behavior. Additionally, these protections often come with
performance tradeoffs. Always conduct thorough research, there are no plug and
play one size fits all security solutions."><meta name=author content><link rel=canonical href=https://tsawyer87.github.io/posts/hardening_nixos/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/hardening_nixos/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/hardening_nixos/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Hardening_NixOS"><meta property="og:description" content="Hardening NixOS Securing your NixOS system begins with a philosophy of minimalism, explicit configuration, and proactive control.
⚠️ Warning: I am not a security expert. This guide presents various options for hardening NixOS, but it is your responsibility to evaluate whether each adjustment suits your specific needs and environment. Security hardening and process isolation can introduce stability challenges, compatibility issues, or unexpected behavior. Additionally, these protections often come with performance tradeoffs. Always conduct thorough research, there are no plug and play one size fits all security solutions."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-10T08:37:54-04:00"><meta property="article:modified_time" content="2025-08-10T08:37:54-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hardening_NixOS"><meta name=twitter:description content="Hardening NixOS

     


Securing your NixOS system begins with a philosophy of minimalism, explicit
configuration, and proactive control.

⚠️ Warning: I am not a security expert. This guide presents various options
for hardening NixOS, but it is your responsibility to evaluate whether each
adjustment suits your specific needs and environment. Security hardening and
process isolation can introduce stability challenges, compatibility issues, or
unexpected behavior. Additionally, these protections often come with
performance tradeoffs. Always conduct thorough research, there are no plug and
play one size fits all security solutions."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Hardening_NixOS","item":"https://tsawyer87.github.io/posts/hardening_nixos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hardening_NixOS","name":"Hardening_NixOS","description":"Hardening NixOS Securing your NixOS system begins with a philosophy of minimalism, explicit configuration, and proactive control.\n⚠️ Warning: I am not a security expert. This guide presents various options for hardening NixOS, but it is your responsibility to evaluate whether each adjustment suits your specific needs and environment. Security hardening and process isolation can introduce stability challenges, compatibility issues, or unexpected behavior. Additionally, these protections often come with performance tradeoffs. Always conduct thorough research, there are no plug and play one size fits all security solutions.\n","keywords":[],"articleBody":"Hardening NixOS Securing your NixOS system begins with a philosophy of minimalism, explicit configuration, and proactive control.\n⚠️ Warning: I am not a security expert. This guide presents various options for hardening NixOS, but it is your responsibility to evaluate whether each adjustment suits your specific needs and environment. Security hardening and process isolation can introduce stability challenges, compatibility issues, or unexpected behavior. Additionally, these protections often come with performance tradeoffs. Always conduct thorough research, there are no plug and play one size fits all security solutions.\nThat said, I typically write about what I’m implementing myself to deepen understanding and share what works for me. --Source means the proceeding paragraph came from --Source, you can often click to check for yourself. If you use some common sense with a bit of caution you could end up with a more secure NixOS system that fits your needs.\nMuch of this guide draws inspiration or recommendations from the well-known Linux Hardening Guide by Madaidan’s Insecurities. Madaidan’s work is widely regarded in technical and security circles as one of the most comprehensive and rigorously researched sources on practical Linux security, frequently cited for its depth and actionable advice. For example, much of the original basis for hardening for nix-mineral came from this guide as well.\n❗ Note on SELinux and AppArmor: While NixOS can provide a high degree of security through its immutable and declarative nature, it’s important to understand the limitations regarding Mandatory Access Control (MAC) frameworks. Neither SELinux nor AppArmor are fully supported or widely used in the NixOS ecosystem. You can do a lot to secure NixOS but if anonymity and isolation are paramount, I recommend booting into a Tails USB stick.\n☝️ The unique file structure of NixOS, particularly the immutable /nix/store, makes it difficult to implement and manage the file-labeling mechanisms that these frameworks rely on. There are ongoing community efforts to improve support, but as of now, they are considered experimental and not a standard part of a typical NixOS configuration.\nContainers and VMs are beyond the scope of this chapter but can also enhance security if configured correctly.\nIt’s crucial to document every change you make. By creating smaller, feature-complete commits, each with a descriptive message, you’re building a clear history. This approach makes it far simpler to revert a breaking change and quickly identify what went wrong. Over time, this discipline allows you to create security-focused checklists and ensure all angles are covered, building a more robust and secure system.\nCheck out the Hardening NixOS Baseline Hardening README for baseline hardening recommendations and best practices.\nMinimal Installation with LUKS Begin with NixOS’s minimal installation image. This gives you a base system with only essential tools and no extras that could introduce vulnerabilities.\nManual Encrypted Install Following the Manual Minimal ISO Download (64-bit Intel/AMD)\nNixOS Manual Installation\nNixOS Wiki Full Disk Encryption\nGuided Encrypted install using disko Use LUKS encryption to protect your data at rest, the following guide is a minimal disko encrypted installation: Encrypted Install\nImpermanence Impermanence, especially when using a tmpfs as the root filesystem, provides several significant security benefits. The core principle is that impermanence defeats persistence, a fundamental goal for any attacker.\nWhen you use a root-as-tmpfs setup on NixOS, the boot process loads the entire operating system from the read-only Nix store into a tmpfs in RAM. The mutable directories, such as /etc and /var, are then created on this RAM disk. When the system is shut down, the tmpfs is wiped, leaving the on-disk storage untouched and secure.\nThis means you get a fresh, secure boot every time, making it much harder for an attacker to maintain a presence on your system.\nErase your Darlings (ZFS)\nEncrypted BTRFS Impermanence Guide Only follow this guide if you also followed the encrypted disko install, impermanence is designed to be destructive and needs to match your config exactly.\nSecure Boot Enable a UEFI password or Administrator password where it requires authentication in order to access the UEFI/BIOS.\nSecure Boot helps ensure only signed, trusted kernels and bootloaders are executed at startup.\nUseful Resources:\nThe Strange State of Authenticated Boot and Encryption\nNixOS Wiki Secure Boot\nlanzaboote repo\nPractical Lanzaboote Secure Boot setup for NixOS: Guide:Secure Boot on NixOS with Lanzaboote\nThe Kernel Given the kernel’s central role, it’s a frequent target for malicious actors, making robust hardening essential.\nNixOS provides a hardened profile that applies a set of security-focused kernel and system configurations.\nFor flakes, you could do something like the following in your configuration.nix or equivalent to import hardened.nix and enable profiles.hardened:\n# configuration.nix { pkgs, inputs, ... }: let modulesPath = \"${inputs.nixpkgs}/nixos/modules\"; in { imports = [ \"${modulesPath}/profiles/hardened.nix\" ]; } There is a proposal to remove it completely that has gained ground, the following thread discusses why: Discourse Thread\nPR #383438 Proposed removal PR.\nCheck hardened.nix to see exactly what adding it enables to avoid duplicates and conflicts moving on. I included this for completeness, the choice is yours if you want to use it or not.\nChoosing your Kernel See which kernel you’re currently using with:\n# show the kernel release uname -r # show kernel version, hostname, and architecture uname -a Show the configuration of your current kernel:\nzcat /proc/config.gz # ...snip... # # Compression # CONFIG_CRYPTO_DEFLATE=m CONFIG_CRYPTO_LZO=y CONFIG_CRYPTO_842=m CONFIG_CRYPTO_LZ4=m CONFIG_CRYPTO_LZ4HC=m CONFIG_CRYPTO_ZSTD=y # end of Compression # ...snip... The NixOS Manual states that the default Linux kernel configuration should be fine for most users.\nThe Linux kernel is typically released under two forms: stable and long-term support (LTS). Choosing either has consequences, do your research. Stable vs. LTS kernels\nThe Linux Kernel Archives Active kernel releases OR, you can choose the hardened kernel for a kernel that prioritizes security over everything else.\nThe Hardened Kernel The linuxPackages_latest_hardened attribute has been deprecated. If you want to use a hardened kernel, you must specify a versioned package that is currently supported.\nYou can find the latest available hardened kernel packages by searching pkgs/top-level/linux-kernels.nix\nFor example, to use the latest available 6.12, you would configure it like this:\nboot.kernelPackages = pkgs.linux_6_12_hardened; Note that this not only replaces the kernel, but also packages that are specific to the kernel version, such as NVIDIA video drivers.\nIf you decide to use this, read further before rebuilding. You can inspect nixpkgs/pkgs/os-specific/linux/kernel/hardened/patches.json to see the metadata of the patches that are applied. You can then follow the links in the .json file to see the patch diffs.\n❗ NOTE: Always check the linux-kernels.nix file for the latest available versions, as older kernels are regularly removed from Nixpkgs.\nsysctl sysctl is a tool that allows you to view or modify kernel settings and enable/disable different features.\nCheck all sysctl parameters (long output):\nsysctl -a Or a specific parameter:\nsysctl -a | grep \"kernel.kptr_restrict\" Check Active Linux Security Modules:\ncat /sys/kernel/security/lsm Check Kernel Configuration Options:\nzcat /proc/config.gz | grep CONFIG_SECURITY_SELINUX zcat /proc/config.gz | grep CONFIG_HARDENED_USERCOPY zcat /proc/config.gz | grep CONFIG_STACKPROTECTOR Since it is difficult to see exactly what enabling the hardened_kernel does. Before rebuilding, you could do something like this to see exactly what is added:\nsysctl -a \u003e before.txt And after the rebuild:\nsysctl -a \u003e after.txt And finally run a diff on them:\ndiff before.txt after.txt You can also diff against after.txt for future changes to avoid duplicates, this seems easier to me than trying to parse through the patches.\nFurther Hardening with sysctl sysctl hardening settings further reinforce kernel-level protections. The hardened kernel includes security patches and stricter defaults, but it doesn’t cover all runtime tunables. Refer to the above commands to get a diff of the changes.\nboot.kernel.sysctl: Runtime parameters of the Linux kernel, as set by sysctl(8). Note that the sysctl parameters names must be enclosed in quotes. Values may be a string, integer, boolean, or null.\nRefer to madadaidans-insecurities#sysctl-kernel for the following settings and their explainations.\nboot.kernel.sysctl = { \"fs.suid_dumpable\" = 0; # prevent pointer leaks \"kernel.kptr_restrict\" = 2; # restrict kernel log to CAP_SYSLOG capability \"kernel.dmesg_restrict\" = 1; # Note: certian container runtimes or browser sandboxes might rely on the following # restrict eBPF to the CAP_BPF capability \"kernel.unprivileged_bpf_disabled\" = 1; # should be enabled along with bpf above # \"net.core.bpf_jit_harden\" = 2; # restrict loading TTY line disciplines to the CAP_SYS_MODULE \"dev.tty.ldisk_autoload\" = 0; # prevent exploit of use-after-free flaws \"vm.unprivileged_userfaultfd\" = 0; # kexec is used to boot another kernel during runtime and can be abused \"kernel.kexec_load_disabled\" = 1; # Kernel self-protection # SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users # 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely \"kernel.sysrq\" = 4; # disable unprivileged user namespaces, Note: Docker, NH, and other apps may need this # \"kernel.unprivileged_userns_clone\" = 0; # commented out because it makes NH and other programs fail # restrict all usage of performance events to the CAP_PERFMON capability \"kernel.perf_event_paranoid\" = 3; # Network # protect against SYN flood attacks (denial of service attack) \"net.ipv4.tcp_syncookies\" = 1; # protection against TIME-WAIT assassination \"net.ipv4.tcp_rfc1337\" = 1; # enable source validation of packets received (prevents IP spoofing) \"net.ipv4.conf.default.rp_filter\" = 1; \"net.ipv4.conf.all.rp_filter\" = 1; \"net.ipv4.conf.all.accept_redirects\" = 0; \"net.ipv4.conf.default.accept_redirects\" = 0; \"net.ipv4.conf.all.secure_redirects\" = 0; \"net.ipv4.conf.default.secure_redirects\" = 0; # Protect against IP spoofing \"net.ipv6.conf.all.accept_redirects\" = 0; \"net.ipv6.conf.default.accept_redirects\" = 0; \"net.ipv4.conf.all.send_redirects\" = 0; \"net.ipv4.conf.default.send_redirects\" = 0; # prevent man-in-the-middle attacks \"net.ipv4.icmp_echo_ignore_all\" = 1; # ignore ICMP request, helps avoid Smurf attacks \"net.ipv4.conf.all.forwarding\" = 0; \"net.ipv4.conf.default.accept_source_route\" = 0; \"net.ipv4.conf.all.accept_source_route\" = 0; \"net.ipv6.conf.all.accept_source_route\" = 0; \"net.ipv6.conf.default.accept_source_route\" = 0; # Reverse path filtering causes the kernel to do source validation of \"net.ipv6.conf.all.forwarding\" = 0; \"net.ipv6.conf.all.accept_ra\" = 0; \"net.ipv6.conf.default.accept_ra\" = 0; ## TCP hardening # Prevent bogus ICMP errors from filling up logs. \"net.ipv4.icmp_ignore_bogus_error_responses\" = 1; # Disable TCP SACK \"net.ipv4.tcp_sack\" = 0; \"net.ipv4.tcp_dsack\" = 0; \"net.ipv4.tcp_fack\" = 0; # Userspace # restrict usage of ptrace \"kernel.yama.ptrace_scope\" = 2; # ASLR memory protection (64-bit systems) \"vm.mmap_rnd_bits\" = 32; \"vm.mmap_rnd_compat_bits\" = 16; # only permit symlinks to be followed when outside of a world-writable sticky directory \"fs.protected_symlinks\" = 1; \"fs.protected_hardlinks\" = 1; # Prevent creating files in potentially attacker-controlled environments \"fs.protected_fifos\" = 2; \"fs.protected_regular\" = 2; # Randomize memory \"kernel.randomize_va_space\" = 2; # Exec Shield (Stack protection) \"kernel.exec-shield\" = 1; ## TCP optimization # TCP Fast Open is a TCP extension that reduces network latency by packing # data in the sender’s initial TCP SYN. Setting 3 = enable TCP Fast Open for # both incoming and outgoing connections: \"net.ipv4.tcp_fastopen\" = 3; # Bufferbloat mitigations + slight improvement in throughput \u0026 latency \"net.ipv4.tcp_congestion_control\" = \"bbr\"; \"net.core.default_qdisc\" = \"cake\"; }; ❗ Note: The above settings are fairly aggressive and can break common programs, read the comment warnings.\nHardening Boot Parameters boot.kernelParams can be used to set additional kernel command line arguments at boot time. It can only be used for built-in modules.\nYou can find the following settings in the above guide in the Boot parameters section\n# boot.nix boot.kernelParams = [ # make it harder to influence slab cache layout \"slab_nomerge\" # enables zeroing of memory during allocation and free time # helps mitigate use-after-free vulnerabilaties \"init_on_alloc=1\" \"init_on_free=1\" # randomizes page allocator freelist, improving security by # making page allocations less predictable \"page_alloc.shuffel=1\" # enables Kernel Page Table Isolation, which mitigates Meltdown and # prevents some KASLR bypasses \"pti=on\" # randomizes the kernel stack offset on each syscall # making attacks that rely on a deterministic stack layout difficult \"randomize_kstack_offset=on\" # disables vsyscalls, they've been replaced with vDSO \"vsyscall=none\" # disables debugfs, which exposes sensitive info about the kernel \"debugfs=off\" # certain exploits cause an \"oops\", this makes the kernel panic if an \"oops\" occurs \"oops=panic\" # only alows kernel modules that have been signed with a valid key to be loaded # making it harder to load malicious kernel modules # can make VirtualBox or Nvidia drivers unusable \"module.sig_enforce=1\" # prevents user space code excalation \"lockdown=confidentiality\" # \"rd.udev.log_level=3\" # \"udev.log_priority=3\" ]; This is a thoughtful start to hardening boot parameters, there are more recommendations in the guide.\nKernel modules for hardware devices are generally loaded automatically by udev. You can force a module to be loaded via boot.kernelModules.\nboot.blacklistedKernelModules: List of names of kernel modules that should not be loaded automatically by the hardware probing code.\nYou can find the following settings in the Blacklisting Kernel Modules Section\nboot.blacklistedKernelModules = [ # Obscure networking protocols \"dccp\" \"sctp\" \"rds\" \"tipc\" \"n-hdlc\" \"ax25\" \"netrom\" \"x25\" \"rose\" \"decnet\" \"econet\" \"af_802154\" \"ipx\" \"appletalk\" \"psnap\" \"p8023\" \"p8022\" \"can\" \"atm\" # Various rare filesystems \"cramfs\" \"freevxfs\" \"jffs2\" \"hfs\" \"hfsplus\" \"udf\" # Not so rare filesystems # \"squashfs\" # \"cifs\" # \"nfs\" # \"nfsv3\" # \"nfsv4\" # \"ksmbd\" # \"gfs2\" # vivid driver is only useful for testing purposes and has been the # cause of privilege escalation vulnerabilities # \"vivid\" ]; As with the kernelParameters above, there are more suggestions in the guide, I have used the above parameters along with the commented out ones and had no issues.\nHardening Systemd systemd is the core “init system” and service manager that controls how services, daemons, and basic system processes are started, stopped and supervised on modern Linux distributions, including NixOS. It provides a suite of basic building blocks for a Linux system as well as a system and service manager that runs as PID 1 and starts the rest of the system.\nBecause it launches and supervises almost all system services, hardening systemd means raising the baseline security of your entire system.\ndbus-broker is generally considered more secure and robust but isn’t the default as of yet. To set dbus-broker as the default:\nusers.groups.netdev = {}; services = { dbus.implementation = \"broker\"; logrotate.enable = true; journald = { storage = \"volatile\"; # Store logs in memory upload.enable = false; # Disable remote log upload (the default) extraConfig = '' SystemMaxUse=500M SystemMaxFileSize=50M ''; }; }; dbus-broker is more resilient to resource exhaustion attacks and integrates better with Linux security features.\nSetting storage = \"volatile\" tells journald to keep log data only in memory. There is a tradeoff though, If you need long-term auditing or troubleshooting after a reboot, this will not preserve system logs.\nupload.enable is for forwarding log messages to remote servers, setting this to false prevents accidental leaks of potentially sensitive or internal system information.\nEnabling logrotate prevents your disk from filling with excessive legacy/service log files. These are the classic plain-text logs.\nSystemd uses journald which stores logs in a binary format\nYou can check the security status with:\nsystemd-analyze security # or for a detailed view of individual services security posture systemd-analyze security NetworkManager Further reading on systemd:\nsystemd.io\nRethinking PID 1\nBiggest Myths about Systemd\nThe following is a repo containing many of the Systemd hardening settings in NixOS format:\nnix-system-services-hardened\nFor example, to harden bluetooth you could add the following to your configuration.nix or equivalent:\nsystemd.services = { bluetooth.serviceConfig = { ProtectKernelTunables = lib.mkDefault true; ProtectKernelModules = lib.mkDefault true; ProtectKernelLogs = lib.mkDefault true; ProtectHostname = true; ProtectControlGroups = true; ProtectProc = \"invisible\"; SystemCallFilter = [ \"~@obsolete\" \"~@cpu-emulation\" \"~@swap\" \"~@reboot\" \"~@mount\" ]; SystemCallArchitectures = \"native\"; }; } As you can see from above, you typically use the serviceConfig attribute to harden settings for systemd services.\nsystemd-analyze security bluetooth → Overall exposure level for bluetooth.service: 3.3 OK 🙂 Lynis and other tools Lynis is a security auditing tool for systems based on UNIX like Linux, macOS, BSD, and others.–lynis repo\nInstallation:\nenvironment.systemPackages = [ pkgs.lynis pkgs.chkrootkit pkgs.clamav pkgs.aide ]; Usage:\nsudo lynis show commands # Output: Commands: lynis audit lynis configure lynis generate lynis show lynis update lynis upload-only sudo lynis audit system # Output: Lynis security scan details: Hardening index : 79 [############### ] Tests performed : 234 Plugins enabled : 0 Components: - Firewall [V] - Malware scanner [V] Scan mode: Normal [V] Forensics [ ] Integration [ ] Pentest [ ] Lynis modules: - Compliance status [?] - Security audit [V] - Vulnerability scan [V] The “Lynis hardening index” is an overall impression on how well a system is hardened. However, this is just an indicator on measures taken - not a percentage of how safe a system might be. A score over 75 typically indicates a system with more than average safety measures implemented.\nLynis will give you more recommendations for securing your system as well.\nExample cron job for chkrootkit:\n{pkgs, ...}: { services.cron = { enable = true; # messages.enable = true; systemCronJobs = [ # Every Sunday at 2:10 AM, run chkrootkit as root, log output for review \"10 2 * * 0 root ${pkgs.chkrootkit}/bin/chkrootkit | logger -t chkrootkit\" ]; }; } The above cron job will use chkrootkit to automatically scan for known rootkit signatures. It can detect hidden processes and network connections.\nI got the recommendation for clamav from the Paranoid NixOS blog post and the others help with compliance for lynis.\nSecuring SSH Security information: Changing SSH configuration settings can significantly impact the security of your system(s). It is crucial to have a solid understanding of what you are doing before making any adjustments. Avoid blindly copying and pasting examples, including those from this Wiki page, without conducting a thorough analysis. Failure to do so may compromise the security of your system(s) and lead to potential vulnerabilities. Take the time to comprehend the implications of your actions and ensure that any changes made are done thoughtfully and with care. –NixOS Wiki\n❗ NOTE: I am going to show two approaches for SSH authentication. You should typically choose one:\nUse normal SSH keys generated with ssh-keygen, this is recommended unless you have a good reason for not using it. OR\nUse a GPG key with gpg-agent (which acts as your SSH agent). Complex, and harder to understand in my opinion. My setup caused conflicts when enabling programs.ssh.startAgent so I chose gpg-agent personally.\nThere are situations where you are required to use one or the other like for headless CI/CD environments, ssh-keygen is required.\nFurther reading:\nArch Wiki OpenSSH\nGentoo GnuPG\nA Visual Explanation of GPG Subkeys\nSecure Secure Shell\nKey generation ssh-keygen The ed25519 algorithm is significantly faster and more secure when compared to RSA. You can also specify the key derivation function (KDF) rounds to strengthen protection even more.\nFor example, to generate a strong key for MdBook:\nssh-keygen -t ed25519 -a 32 -f ~/.ssh/id_ed25519_github_$(date +%Y-%m-%d) -C \"SSH Key for MdBook\" -t is for type\n-a 32 sets the number of KDF rounds. The standard is usually good enough, adding extra rounds can make it harder to brute-force.\n-f is for filename\nOR\nInstall GNUPG and gpg-agent for Home Manager PGP (Pretty Good Privacy) and GPG (GNU Privacy Guard). While distinct, they are deeply interconnected and, for the rest of this section, I’ll use the terms interchangeably.\nPGP was the original, groundbreaking software that brought robust public-key cryptography to the masses. It set the standard for secure email communication. However, PGP later became a commercial product.\nTo provide a free and open-source alternative that anyone could use and inspect, GPG was created. Crucially, GPG is a complete implementation of the OpenPGP standard. This open standard acts as a universal language for encryption and digital signatures.\nWhat’s safe to share?\nYour public key (used to encrypt files and verify signatures)\nYour key ID (identifies your key, useful for sharing public keys or configs)\nWhat must never be shared?\nYour private (secret) key, usually in your ~/.gnupg/private-keys-v1.d/ directory.\nYour passphrase for your private key.\nHome Manager module with gpg-agent, gnupg, and pinentry-gnome3:\n# gpg-agent.nix { config, lib, pkgs, ... }: { options = { custom.pgp = { enable = lib.mkEnableOption { description = \"Enable PGP Gnupgp\"; default = false; }; }; }; config = lib.mkIf config.custom.pgp.enable { services = { ## Enable gpg-agent with ssh support gpg-agent = { enable = true; enableSshSupport = true; enableZshIntegration = true; pinentryPackage = pkgs.pinentry-gnome3; }; ## We will put our keygrip here gpg-agent.sshKeys = []; }; home.packages = [pkgs.gnupg]; programs = { gpg = { ## Enable GnuPG enable = true; # homedir = \"/home/userName/.config/gnupg\"; }; }; }; } The default path is ~/.gnupg, if you prefer placing it in the ~/.config directory uncomment the homedir line and change userName to your username.\nI use hyprland so pinentry-gnome3 works for me, there is also the following options for this attribute:\npinentry-tty\npinentry-qt\npinentry-gtk2\nAnd more, research what you need and use the correct one.\nEnable in your home.nix or equivalent:\n# home.nix # ... snip ... imports = [ ./gpg-agent.nix ]; custom.pgp.enable = true; # ... snip ... gpg --full-generate-key can be used to generate a basic keypair, adding --expert gives more options and capabilities needed for gpg-agent.\nTo generate a pgp key you can do the following:\ngpg --expert --full-generate-key Choose the default (11) ECC (set your own capabilities)\nChoose A for Authenticate capabilities, which is the only setting required for this. Additional subkeys may be created for encryption, sign, and/or authentication capabilities.\nChoose (1) Default Curve 25519\nGive it a name and description\nGive it an expiration date, 1y is common\nUse a strong passphrase or password\nIf you see a warning about incorrect permissions, you can run the following:\nchmod 700 ~/.gnupg chmod 600 ~/.gnupg/* Verify:\nls -ld ~/.gnupg # Should show: drwx------ ls -l ~/.gnupg # Files should show: -rw------- After fixing, run:\ngpg --list-keys The warning should be gone.\nList your key and copy the key ID\ngpg --list-secret-keys --keyid-format LONG Output example:\nsec ed25519/ABCDEF1234567890 2025-07-31 [SC] ABC123ABC123ABC123ABC123ABC123ABC123ABC1 uid [ultimate] Your Name ssb ed25519/1234567890ABCDEF 2025-07-31 [S] Take the part after / on the sec line (e.g., ABCDEF1234567890) Export the public key for GitHub\ngpg --armor --export ABCDEF1234567890 Copy everything from -----BEGIN PGP PUBLIC KEY BLOCK----- to -----END PGP PUBLIC KEY BLOCK-----. Add to GitHub\nGo to Settings, SSH and GPG keys, New GPG key\nPaste the exported block.\nAdd Keygrip to sshcontrol for gpg-agent\ngpg --list-secret-keys --with-keygrip --with-colons Copy the grp line - that’s your keygrip Add the keygrip number to your gpg-agent.sshKeys and rebuild:\ngpg-agent.sshKeys = [\"6BD11826F3845BC222127FE3D22C92C91BB3FB32\"]; By itself, a keygrip cannot be used to reconstruct your private key. It’s derived from the public key material, not from the secret key itself so it’s safe to version control. Don’t put your keygrip in a public repo if you don’t want people to know you use that key for signing/authentication. It’s not a security risk, but it leaks a tiny bit of metadata. The following article mentions the keygrip being computed from public elements of the key:\ngnupg-users what-is-a-keygrip\nNever version-control your private key files or .gnupg contents.\nAdd the following to your shell config:\n# zsh.nix # ... snip ... initContent = '' # GPG Agent export GPG_TTY=$(tty) # which terminal to use for passphrase prompts export SSH_AUTH_SOCK=\"$(gpgconf --list-dirs agent-ssh-socket)\" # points SSH_AUTH_SOCK to the socket created by gpg-agent gpg-connect-agent updatestartuptty /bye # refresh gpg-agent so it knows which terminal is active # Optional: confirm it's set correctly echo \"SSH_AUTH_SOCK is set to: $SSH_AUTH_SOCK\" ''; # ... snip ... Rebuild and then restart gpg-agent:\ngpgconf --kill gpg-agent gpgconf --launch gpg-agent Test, these should match:\necho \"$SSH_AUTH_SOCK\" # output /run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76534j/S.gpg-agent.ssh gpgconf --list-dirs agent-ssh-socket # output /run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76834j/S.gpg-agent.ssh ssh-add -L # Copy the entire following line: ssh-ed25519 AABBC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none) Mine shows (none) because I left the comment field blank when creating the key and doesn’t affect functionality. Then, in your server’s NixOS configuration (e.g., configuration.nix):\nservices.openssh = { enable = true; authorizedKeys.keys = [ \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I\" ]; }; ❗ NOTE: Only the public key goes here, it’s safe to commit to version control. If you prefer not to hardcode it in the config, you can reference it from a .pub file in your repo and read it with builtins.readFile ./mykey.pub\nRebuild your system and test an SSH connection into the server:\nssh -p user@hostname is often 22 so it would be something like: ssh -p 22 bill@xps Encrypt a File with PGP List your keys and get the key ID gpg --list-keys --keyid-format LONG Example output:\npub rsa4096/ABCDEF1234567890 2024-01-01 [SC] uid [ultimate] Your Name sub rsa4096/1234567890ABCDEF 2024-01-01 [E] The part after the slash on the pub line is your key ID (ABCDEF1234567890 in the example)\nYou can also use your email or name to refer to the key in most commands.\nEncrypt a file for yourself echo \"This file will be encrypted\" \u003e file.txt gpg --encrypt --recipient ABCDEF1234567890 file.txt ls │ 7 │ file.txt │ file │ 28 B │ now │ │ 8 │ file.txt.gpg │ file │ 191 B │ now │ gpg --encrypt doesn’t modify the original file. It creates a new encrypted file by default with gpg amended to the filename.\ngpg --decrypt file.txt.gpg gpg: encrypted with cv25519 key, ID 0x4AC131B80CEC833E, created 2025-07-31 \"GPG Key \" This file will be encrypted You will be asked for the passphrase you used when creating the key in order to decrypt the file. There is much more you can do with PGP beyond simple file encryption:\nSign files and commits: Prove that content really came from you.\nEncrypt for multiple recipients: Share encrypted data with teammates using their public keys.\nUse smartcards or YubiKeys: Store your private key on hardware for extra security.\nVerify software releases: Check that downloaded files are genuine using the developer’s signature.\nIntegrate with Git: Sign tags and commits so others can trust your repository history.\nThis guide only scratches the surface — once your PGP key and gpg-agent are set up, these capabilities become easy to add to your workflow.\nOpenSSH Server First of all, if you don’t use SSH don’t enable it in the first place. If you do use SSH, it’s important to understand what that opens you up to.\nThe following are some recommendations from Mozilla on OpenSSH:\nMozilla OpenSSH guidelines The following OpenSSH setup is based on the above guidelines with strong algorithms, and best practices:\n{config, ...}: { config = { services = { fail2ban = { enable = true; maxretry = 5; bantime = \"1h\"; # ignoreIP = [ # \"172.16.0.0/12\" # \"192.168.0.0/16\" # \"2601:881:8100:8de0:31e6:ac52:b5be:462a\" # \"matrix.org\" # \"app.element.io\" # don't ratelimit matrix users # ]; bantime-increment = { enable = true; # Enable increment of bantime after each violation multipliers = \"1 2 4 8 16 32 64 128 256\"; maxtime = \"168h\"; # Do not ban for more than 1 week overalljails = true; # Calculate the bantime based on all the violations }; }; openssh = { enable = true; settings = { PasswordAuthentication = false; PermitEmptyPasswords = false; PermitTunnel = false; UseDns = false; KbdInteractiveAuthentication = false; X11Forwarding = config.services.xserver.enable; MaxAuthTries = 3; MaxSessions = 2; ClientAliveInterval = 300; ClientAliveCountMax = 0; AllowUsers = [\"your-user\"]; TCPKeepAlive = false; AllowTcpForwarding = false; AllowAgentForwarding = false; LogLevel = \"VERBOSE\"; PermitRootLogin = \"no\"; KexAlgorithms = [ \"curve25519-sha256@libssh.org\" \"ecdh-sha2-nistp521\" \"ecdh-sha2-nistp384\" \"ecdh-sha2-nistp256\" \"diffie-hellman-group-exchange-sha256\" ]; Ciphers = [ \"chacha20-poly1305@openssh.com\" \"aes256-gcm@openssh.com\" \"aes128-gcm@openssh.com\" \"aes256-ctr\" \"aes192-ctr\" \"aes128-ctr\" ]; Macs = [ \"hmac-sha2-512-etm@openssh.com\" \"hmac-sha2-256-etm@openssh.com\" \"umac-128-etm@openssh.com\" \"hmac-sha2-512\" \"hmac-sha2-256\" \"umac-128@openssh.com\" ]; }; hostKeys = [ { path = \"/etc/ssh/ssh_host_ed25519_key\"; type = \"ed25519\"; } ]; }; }; }; } TCP port 22 (ssh) is opened automatically if the SSH daemon is enabled (services.openssh.enable = true;)\nMuch of the SSH hardening settings came from ryanseipp’s secure-ssh Guide with some additions of my own.\nFail2Ban is an intrusion prevention software framework. It’s designed to prevent brute-force attacks by scanning log files for suspicious activity, such as repeated failed login attempts.\nOpenSSH is the primary tool for secure remote access for NixOS. Enabling it activates the OpenSSH server on the system, allowing incoming SSH connections.\nThe above configuration is a robust setup for securing an SSH server by:\nPreventing brute-force attacks with Fail2Ban\nEliminating password authentication in favor of more secure SSH keys\nRestricting user access and preventing root login\nDisabling potentially risky forwarding features (tunnel, TCP, agent)\nEnforce the use of strong, modern cryptographic algorithms for all SSH communications.\nEnhanced logging for better auditing.\nFurther Reading:\nOpenSSH\nDigitalOcean how fail2ban works\nEncrypted Secrets Never store secrets in plain text in repositories. Use something like sops-nix, which lets you keep encrypted secrets under version control declaratively.\nAnother option is agenix\nNixOS Wiki Agenix Sops-nix Guide Protect your secrets, the following guide is on setting up Sops on NixOS: Sops Encrypted Secrets\nAuditd To enable the Linux Audit Daemon (auditd) and define a very basic rule set, you can use the following NixOS configuration. This example demonstrates how to log every program execution (execve) on a 64-bit architecture.\n# modules/security/auditd-minimal.nix (or directly in configuration.nix) { # start as early in the boot process as possible boot.kernelParams = [\"audit=1\"]; security.auditd.enable = true; security.audit.enable = true; security.audit.rules = [ # Log all program executions on 64-bit architecture \"-a exit,always -F arch=b64 -S execve\" ]; } audit=1 Enables auditing at the kernel level very early in the boot process. Without this, some events could be missed.\nsecurity.auditd.enable = true; Ensures the auditd userspace daemon is started.\nWhile often enabled together, security.audit.enable specifically refers to enabling the NixOS module for audit rules generation.\nexecve (program executions)\nThis is just a basic configuration, there is much more that can be tracked.\nUSB Port Protection It’s important to protect your USB ports to prevent BadUSB attacks, data exfiltration, unauthorized device access, malware injection, etc.\nTo get a list of your connected USB devices you can use lsusb from the usbutils package.\nlsusb To list the devices recognized by USBGuard, run:\nsudo usbguard list-devices MyNixOS services.usbguard Change your-user to your username:\n# usbguard.nix { config, pkgs, lib, ... }: let inherit (lib) mkIf; cfg = config.custom.security.usbguard; in { options.custom.security.usbguard = { enable = lib.mkEnableOption \"usbguard\"; }; config = mkIf cfg.enable { services.usbguard = { enable = true; IPCAllowedUsers = [\"root\" \"your-user\"]; # presentDevicePolicy refers to how to treat USB devices that are already connected when the daemon starts presentDevicePolicy = \"allow\"; rules = '' # allow `only` devices with mass storage interfaces (USB Mass Storage) allow with-interface equals { 08:*:* } # allow mice and keyboards # allow with-interface equals { 03:*:* } # Reject devices with suspicious combination of interfaces reject with-interface all-of { 08:*:* 03:00:* } reject with-interface all-of { 08:*:* 03:01:* } reject with-interface all-of { 08:*:* e0:*:* } reject with-interface all-of { 08:*:* 02:*:* } ''; }; environment.systemPackages = [pkgs.usbguard]; }; } The above settings can be found in RedHat UsbGuard\nThe only allow rule is for devices with only mass storage interfaces (08:*:*) i.e., USB Mass storage devices, devices like keyboards and mice (which use interface class 03:*:*) implicitly not allowed.\nThe reject rules reject devices with a suspicious combination of interfaces. A USB drive that implements a keyboard or a network interface is very suspicious, these reject rules prevent that.\nThe presentDevicePolicy = \"allow\"; allows any device that is present at daemon start up even if they’re not explicitly allowed. However, newly plugged in devices must match an allow rule or get denied implicitly.\nThe presentDevicePolicy should be one of: # one of \"apply-policy\"(default, evaluate the rule set for every present device), \"block\", \"reject\", \"keep\" (keep whatever state the device is currently in), or \"allow\", which is used in the example.\nThere is also the usbguard-notifier\nAnd enable it with the following in your configuration.nix or equivalent:\n# configuration.nix imports = [ ./usbguard.nix ]; custom.security.usbguard.enable = true; ❗ If you are ever unsure about a setting that you want to harden and think that it could possibly break your system you can always use a specialisation reversing the action and choose it’s generation at boot up. For example, to force-reverse the above settings you could:\n# configuration.nix specialisation.no-usbguard.configuration = { services.usbguard.enable = lib.mkForce false; }; This is a situation where I recommend this, it’s easy to lock yourself out of your keyboard, mouse, etc. when trying to configure this. Further Reading:\nNinjaOne BadUSB\nUSBGuard\nNixCraft USBGuard\nDoas over sudo For a more minimalist version of sudo with a smaller codebase and attack surface, consider doas. Replace userName with your username:\n# doas.nix { lib, config, pkgs, # Add pkgs if you need to access user information ... }: let cfg = config.custom.security.doas; in { options.custom.security.doas = { enable = lib.mkEnableOption \"doas\"; }; config = lib.mkIf cfg.enable { # Disable sudo security.sudo.enable = false; # Enable and configure `doas`. security.doas = { enable = true; extraRules = [ { # Grant doas access specifically to your user users = [\"userName\"]; # \u003c--- Only give access to your user # persist = true; # Convenient but less secure # noPass = true; # Convenient but even less secure keepEnv = true; # Often necessary # Optional: You can also specify which commands they can run, e.g.: # cmd = \"ALL\"; # Allows running all commands (default if not specified) # cmd = \"/run/current-system/sw/bin/nixos-rebuild\"; # Only allow specific command } ]; }; # Add an alias to the shell for backward-compat and convenience. environment.shellAliases = { sudo = \"doas\"; }; }; } You would then import this into your configuration.nix and enable/disable it with the following:\n# configuration.nix imports = [ ./doas.nix ]; custom.security.doas.enable = true; ❗ NOTE: Many people opt for the less secure groups = [\"wheel\"]; in the above configuration instead of users = [\"userName\"]; to give wider access, the choice is yours.\nFirejail NixOS Wiki Firejail\nArch Wiki Firejail\n❗ WARNING: Running untrusted code is never safe, sandboxing cannot change this. –Arch Wiki\nFirejail is a SUID program that reduces the risk of security breaches by restricting the running environment of untrusted applications using Linux namespaces and seccomp-bpf–Firejail Security Sandbox\nIt provides sandboxing and access restriction per application, much like what AppArmor/SELinux does at a kernel level. However, it’s not as secure or comprehensive as kernel-enforced MAC systems (AppArmor/SELinux), since it’s a userspace tool and can potentially be bypassed by privilege escalation exploits.\nSeLinux/AppArmor MAC (Mandatory Access Control) AppArmor is available on NixOS, but is still in a somewhat experimental and evolving state. There are only a few profiles that have been adapted to NixOS, see here Discourse on default-profiles Which guides you here apparmor/includes.nix where you can see some of the abstractions and tunables to follow progress.\nSELinux: Experimental, not fully integrated, recent progress for advanced/curious users; expect rough edges and manual intervention if you want to try it. Most find SELinux more complex to configure and maintain than AppArmor.\nThis isn’t meant to be a comprehensive guide, more to get people thinking about security on NixOS.\nSee the following guide on hardening networking:\nHardening Networking Resources Advanced Hardening with nix-mineral (Community Project) For users seeking a more comprehensive and opinionated approach to system hardening beyond the built-in hardened profile, the community project nix-mineral offers a declarative NixOS module.\nnix-mineral aims to apply a wide array of security configurations, focusing on tweaking kernel parameters, system settings, and file permissions to reduce the attack surface.\nCommunity Project Status: nix-mineral is a community-maintained project and is not officially part of the Nixpkgs repository or NixOS documentation. Its development status is explicitly stated as “Alpha software,” meaning it may introduce stability issues or unexpected behavior. For detailed information on nix-mineral’s capabilities and current status, refer directly to its GitHub repository.\nAppArmor and apparmor.d on NixOS\nSELinux on NixOS\nParanoid NixOS\nNixOS Wiki Security\nLuks Encrypted File Systems\nDiscourse A Modern and Secure Desktop\nnotashelf NixOS Security 1 Systemd\nryanseipp hardening-nixos\nmadaidans Linux Hardening Guide\nHardening-Linux-Servers\nlinux-audit Linux Server hardening best practices\nlinux-audit Linux security guide extended\nArch Wiki Security\nGentoo Security_Handbook Concepts\nSTIGs are configuration standards developed by the Defense Information Systems Agency (DISA) to secure systems and software for the U.S. Department of Defense (DoD). They are considered a highly authoritative source for system hardening.There are recommendations for hardening all kinds of software in the Stig Viewer\nCIS Benchmarks\nNSA Cybersecurity Directorate\n","wordCount":"5941","inLanguage":"en","datePublished":"2025-08-10T08:37:54-04:00","dateModified":"2025-08-10T08:37:54-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/hardening_nixos/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<a href=/index.xml title="RSS Feed"><img src=/rss.png alt="RSS Feed" style=width:24px;height:24px></a></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Hardening_NixOS</h1><div class=post-meta><span title='2025-08-10 08:37:54 -0400 EDT'>August 10, 2025</span></div></header><div class=post-content><h1 id=hardening-nixos>Hardening NixOS<a hidden class=anchor aria-hidden=true href=#hardening-nixos>#</a></h1><figure><img loading=lazy src=/images/guy_fawks.png alt="guy fawks" width=1000></figure><p>Securing your NixOS system begins with a philosophy of minimalism, explicit
configuration, and proactive control.</p><blockquote><p>⚠️ Warning: I am not a security expert. This guide presents various options
for hardening NixOS, but it is your responsibility to evaluate whether each
adjustment suits your specific needs and environment. Security hardening and
process isolation can introduce stability challenges, compatibility issues, or
unexpected behavior. Additionally, these protections often come with
performance tradeoffs. Always conduct thorough research, there are no plug and
play one size fits all security solutions.</p></blockquote><blockquote><p>That said, I typically write about what I&rsquo;m implementing myself to deepen
understanding and share what works for me. <code>--Source</code> means the proceeding
paragraph came from <code>--Source</code>, you can often click to check for yourself. If
you use some common sense with a bit of caution you could end up with a more
secure NixOS system that fits your needs.</p></blockquote><blockquote><p>Much of this guide draws inspiration or recommendations from the well-known
<a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html>Linux Hardening Guide</a>
by Madaidan&rsquo;s Insecurities. Madaidan’s work is widely regarded in technical
and security circles as one of the most comprehensive and rigorously
researched sources on practical Linux security, frequently cited for its depth
and actionable advice. For example, much of the original basis for hardening
for <a href=https://github.com/cynicsketch/nix-mineral>nix-mineral</a> came from this
guide as well.</p></blockquote><blockquote><p>❗ <strong>Note on SELinux and AppArmor</strong>: While NixOS can provide a high degree of
security through its immutable and declarative nature, it&rsquo;s important to
understand the limitations regarding Mandatory Access Control (MAC)
frameworks. Neither SELinux nor AppArmor are fully supported or widely used in
the NixOS ecosystem. You can do a lot to secure NixOS but if anonymity and
isolation are paramount, I recommend booting into a
<a href=https://tails.net/>Tails USB stick</a>.</p></blockquote><p>☝️ The unique file structure of NixOS, particularly the immutable <code>/nix/store</code>,
makes it difficult to implement and manage the file-labeling mechanisms that
these frameworks rely on. There are ongoing community efforts to improve
support, but as of now, they are considered experimental and not a standard part
of a typical NixOS configuration.</p><p>Containers and VMs are beyond the scope of this chapter but can also enhance
security if configured correctly.</p><p>It&rsquo;s crucial to <strong>document every change</strong> you make. By creating smaller,
feature-complete commits, each with a descriptive message, you&rsquo;re building a
clear history. This approach makes it far simpler to revert a breaking change
and quickly identify what went wrong. Over time, this discipline allows you to
create security-focused checklists and ensure all angles are covered, building a
more robust and secure system.</p><p>Check out the
<a href=https://saylesss88.github.io/nix/index.html>Hardening NixOS Baseline Hardening README</a>
for baseline hardening recommendations and best practices.</p><h2 id=minimal-installation-with-luks>Minimal Installation with LUKS<a hidden class=anchor aria-hidden=true href=#minimal-installation-with-luks>#</a></h2><p>Begin with NixOS’s minimal installation image. This gives you a base system with
only essential tools and no extras that could introduce vulnerabilities.</p><h2 id=manual-encrypted-install-following-the-manual>Manual Encrypted Install Following the Manual<a hidden class=anchor aria-hidden=true href=#manual-encrypted-install-following-the-manual>#</a></h2><ul><li><p><a href=https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso>Minimal ISO Download (64-bit Intel/AMD)</a></p></li><li><p><a href=https://nixos.org/manual/nixos/stable/#sec-installation>NixOS Manual Installation</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/Full_Disk_Encryption>NixOS Wiki Full Disk Encryption</a></p></li></ul><h2 id=guided-encrypted-install-using-disko>Guided Encrypted install using disko<a hidden class=anchor aria-hidden=true href=#guided-encrypted-install-using-disko>#</a></h2><p>Use LUKS encryption to protect your data at rest, the following guide is a
minimal disko encrypted installation:
<a href=https://saylesss88.github.io/installation/enc/enc_install.html>Encrypted Install</a></p><h2 id=impermanence>Impermanence<a hidden class=anchor aria-hidden=true href=#impermanence>#</a></h2><p>Impermanence, especially when using a <code>tmpfs</code> as the root filesystem, provides
several significant security benefits. The core principle is that impermanence
defeats persistence, a fundamental goal for any attacker.</p><p>When you use a root-as-tmpfs setup on NixOS, the boot process loads the entire
operating system from the read-only Nix store into a <code>tmpfs</code> in RAM. The mutable
directories, such as <code>/etc</code> and <code>/var</code>, are then created on this RAM disk. When
the system is shut down, the <code>tmpfs</code> is wiped, leaving the on-disk storage
untouched and secure.</p><p>This means you get a fresh, secure boot every time, making it much harder for an
attacker to maintain a presence on your system.</p><ul><li><p><a href=https://grahamc.com/blog/erase-your-darlings/>Erase your Darlings (ZFS)</a></p></li><li><p><a href=https://saylesss88.github.io/installation/enc/encrypted_impermanence.html>Encrypted BTRFS Impermanence Guide</a>
Only follow this guide if you also followed the encrypted disko install,
impermanence is designed to be destructive and needs to match your config
exactly.</p></li></ul><h2 id=secure-boot>Secure Boot<a hidden class=anchor aria-hidden=true href=#secure-boot>#</a></h2><figure><img loading=lazy src=/images/virus1.png alt=Virus width=1000></figure><p>Enable a UEFI password or Administrator password where it requires
authentication in order to access the UEFI/BIOS.</p><p>Secure Boot helps ensure only signed, trusted kernels and bootloaders are
executed at startup.</p><p>Useful Resources:</p><ul><li><p><a href=https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html>The Strange State of Authenticated Boot and Encryption</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/Secure_Boot>NixOS Wiki Secure Boot</a></p></li><li><p><a href=https://github.com/nix-community/lanzaboote>lanzaboote repo</a></p></li></ul><p>Practical Lanzaboote Secure Boot setup for NixOS:
<a href=https://saylesss88.github.io/installation/enc/lanzaboote.html>Guide:Secure Boot on NixOS with Lanzaboote</a></p><h3 id=the-kernel>The Kernel<a hidden class=anchor aria-hidden=true href=#the-kernel>#</a></h3><p>Given the kernel&rsquo;s central role, it&rsquo;s a frequent target for malicious actors,
making robust hardening essential.</p><p>NixOS provides a <code>hardened</code> profile that applies a set of security-focused
kernel and system configurations.</p><p>For flakes, you could do something like the following in your
<code>configuration.nix</code> or equivalent to import <code>hardened.nix</code> and enable
<code>profiles.hardened</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> inputs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>   modulesPath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#e6db74>}</span><span style=color:#e6db74>/nixos/modules&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>modulesPath<span style=color:#e6db74>}</span><span style=color:#e6db74>/profiles/hardened.nix&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>There is a proposal to remove it completely that has gained ground, the
following thread discusses why:
<a href=https://discourse.nixos.org/t/proposal-to-deprecate-the-hardened-profile/63081>Discourse Thread</a></p></li><li><p><a href=https://github.com/NixOS/nixpkgs/pull/383438>PR #383438</a> Proposed removal
PR.</p></li><li><p>Check
<a href=https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/hardened.nix>hardened.nix</a>
to see exactly what adding it enables to avoid duplicates and conflicts moving
on. I included this for completeness, the choice is yours if you want to use
it or not.</p></li></ul><h2 id=choosing-your-kernel>Choosing your Kernel<a hidden class=anchor aria-hidden=true href=#choosing-your-kernel>#</a></h2><p>See which kernel you&rsquo;re currently using with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># show the kernel release</span>
</span></span><span style=display:flex><span>uname -r
</span></span><span style=display:flex><span><span style=color:#75715e># show kernel version, hostname, and architecture</span>
</span></span><span style=display:flex><span>uname -a
</span></span></code></pre></div><p>Show the configuration of your current kernel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zcat /proc/config.gz
</span></span><span style=display:flex><span><span style=color:#75715e># ...snip...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compression</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>CONFIG_CRYPTO_DEFLATE<span style=color:#f92672>=</span>m
</span></span><span style=display:flex><span>CONFIG_CRYPTO_LZO<span style=color:#f92672>=</span>y
</span></span><span style=display:flex><span>CONFIG_CRYPTO_842<span style=color:#f92672>=</span>m
</span></span><span style=display:flex><span>CONFIG_CRYPTO_LZ4<span style=color:#f92672>=</span>m
</span></span><span style=display:flex><span>CONFIG_CRYPTO_LZ4HC<span style=color:#f92672>=</span>m
</span></span><span style=display:flex><span>CONFIG_CRYPTO_ZSTD<span style=color:#f92672>=</span>y
</span></span><span style=display:flex><span><span style=color:#75715e># end of Compression</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...snip...</span>
</span></span></code></pre></div><p>The <a href=https://nixos.org/manual/nixos/stable/#sec-kernel-config>NixOS Manual</a>
states that the default Linux kernel configuration should be fine for most
users.</p><p>The Linux kernel is typically released under two forms: stable and long-term
support (LTS). Choosing either has consequences, do your research.
<a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#stable-vs-lts>Stable vs. LTS kernels</a></p><ul><li><a href=https://www.kernel.org/category/releases.html>The Linux Kernel Archives Active kernel releases</a></li></ul><p><strong>OR</strong>, you can choose the hardened kernel for a kernel that prioritizes
security over everything else.</p><h3 id=the-hardened-kernel>The Hardened Kernel<a hidden class=anchor aria-hidden=true href=#the-hardened-kernel>#</a></h3><p>The <code>linuxPackages_latest_hardened</code> attribute has been deprecated. If you want
to use a hardened kernel, you must specify a versioned package that is currently
supported.</p><p>You can find the latest available hardened kernel packages by searching
<a href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/linux-kernels.nix>pkgs/top-level/linux-kernels.nix</a></p><p>For example, to use the latest available <code>6.12</code>, you would configure it like
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>boot<span style=color:#f92672>.</span>kernelPackages <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>linux_6_12_hardened;
</span></span></code></pre></div><p>Note that this not only replaces the kernel, but also packages that are specific
to the kernel version, such as NVIDIA video drivers.</p><ul><li>If you decide to use this, read further before rebuilding.</li></ul><p>You can inspect
<a href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel/hardened/patches.json>nixpkgs/pkgs/os-specific/linux/kernel/hardened/patches.json</a>
to see the metadata of the patches that are applied. You can then follow the
links in the <code>.json</code> file to see the patch diffs.</p><blockquote><p>❗ NOTE: Always check the <code>linux-kernels.nix</code> file for the latest available
versions, as older kernels are regularly removed from Nixpkgs.</p></blockquote><h3 id=sysctl>sysctl<a hidden class=anchor aria-hidden=true href=#sysctl>#</a></h3><p><code>sysctl</code> is a tool that allows you to view or modify kernel settings and
enable/disable different features.</p><p>Check all <code>sysctl</code> parameters (long output):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -a
</span></span></code></pre></div><p>Or a specific parameter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -a | grep <span style=color:#e6db74>&#34;kernel.kptr_restrict&#34;</span>
</span></span></code></pre></div><p>Check Active Linux Security Modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /sys/kernel/security/lsm
</span></span></code></pre></div><p>Check Kernel Configuration Options:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zcat /proc/config.gz | grep CONFIG_SECURITY_SELINUX
</span></span><span style=display:flex><span>zcat /proc/config.gz | grep CONFIG_HARDENED_USERCOPY
</span></span><span style=display:flex><span>zcat /proc/config.gz | grep CONFIG_STACKPROTECTOR
</span></span></code></pre></div><p>Since it is difficult to see exactly what enabling the hardened_kernel does.
Before rebuilding, you could do something like this to see exactly what is
added:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -a &gt; before.txt
</span></span></code></pre></div><p>And after the rebuild:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -a &gt; after.txt
</span></span></code></pre></div><p>And finally run a <code>diff</code> on them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>diff before.txt after.txt
</span></span></code></pre></div><p>You can also diff against <code>after.txt</code> for future changes to avoid duplicates,
this seems easier to me than trying to parse through the patches.</p><h2 id=further-hardening-with-sysctl>Further Hardening with sysctl<a hidden class=anchor aria-hidden=true href=#further-hardening-with-sysctl>#</a></h2><p><code>sysctl</code> hardening settings further reinforce kernel-level protections. The
hardened kernel includes security patches and stricter defaults, but it doesn&rsquo;t
cover all runtime tunables. Refer to the above commands to get a diff of the
changes.</p><p><a href=https://nixos.org/manual/nixos/stable/options#opt-boot.kernel.sysctl>boot.kernel.sysctl</a>:
Runtime parameters of the Linux kernel, as set by sysctl(8). Note that the
sysctl parameters names must be enclosed in quotes. Values may be a string,
integer, boolean, or null.</p><p>Refer to
<a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#sysctl-kernel>madadaidans-insecurities#sysctl-kernel</a>
for the following settings and their explainations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>  boot<span style=color:#f92672>.</span>kernel<span style=color:#f92672>.</span>sysctl <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fs.suid_dumpable&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># prevent pointer leaks</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.kptr_restrict&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># restrict kernel log to CAP_SYSLOG capability</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.dmesg_restrict&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Note: certian container runtimes or browser sandboxes might rely on the following</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># restrict eBPF to the CAP_BPF capability</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.unprivileged_bpf_disabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># should be enabled along with bpf above</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># &#34;net.core.bpf_jit_harden&#34; = 2;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># restrict loading TTY line disciplines to the CAP_SYS_MODULE</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dev.tty.ldisk_autoload&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># prevent exploit of use-after-free flaws</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;vm.unprivileged_userfaultfd&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># kexec is used to boot another kernel during runtime and can be abused</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.kexec_load_disabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Kernel self-protection</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.sysrq&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># disable unprivileged user namespaces, Note: Docker, NH, and other apps may need this</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># &#34;kernel.unprivileged_userns_clone&#34; = 0; # commented out because it makes NH and other programs fail</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># restrict all usage of performance events to the CAP_PERFMON capability</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.perf_event_paranoid&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Network</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># protect against SYN flood attacks (denial of service attack)</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_syncookies&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># protection against TIME-WAIT assassination</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_rfc1337&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># enable source validation of packets received (prevents IP spoofing)</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.default.rp_filter&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.rp_filter&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.accept_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.default.accept_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.secure_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.default.secure_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Protect against IP spoofing</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.all.accept_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.default.accept_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.send_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.default.send_redirects&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># prevent man-in-the-middle attacks</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.icmp_echo_ignore_all&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ignore ICMP request, helps avoid Smurf attacks</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.forwarding&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.default.accept_source_route&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.conf.all.accept_source_route&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.all.accept_source_route&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.default.accept_source_route&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Reverse path filtering causes the kernel to do source validation of</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.all.forwarding&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.all.accept_ra&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv6.conf.default.accept_ra&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>## TCP hardening</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Prevent bogus ICMP errors from filling up logs.</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.icmp_ignore_bogus_error_responses&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Disable TCP SACK</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_sack&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_dsack&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_fack&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Userspace</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># restrict usage of ptrace</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.yama.ptrace_scope&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ASLR memory protection (64-bit systems)</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;vm.mmap_rnd_bits&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;vm.mmap_rnd_compat_bits&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># only permit symlinks to be followed when outside of a world-writable sticky directory</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fs.protected_symlinks&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fs.protected_hardlinks&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Prevent creating files in potentially attacker-controlled environments</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fs.protected_fifos&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fs.protected_regular&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Randomize memory</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.randomize_va_space&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Exec Shield (Stack protection)</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kernel.exec-shield&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>## TCP optimization</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># TCP Fast Open is a TCP extension that reduces network latency by packing</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># data in the sender’s initial TCP SYN. Setting 3 = enable TCP Fast Open for</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># both incoming and outgoing connections:</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_fastopen&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Bufferbloat mitigations + slight improvement in throughput &amp; latency</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.ipv4.tcp_congestion_control&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bbr&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net.core.default_qdisc&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cake&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><blockquote><p>❗ Note: The above settings are fairly aggressive and can break common
programs, read the comment warnings.</p></blockquote><h2 id=hardening-boot-parameters>Hardening Boot Parameters<a hidden class=anchor aria-hidden=true href=#hardening-boot-parameters>#</a></h2><p><code>boot.kernelParams</code> can be used to set additional kernel command line arguments
at boot time. It can only be used for built-in modules.</p><p>You can find the following settings in the above guide in the
<a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#boot-parameters>Boot parameters section</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># boot.nix</span>
</span></span><span style=display:flex><span>      boot<span style=color:#f92672>.</span>kernelParams <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#75715e># make it harder to influence slab cache layout</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;slab_nomerge&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># enables zeroing of memory during allocation and free time</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># helps mitigate use-after-free vulnerabilaties</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;init_on_alloc=1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;init_on_free=1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># randomizes page allocator freelist, improving security by</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># making page allocations less predictable</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;page_alloc.shuffel=1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># enables Kernel Page Table Isolation, which mitigates Meltdown and</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># prevents some KASLR bypasses</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;pti=on&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># randomizes the kernel stack offset on each syscall</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># making attacks that rely on a deterministic stack layout difficult</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;randomize_kstack_offset=on&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># disables vsyscalls, they&#39;ve been replaced with vDSO</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;vsyscall=none&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># disables debugfs, which exposes sensitive info about the kernel</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;debugfs=off&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># certain exploits cause an &#34;oops&#34;, this makes the kernel panic if an &#34;oops&#34; occurs</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;oops=panic&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># only alows kernel modules that have been signed with a valid key to be loaded</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># making it harder to load malicious kernel modules</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># can make VirtualBox or Nvidia drivers unusable</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;module.sig_enforce=1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># prevents user space code excalation</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;lockdown=confidentiality&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;rd.udev.log_level=3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;udev.log_priority=3&#34;</span>
</span></span><span style=display:flex><span>      ];
</span></span></code></pre></div><p>This is a thoughtful start to hardening boot parameters, there are more
recommendations in the guide.</p><p>Kernel modules for hardware devices are generally loaded automatically by
<code>udev</code>. You can force a module to be loaded via <code>boot.kernelModules</code>.</p><p><a href=https://nixos.org/manual/nixos/stable/options#opt-boot.blacklistedKernelModules>boot.blacklistedKernelModules</a>:
List of names of kernel modules that should not be loaded automatically by the
hardware probing code.</p><p>You can find the following settings in the
<a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#kasr-kernel-modules>Blacklisting Kernel Modules Section</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>      boot<span style=color:#f92672>.</span>blacklistedKernelModules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#75715e># Obscure networking protocols</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dccp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sctp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rds&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;tipc&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;n-hdlc&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ax25&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;netrom&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x25&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rose&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;decnet&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;econet&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;af_802154&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ipx&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;appletalk&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;psnap&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;p8023&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;p8022&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;can&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;atm&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Various rare filesystems</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cramfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;freevxfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;jffs2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hfsplus&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;udf&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Not so rare filesystems</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;squashfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;cifs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;nfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;nfsv3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;nfsv4&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;ksmbd&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;gfs2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># vivid driver is only useful for testing purposes and has been the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># cause of privilege escalation vulnerabilities</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;vivid&#34;</span>
</span></span><span style=display:flex><span>      ];
</span></span></code></pre></div><p>As with the <code>kernelParameters</code> above, there are more suggestions in the guide, I
have used the above parameters along with the commented out ones and had no
issues.</p><h2 id=hardening-systemd>Hardening Systemd<a hidden class=anchor aria-hidden=true href=#hardening-systemd>#</a></h2><figure><img loading=lazy src=/images/hacker.png alt=Hacker width=1000></figure><p><code>systemd</code> is the core &ldquo;init system&rdquo; and service manager that controls how
services, daemons, and basic system processes are started, stopped and
supervised on modern Linux distributions, including NixOS. It provides a suite
of basic building blocks for a Linux system as well as a system and service
manager that runs as <code>PID 1</code> and starts the rest of the system.</p><p>Because it launches and supervises almost all system services, hardening systemd
means raising the baseline security of your entire system.</p><p><code>dbus-broker</code> is generally considered more secure and robust but isn&rsquo;t the
default as of yet. To set <code>dbus-broker</code> as the default:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>  users<span style=color:#f92672>.</span>groups<span style=color:#f92672>.</span>netdev <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>  services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    dbus<span style=color:#f92672>.</span>implementation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;broker&#34;</span>;
</span></span><span style=display:flex><span>    logrotate<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    journald <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      storage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;volatile&#34;</span>; <span style=color:#75715e># Store logs in memory</span>
</span></span><span style=display:flex><span>      upload<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>; <span style=color:#75715e># Disable remote log upload (the default)</span>
</span></span><span style=display:flex><span>      extraConfig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SystemMaxUse=500M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SystemMaxFileSize=50M
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><ul><li><p><code>dbus-broker</code> is more resilient to resource exhaustion attacks and integrates
better with Linux security features.</p></li><li><p>Setting <code>storage = "volatile"</code> tells journald to keep log data only in memory.
There is a tradeoff though, If you need long-term auditing or troubleshooting
after a reboot, this will not preserve system logs.</p></li><li><p><code>upload.enable</code> is for forwarding log messages to remote servers, setting this
to false prevents accidental leaks of potentially sensitive or internal system
information.</p></li><li><p>Enabling <code>logrotate</code> prevents your disk from filling with excessive
<strong>legacy/service</strong> log files. These are the classic plain-text logs.</p></li><li><p>Systemd uses <code>journald</code> which stores logs in a binary format</p></li></ul><p>You can check the security status with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemd-analyze security
</span></span><span style=display:flex><span><span style=color:#75715e># or for a detailed view of individual services security posture</span>
</span></span><span style=display:flex><span>systemd-analyze security NetworkManager
</span></span></code></pre></div><p>Further reading on systemd:</p><ul><li><p><a href=https://systemd.io/>systemd.io</a></p></li><li><p><a href=https://0pointer.de/blog/projects/systemd.html>Rethinking PID 1</a></p></li><li><p><a href=https://0pointer.de/blog/projects/the-biggest-myths.html>Biggest Myths about Systemd</a></p></li></ul><p>The following is a repo containing many of the Systemd hardening settings in
NixOS format:</p><p><a href=https://github.com/wallago/nix-system-services-hardened>nix-system-services-hardened</a></p><p>For example, to harden bluetooth you could add the following to your
<code>configuration.nix</code> or equivalent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>systemd<span style=color:#f92672>.</span>services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      bluetooth<span style=color:#f92672>.</span>serviceConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      ProtectKernelTunables <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      ProtectKernelModules <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      ProtectKernelLogs <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      ProtectHostname <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      ProtectControlGroups <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      ProtectProc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;invisible&#34;</span>;
</span></span><span style=display:flex><span>      SystemCallFilter <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;~@obsolete&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;~@cpu-emulation&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;~@swap&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;~@reboot&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;~@mount&#34;</span>
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>      SystemCallArchitectures <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;native&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see from above, you typically use the <code>serviceConfig</code> attribute to
harden settings for systemd services.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemd-analyze security bluetooth
</span></span><span style=display:flex><span>→ Overall exposure level <span style=color:#66d9ef>for</span> bluetooth.service: 3.3 OK 🙂
</span></span></code></pre></div><h2 id=lynis-and-other-tools>Lynis and other tools<a hidden class=anchor aria-hidden=true href=#lynis-and-other-tools>#</a></h2><p>Lynis is a security auditing tool for systems based on UNIX like Linux, macOS,
BSD, and others.&ndash;<a href=https://github.com/CISOfy/lynis>lynis repo</a></p><p>Installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>lynis
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>chkrootkit
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>clamav
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>aide
</span></span><span style=display:flex><span> ];
</span></span></code></pre></div><p>Usage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo lynis show commands
</span></span><span style=display:flex><span><span style=color:#75715e># Output:</span>
</span></span><span style=display:flex><span>Commands:
</span></span><span style=display:flex><span>lynis audit
</span></span><span style=display:flex><span>lynis configure
</span></span><span style=display:flex><span>lynis generate
</span></span><span style=display:flex><span>lynis show
</span></span><span style=display:flex><span>lynis update
</span></span><span style=display:flex><span>lynis upload-only
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo lynis audit system
</span></span><span style=display:flex><span><span style=color:#75715e># Output:</span>
</span></span><span style=display:flex><span>  Lynis security scan details:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Hardening index : <span style=color:#ae81ff>79</span> <span style=color:#f92672>[</span><span style=color:#75715e>###############     ]</span>
</span></span><span style=display:flex><span>  Tests performed : <span style=color:#ae81ff>234</span>
</span></span><span style=display:flex><span>  Plugins enabled : <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Components:
</span></span><span style=display:flex><span>  - Firewall               <span style=color:#f92672>[</span>V<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  - Malware scanner        <span style=color:#f92672>[</span>V<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Scan mode:
</span></span><span style=display:flex><span>  Normal <span style=color:#f92672>[</span>V<span style=color:#f92672>]</span>  Forensics <span style=color:#f92672>[</span> <span style=color:#f92672>]</span>  Integration <span style=color:#f92672>[</span> <span style=color:#f92672>]</span>  Pentest <span style=color:#f92672>[</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Lynis modules:
</span></span><span style=display:flex><span>  - Compliance status      <span style=color:#f92672>[</span>?<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  - Security audit         <span style=color:#f92672>[</span>V<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  - Vulnerability scan     <span style=color:#f92672>[</span>V<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li><p>The &ldquo;Lynis hardening index&rdquo; is an overall impression on how well a system is
hardened. However, this is just an indicator on measures taken - not a
percentage of how safe a system might be. A score over 75 typically indicates
a system with more than average safety measures implemented.</p></li><li><p>Lynis will give you more recommendations for securing your system as well.</p></li></ul><p>Example cron job for <code>chkrootkit</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>cron <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># messages.enable = true;</span>
</span></span><span style=display:flex><span>    systemCronJobs <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e># Every Sunday at 2:10 AM, run chkrootkit as root, log output for review</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;10 2 * * 0 root </span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>chkrootkit<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/chkrootkit | logger -t chkrootkit&#34;</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The above cron job will use <code>chkrootkit</code> to automatically scan for known rootkit
signatures. It can detect hidden processes and network connections.</p><p>I got the recommendation for <code>clamav</code> from the Paranoid NixOS blog post and the
others help with compliance for <code>lynis</code>.</p><h2 id=securing-ssh>Securing SSH<a hidden class=anchor aria-hidden=true href=#securing-ssh>#</a></h2><blockquote><p><strong>Security information</strong>: Changing SSH configuration settings can
significantly impact the security of your system(s). It is crucial to have a
solid understanding of what you are doing before making any adjustments. Avoid
blindly copying and pasting examples, including those from this Wiki page,
without conducting a thorough analysis. Failure to do so may compromise the
security of your system(s) and lead to potential vulnerabilities. Take the
time to comprehend the implications of your actions and ensure that any
changes made are done thoughtfully and with care. &ndash;NixOS Wiki</p></blockquote><blockquote><p>❗ NOTE: I am going to show two approaches for SSH authentication. You should
typically choose <strong>one</strong>:</p></blockquote><ol><li>Use normal SSH keys generated with <code>ssh-keygen</code>, this is recommended unless
you have a good reason for not using it.</li></ol><p><strong>OR</strong></p><ol start=2><li>Use a GPG key with <code>gpg-agent</code> (which acts as your SSH agent). Complex, and
harder to understand in my opinion.</li></ol><p>My setup caused conflicts when enabling <code>programs.ssh.startAgent</code> so I chose
<code>gpg-agent</code> personally.</p><p>There are situations where you are required to use one or the other like for
headless CI/CD environments, <code>ssh-keygen</code> is required.</p><p>Further reading:</p><ul><li><p><a href=https://wiki.archlinux.org/title/OpenSSH>Arch Wiki OpenSSH</a></p></li><li><p><a href=https://wiki.gentoo.org/wiki/GnuPG>Gentoo GnuPG</a></p></li><li><p><a href=https://rgoulter.com/blog/posts/programming/2022-06-10-a-visual-explanation-of-gpg-subkeys.html>A Visual Explanation of GPG Subkeys</a></p></li><li><p><a href=https://blog.stribik.technology/2015/01/04/secure-secure-shell.html>Secure Secure Shell</a></p></li></ul><h2 id=key-generation>Key generation<a hidden class=anchor aria-hidden=true href=#key-generation>#</a></h2><h3 id=ssh-keygen>ssh-keygen<a hidden class=anchor aria-hidden=true href=#ssh-keygen>#</a></h3><p>The <code>ed25519</code> algorithm is significantly faster and more secure when compared to
<code>RSA</code>. You can also specify the key derivation function (KDF) rounds to
strengthen protection even more.</p><p>For example, to generate a strong key for MdBook:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-keygen -t ed25519 -a <span style=color:#ae81ff>32</span> -f ~/.ssh/id_ed25519_github_<span style=color:#66d9ef>$(</span>date +%Y-%m-%d<span style=color:#66d9ef>)</span> -C <span style=color:#e6db74>&#34;SSH Key for MdBook&#34;</span>
</span></span></code></pre></div><ul><li><p><code>-t</code> is for type</p></li><li><p><code>-a 32</code> sets the number of KDF rounds. The standard is usually good enough,
adding extra rounds can make it harder to brute-force.</p></li><li><p><code>-f</code> is for filename</p></li></ul><p><strong>OR</strong></p><h2 id=install-gnupg-and-gpg-agent-for-home-manager>Install GNUPG and gpg-agent for Home Manager<a hidden class=anchor aria-hidden=true href=#install-gnupg-and-gpg-agent-for-home-manager>#</a></h2><p><strong>PGP (Pretty Good Privacy)</strong> and <strong>GPG (GNU Privacy Guard)</strong>. While distinct,
they are deeply interconnected and, for the rest of this section, I&rsquo;ll use the
terms interchangeably.</p><p><strong>PGP</strong> was the original, groundbreaking software that brought robust public-key
cryptography to the masses. It set the standard for secure email communication.
However, PGP later became a commercial product.</p><p>To provide a free and open-source alternative that anyone could use and inspect,
<strong>GPG</strong> was created. Crucially, <strong>GPG</strong> is a complete implementation of the
OpenPGP standard. This open standard acts as a universal language for encryption
and digital signatures.</p><p><strong>What’s safe to share?</strong></p><ul><li><p>Your public key (used to encrypt files and verify signatures)</p></li><li><p>Your key ID (identifies your key, useful for sharing public keys or configs)</p></li></ul><p><strong>What must never be shared?</strong></p><ul><li><p>Your private (secret) key, usually in your <code>~/.gnupg/private-keys-v1.d/</code>
directory.</p></li><li><p>Your passphrase for your private key.</p></li></ul><p>Home Manager module with <code>gpg-agent</code>, <code>gnupg</code>, and <code>pinentry-gnome3</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># gpg-agent.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: {
</span></span><span style=display:flex><span>  options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    custom<span style=color:#f92672>.</span>pgp <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkEnableOption {
</span></span><span style=display:flex><span>        description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enable PGP Gnupgp&#34;</span>;
</span></span><span style=display:flex><span>        default <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkIf config<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>pgp<span style=color:#f92672>.</span>enable {
</span></span><span style=display:flex><span>    services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>## Enable gpg-agent with ssh support</span>
</span></span><span style=display:flex><span>      gpg-agent <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        enableSshSupport <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        enableZshIntegration <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        pinentryPackage <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>pinentry-gnome3;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>## We will put our keygrip here</span>
</span></span><span style=display:flex><span>      gpg-agent<span style=color:#f92672>.</span>sshKeys <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [pkgs<span style=color:#f92672>.</span>gnupg];
</span></span><span style=display:flex><span>    programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      gpg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Enable GnuPG</span>
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># homedir = &#34;/home/userName/.config/gnupg&#34;;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>The default path is <code>~/.gnupg</code>, if you prefer placing it in the <code>~/.config</code>
directory uncomment the <code>homedir</code> line and change <code>userName</code> to your username.</p></li><li><p>I use hyprland so <code>pinentry-gnome3</code> works for me, there is also the following
options for this attribute:</p></li><li><p><code>pinentry-tty</code></p></li><li><p><code>pinentry-qt</code></p></li><li><p><code>pinentry-gtk2</code></p></li></ul><p>And more, research what you need and use the correct one.</p><p>Enable in your <code>home.nix</code> or equivalent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># home.nix</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./gpg-agent.nix</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>custom<span style=color:#f92672>.</span>pgp<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span></code></pre></div><p><code>gpg --full-generate-key</code> can be used to generate a basic keypair, adding
<code>--expert</code> gives more options and capabilities needed for <code>gpg-agent</code>.</p><p>To generate a pgp key you can do the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --expert --full-generate-key
</span></span></code></pre></div><ul><li><p>Choose the default (11) ECC (set your own capabilities)</p></li><li><p>Choose <code>A</code> for Authenticate capabilities, which is the only setting required
for this. Additional subkeys may be created for encryption, sign, and/or
authentication capabilities.</p></li><li><p>Choose (1) Default Curve 25519</p></li><li><p>Give it a name and description</p></li><li><p>Give it an expiration date, 1y is common</p></li><li><p>Use a strong passphrase or password</p></li></ul><p>If you see a warning about incorrect permissions, you can run the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> ~/.gnupg
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> ~/.gnupg/*
</span></span></code></pre></div><p>Verify:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -ld ~/.gnupg
</span></span><span style=display:flex><span><span style=color:#75715e># Should show: drwx------</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ls -l ~/.gnupg
</span></span><span style=display:flex><span><span style=color:#75715e># Files should show: -rw-------</span>
</span></span></code></pre></div><p>After fixing, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --list-keys
</span></span></code></pre></div><p>The warning should be gone.</p><p><strong>List your key and copy the key ID</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --list-secret-keys --keyid-format LONG
</span></span></code></pre></div><p>Output example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sec   ed25519/ABCDEF1234567890 2025-07-31 <span style=color:#f92672>[</span>SC<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      ABC123ABC123ABC123ABC123ABC123ABC123ABC1
</span></span><span style=display:flex><span>uid           <span style=color:#f92672>[</span>ultimate<span style=color:#f92672>]</span> Your Name &lt;you@example.com&gt;
</span></span><span style=display:flex><span>ssb   ed25519/1234567890ABCDEF 2025-07-31 <span style=color:#f92672>[</span>S<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>Take the part after <code>/</code> on the <code>sec</code> line (e.g., <code>ABCDEF1234567890</code>)</li></ul><p><strong>Export the public key for GitHub</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --armor --export ABCDEF1234567890
</span></span></code></pre></div><ul><li>Copy everything from
<code>-----BEGIN PGP PUBLIC KEY BLOCK----- to -----END PGP PUBLIC KEY BLOCK-----</code>.</li></ul><p><strong>Add to GitHub</strong></p><ol><li><p>Go to Settings, SSH and GPG keys, New GPG key</p></li><li><p>Paste the exported block.</p></li></ol><p><strong>Add Keygrip to <code>sshcontrol</code> for gpg-agent</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --list-secret-keys --with-keygrip --with-colons
</span></span></code></pre></div><ul><li>Copy the <code>grp</code> line - that&rsquo;s your keygrip</li></ul><p>Add the keygrip number to your <code>gpg-agent.sshKeys</code> and rebuild:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>gpg-agent<span style=color:#f92672>.</span>sshKeys <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;6BD11826F3845BC222127FE3D22C92C91BB3FB32&#34;</span>];
</span></span></code></pre></div><ul><li>By itself, a keygrip cannot be used to reconstruct your private key. It&rsquo;s
derived from the public key material, not from the secret key itself so it&rsquo;s
safe to version control. Don&rsquo;t put your keygrip in a public repo if you don&rsquo;t
want people to know you use that key for signing/authentication. It&rsquo;s not a
security risk, but it leaks a tiny bit of metadata.</li></ul><p>The following article mentions the keygrip being computed from public elements
of the key:</p><ul><li><p><a href=https://gnupg-users.gnupg.narkive.com/q5JtahdV/gpg-agent-what-is-a-keygrip>gnupg-users what-is-a-keygrip</a></p></li><li><p>Never version-control your private key files or <code>.gnupg</code> contents.</p></li></ul><p>Add the following to your shell config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># zsh.nix</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>initContent <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># GPG Agent</span>
</span></span><span style=display:flex><span>        export GPG_TTY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tty<span style=color:#66d9ef>)</span> <span style=color:#75715e># which terminal to use for passphrase prompts</span>
</span></span><span style=display:flex><span>        export SSH_AUTH_SOCK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>gpgconf --list-dirs agent-ssh-socket<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#75715e># points SSH_AUTH_SOCK to the socket created by gpg-agent</span>
</span></span><span style=display:flex><span>        gpg-connect-agent updatestartuptty /bye <span style=color:#75715e># refresh gpg-agent so it knows which terminal is active</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Optional: confirm it&#39;s set correctly</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;SSH_AUTH_SOCK is set to: </span>$SSH_AUTH_SOCK<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span></code></pre></div><p>Rebuild and then restart gpg-agent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpgconf --kill gpg-agent
</span></span><span style=display:flex><span>gpgconf --launch gpg-agent
</span></span></code></pre></div><p>Test, these should match:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$SSH_AUTH_SOCK<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># output</span>
</span></span><span style=display:flex><span>/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76534j/S.gpg-agent.ssh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gpgconf --list-dirs agent-ssh-socket
</span></span><span style=display:flex><span><span style=color:#75715e># output</span>
</span></span><span style=display:flex><span>/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76834j/S.gpg-agent.ssh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-add -L
</span></span><span style=display:flex><span><span style=color:#75715e># Copy the entire following line:</span>
</span></span><span style=display:flex><span>ssh-ed25519 AABBC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I <span style=color:#f92672>(</span>none<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>Mine shows <code>(none)</code> because I left the comment field blank when creating the
key and doesn&rsquo;t affect functionality.</li></ul><p>Then, in your server&rsquo;s NixOS configuration (e.g., <code>configuration.nix</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>services<span style=color:#f92672>.</span>openssh <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  authorizedKeys<span style=color:#f92672>.</span>keys <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><blockquote><p>❗ NOTE: Only the <strong>public</strong> key goes here, it&rsquo;s safe to commit to version
control. If you prefer not to hardcode it in the config, you can reference it
from a <code>.pub</code> file in your repo and read it with
<code>builtins.readFile ./mykey.pub</code></p></blockquote><p>Rebuild your system and test an SSH connection into the server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -p &lt;your-port&gt; user@hostname
</span></span></code></pre></div><ul><li><code>&lt;your-port></code> is often <code>22</code> so it would be something like:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -p <span style=color:#ae81ff>22</span> bill@xps
</span></span></code></pre></div><h2 id=encrypt-a-file-with-pgp>Encrypt a File with PGP<a hidden class=anchor aria-hidden=true href=#encrypt-a-file-with-pgp>#</a></h2><h3 id=list-your-keys-and-get-the-key-id>List your keys and get the key ID<a hidden class=anchor aria-hidden=true href=#list-your-keys-and-get-the-key-id>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --list-keys --keyid-format LONG
</span></span></code></pre></div><p>Example output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pub   rsa4096/ABCDEF1234567890 2024-01-01 <span style=color:#f92672>[</span>SC<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>uid           <span style=color:#f92672>[</span>ultimate<span style=color:#f92672>]</span> Your Name &lt;you@example.com&gt;
</span></span><span style=display:flex><span>sub   rsa4096/1234567890ABCDEF 2024-01-01 <span style=color:#f92672>[</span>E<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li><p>The part after the slash on the <code>pub</code> line is your key ID (<code>ABCDEF1234567890</code>
in the example)</p></li><li><p>You can also use your email or name to refer to the key in most commands.</p></li></ul><h3 id=encrypt-a-file-for-yourself>Encrypt a file for yourself<a hidden class=anchor aria-hidden=true href=#encrypt-a-file-for-yourself>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;This file will be encrypted&#34;</span> &gt; file.txt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --encrypt --recipient ABCDEF1234567890 file.txt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls
</span></span><span style=display:flex><span>│  <span style=color:#ae81ff>7</span> │ file.txt            │ file │     <span style=color:#ae81ff>28</span> B │ now           │
</span></span><span style=display:flex><span>│  <span style=color:#ae81ff>8</span> │ file.txt.gpg        │ file │    <span style=color:#ae81ff>191</span> B │ now           │
</span></span></code></pre></div><p><code>gpg --encrypt</code> doesn&rsquo;t modify the original file. It creates a new encrypted
file by default with <code>gpg</code> amended to the filename.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gpg --decrypt file.txt.gpg
</span></span><span style=display:flex><span>gpg: encrypted with cv25519 key, ID 0x4AC131B80CEC833E, created 2025-07-31
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;GPG Key &lt;sayls8@proton.me&gt;&#34;</span>
</span></span><span style=display:flex><span>This file will be encrypted
</span></span></code></pre></div><ul><li>You will be asked for the passphrase you used when creating the key in order
to decrypt the file.</li></ul><p>There is much more you can do with PGP beyond simple file encryption:</p><ul><li><p>Sign files and commits: Prove that content really came from you.</p></li><li><p>Encrypt for multiple recipients: Share encrypted data with teammates using
their public keys.</p></li><li><p>Use smartcards or YubiKeys: Store your private key on hardware for extra
security.</p></li><li><p>Verify software releases: Check that downloaded files are genuine using the
developer’s signature.</p></li><li><p>Integrate with Git: Sign tags and commits so others can trust your repository
history.</p></li></ul><p>This guide only scratches the surface — once your PGP key and <code>gpg-agent</code> are
set up, these capabilities become easy to add to your workflow.</p><h3 id=openssh-server>OpenSSH Server<a hidden class=anchor aria-hidden=true href=#openssh-server>#</a></h3><p>First of all, if you don&rsquo;t use SSH don&rsquo;t enable it in the first place. If you do
use SSH, it&rsquo;s important to understand what that opens you up to.</p><p>The following are some recommendations from Mozilla on OpenSSH:</p><ul><li><a href=https://infosec.mozilla.org/guidelines/openssh.html>Mozilla OpenSSH guidelines</a></li></ul><p>The following OpenSSH setup is based on the above guidelines with strong
algorithms, and best practices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      fail2ban <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        maxretry <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>        bantime <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1h&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e># ignoreIP = [</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;172.16.0.0/12&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;192.168.0.0/16&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;2601:881:8100:8de0:31e6:ac52:b5be:462a&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;matrix.org&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># &#34;app.element.io&#34; # don&#39;t ratelimit matrix users</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># ];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bantime-increment <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># Enable increment of bantime after each violation</span>
</span></span><span style=display:flex><span>          multipliers <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1 2 4 8 16 32 64 128 256&#34;</span>;
</span></span><span style=display:flex><span>          maxtime <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;168h&#34;</span>; <span style=color:#75715e># Do not ban for more than 1 week</span>
</span></span><span style=display:flex><span>          overalljails <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># Calculate the bantime based on all the violations</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      openssh <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          PasswordAuthentication <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          PermitEmptyPasswords <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          PermitTunnel <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          UseDns <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          KbdInteractiveAuthentication <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          X11Forwarding <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>xserver<span style=color:#f92672>.</span>enable;
</span></span><span style=display:flex><span>          MaxAuthTries <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>          MaxSessions <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>          ClientAliveInterval <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span>;
</span></span><span style=display:flex><span>          ClientAliveCountMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>          AllowUsers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;your-user&#34;</span>];
</span></span><span style=display:flex><span>          TCPKeepAlive <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          AllowTcpForwarding <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          AllowAgentForwarding <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          LogLevel <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;VERBOSE&#34;</span>;
</span></span><span style=display:flex><span>          PermitRootLogin <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;no&#34;</span>;
</span></span><span style=display:flex><span>          KexAlgorithms <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;curve25519-sha256@libssh.org&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ecdh-sha2-nistp521&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ecdh-sha2-nistp384&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ecdh-sha2-nistp256&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;diffie-hellman-group-exchange-sha256&#34;</span>
</span></span><span style=display:flex><span>          ];
</span></span><span style=display:flex><span>          Ciphers <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;chacha20-poly1305@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aes256-gcm@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aes128-gcm@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aes256-ctr&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aes192-ctr&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;aes128-ctr&#34;</span>
</span></span><span style=display:flex><span>          ];
</span></span><span style=display:flex><span>          Macs <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hmac-sha2-512-etm@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hmac-sha2-256-etm@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;umac-128-etm@openssh.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hmac-sha2-512&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hmac-sha2-256&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;umac-128@openssh.com&#34;</span>
</span></span><span style=display:flex><span>          ];
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        hostKeys <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/etc/ssh/ssh_host_ed25519_key&#34;</span>;
</span></span><span style=display:flex><span>            type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ed25519&#34;</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>TCP port 22 (ssh) is opened automatically if the SSH daemon is enabled
(<code>services.openssh.enable = true;</code>)</p><p>Much of the SSH hardening settings came from
<a href=https://ryanseipp.com/post/nixos-secure-ssh/>ryanseipp&rsquo;s secure-ssh Guide</a>
with some additions of my own.</p><p>Fail2Ban is an intrusion prevention software framework. It&rsquo;s designed to prevent
brute-force attacks by scanning log files for suspicious activity, such as
repeated failed login attempts.</p><p>OpenSSH is the primary tool for secure remote access for NixOS. Enabling it
activates the OpenSSH server on the system, allowing incoming SSH connections.</p><p>The above configuration is a robust setup for securing an SSH server by:</p><ul><li><p>Preventing brute-force attacks with Fail2Ban</p></li><li><p>Eliminating password authentication in favor of more secure SSH keys</p></li><li><p>Restricting user access and preventing root login</p></li><li><p>Disabling potentially risky forwarding features (tunnel, TCP, agent)</p></li><li><p>Enforce the use of strong, modern cryptographic algorithms for all SSH
communications.</p></li><li><p>Enhanced logging for better auditing.</p></li></ul><p>Further Reading:</p><ul><li><p><a href=https://www.openssh.com/>OpenSSH</a></p></li><li><p><a href=https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server>DigitalOcean how fail2ban works</a></p></li></ul><h2 id=encrypted-secrets>Encrypted Secrets<a hidden class=anchor aria-hidden=true href=#encrypted-secrets>#</a></h2><p>Never store secrets in plain text in repositories. Use something like
<a href=https://github.com/Mic92/sops-nix>sops-nix</a>, which lets you keep encrypted
secrets under version control declaratively.</p><p>Another option is <a href=https://github.com/ryantm/agenix>agenix</a></p><ul><li><a href=https://wiki.nixos.org/wiki/Agenix>NixOS Wiki Agenix</a></li></ul><h3 id=sops-nix-guide>Sops-nix Guide<a hidden class=anchor aria-hidden=true href=#sops-nix-guide>#</a></h3><p>Protect your secrets, the following guide is on setting up Sops on NixOS:
<a href=https://saylesss88.github.io/installation/enc/sops-nix.html>Sops Encrypted Secrets</a></p><h2 id=auditd>Auditd<a hidden class=anchor aria-hidden=true href=#auditd>#</a></h2><p>To enable the Linux Audit Daemon (<code>auditd</code>) and define a very basic rule set,
you can use the following NixOS configuration. This example demonstrates how to
log every program execution (<code>execve</code>) on a 64-bit architecture.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># modules/security/auditd-minimal.nix (or directly in configuration.nix)</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e># start as early in the boot process as possible</span>
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>kernelParams <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;audit=1&#34;</span>];
</span></span><span style=display:flex><span>  security<span style=color:#f92672>.</span>auditd<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  security<span style=color:#f92672>.</span>audit<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  security<span style=color:#f92672>.</span>audit<span style=color:#f92672>.</span>rules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#75715e># Log all program executions on 64-bit architecture</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;-a exit,always -F arch=b64 -S execve&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p><code>audit=1</code> Enables auditing at the kernel level very early in the boot process.
Without this, some events could be missed.</p></li><li><p><code>security.auditd.enable = true;</code> Ensures the <code>auditd</code> userspace daemon is
started.</p></li><li><p>While often enabled together, <code>security.audit.enable</code> specifically refers to
enabling the NixOS module for audit rules generation.</p></li><li><p><code>execve</code> (program executions)</p></li><li><p>This is just a basic configuration, there is much more that can be tracked.</p></li></ul><h2 id=usb-port-protection>USB Port Protection<a hidden class=anchor aria-hidden=true href=#usb-port-protection>#</a></h2><p>It&rsquo;s important to protect your USB ports to prevent BadUSB attacks, data
exfiltration, unauthorized device access, malware injection, etc.</p><p>To get a list of your connected USB devices you can use <code>lsusb</code> from the
<code>usbutils</code> package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lsusb
</span></span></code></pre></div><p>To list the devices recognized by USBGuard, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usbguard list-devices
</span></span></code></pre></div><ul><li><a href=https://mynixos.com/options/services.usbguard>MyNixOS services.usbguard</a></li></ul><p>Change <code>your-user</code> to your username:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># usbguard.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> (lib) mkIf;
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>usbguard;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>usbguard <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkEnableOption <span style=color:#e6db74>&#34;usbguard&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> mkIf cfg<span style=color:#f92672>.</span>enable {
</span></span><span style=display:flex><span>    services<span style=color:#f92672>.</span>usbguard <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      IPCAllowedUsers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;root&#34;</span> <span style=color:#e6db74>&#34;your-user&#34;</span>];
</span></span><span style=display:flex><span>    <span style=color:#75715e># presentDevicePolicy refers to how to treat USB devices that are already connected when the daemon starts</span>
</span></span><span style=display:flex><span>      presentDevicePolicy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allow&#34;</span>;
</span></span><span style=display:flex><span>      rules <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # allow `only` devices with mass storage interfaces (USB Mass Storage)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        allow with-interface equals { 08:*:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # allow mice and keyboards
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # allow with-interface equals { 03:*:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Reject devices with suspicious combination of interfaces
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        reject with-interface all-of { 08:*:* 03:00:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        reject with-interface all-of { 08:*:* 03:01:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        reject with-interface all-of { 08:*:* e0:*:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        reject with-interface all-of { 08:*:* 02:*:* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> [pkgs<span style=color:#f92672>.</span>usbguard];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The above settings can be found in
<a href=https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/security_guide/sec-using-usbguard>RedHat UsbGuard</a></p><p>The only <code>allow</code> rule is for devices with <strong>only</strong> mass storage interfaces
(<code>08:*:*</code>) i.e., USB Mass storage devices, devices like keyboards and mice
(which use interface class <code>03:*:*</code>) implicitly <strong>not allowed</strong>.</p><p>The <code>reject</code> rules reject devices with a suspicious combination of interfaces. A
USB drive that implements a keyboard or a network interface is very suspicious,
these <code>reject</code> rules prevent that.</p><p>The <code>presentDevicePolicy = "allow";</code> allows any device that is present at daemon
start up even if they&rsquo;re not explicitly allowed. However, newly plugged in
devices must match an <code>allow</code> rule or get denied implicitly.</p><p>The <code>presentDevicePolicy</code> should be one of: # one of <code>"apply-policy"</code>(default,
evaluate the rule set for every present device), <code>"block"</code>, <code>"reject"</code>, <code>"keep"</code>
(keep whatever state the device is currently in), or <code>"allow"</code>, which is used in
the example.</p><p>There is also the
<a href=https://github.com/Cropi/usbguard-notifier>usbguard-notifier</a></p><p>And enable it with the following in your <code>configuration.nix</code> or equivalent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./usbguard.nix</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>usbguard<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span></code></pre></div><blockquote><p>❗ If you are ever unsure about a setting that you want to harden and think
that it could possibly break your system you can always use a specialisation
reversing the action and choose it&rsquo;s generation at boot up. For example, to
force-reverse the above settings you could:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>specialisation<span style=color:#f92672>.</span>no-usbguard<span style=color:#f92672>.</span>configuration <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    services<span style=color:#f92672>.</span>usbguard<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkForce <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li>This is a situation where I recommend this, it&rsquo;s easy to lock yourself out
of your keyboard, mouse, etc. when trying to configure this.</li></ul></blockquote><p>Further Reading:</p><ul><li><p><a href=https://www.ninjaone.com/it-hub/endpoint-security/what-is-badusb/>NinjaOne BadUSB</a></p></li><li><p><a href=https://usbguard.github.io/>USBGuard</a></p></li><li><p><a href=https://www.cyberciti.biz/security/how-to-protect-linux-against-rogue-usb-devices-using-usbguard/>NixCraft USBGuard</a></p></li></ul><h2 id=doas-over-sudo>Doas over sudo<a hidden class=anchor aria-hidden=true href=#doas-over-sudo>#</a></h2><p>For a more minimalist version of <code>sudo</code> with a smaller codebase and attack
surface, consider <code>doas</code>. Replace <code>userName</code> with your username:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># doas.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span> <span style=color:#75715e># Add pkgs if you need to access user information</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>doas;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>doas <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkEnableOption <span style=color:#e6db74>&#34;doas&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkIf cfg<span style=color:#f92672>.</span>enable {
</span></span><span style=display:flex><span>    <span style=color:#75715e># Disable sudo</span>
</span></span><span style=display:flex><span>    security<span style=color:#f92672>.</span>sudo<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Enable and configure `doas`.</span>
</span></span><span style=display:flex><span>    security<span style=color:#f92672>.</span>doas <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      extraRules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#75715e># Grant doas access specifically to your user</span>
</span></span><span style=display:flex><span>          users <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;userName&#34;</span>]; <span style=color:#75715e># &lt;--- Only give access to your user</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># persist = true; # Convenient but less secure</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># noPass = true;    # Convenient but even less secure</span>
</span></span><span style=display:flex><span>          keepEnv <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># Often necessary</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># Optional: You can also specify which commands they can run, e.g.:</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># cmd = &#34;ALL&#34;; # Allows running all commands (default if not specified)</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># cmd = &#34;/run/current-system/sw/bin/nixos-rebuild&#34;; # Only allow specific command</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add an alias to the shell for backward-compat and convenience.</span>
</span></span><span style=display:flex><span>    environment<span style=color:#f92672>.</span>shellAliases <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      sudo <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;doas&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You would then import this into your <code>configuration.nix</code> and enable/disable it
with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./doas.nix</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>custom<span style=color:#f92672>.</span>security<span style=color:#f92672>.</span>doas<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span></code></pre></div><blockquote><p>❗ NOTE: Many people opt for the less secure <code>groups = ["wheel"];</code> in the
above configuration instead of <code>users = ["userName"];</code> to give wider access,
the choice is yours.</p></blockquote><h2 id=firejail>Firejail<a hidden class=anchor aria-hidden=true href=#firejail>#</a></h2><ul><li><p><a href=https://wiki.nixos.org/wiki/Firejail>NixOS Wiki Firejail</a></p></li><li><p><a href=https://wiki.archlinux.org/title/Firejail>Arch Wiki Firejail</a></p></li></ul><blockquote><p>❗ WARNING: Running untrusted code is never safe, sandboxing cannot change
this. &ndash;Arch Wiki</p></blockquote><p>Firejail is a SUID program that reduces the risk of security breaches by
restricting the running environment of untrusted applications using
<a href=https://lwn.net/Articles/531114/>Linux namespaces</a> and
<a href=https://l3net.wordpress.com/2015/04/13/firejail-seccomp-guide/>seccomp-bpf</a>&ndash;<a href=https://firejail.wordpress.com/>Firejail Security Sandbox</a></p><p>It provides sandboxing and access restriction per application, much like what
AppArmor/SELinux does at a kernel level. However, it&rsquo;s not as secure or
comprehensive as kernel-enforced MAC systems (AppArmor/SELinux), since it&rsquo;s a
userspace tool and can potentially be bypassed by privilege escalation exploits.</p><h2 id=selinuxapparmor-mac-mandatory-access-control>SeLinux/AppArmor MAC (Mandatory Access Control)<a hidden class=anchor aria-hidden=true href=#selinuxapparmor-mac-mandatory-access-control>#</a></h2><p><strong>AppArmor</strong> is available on NixOS, but is still in a somewhat experimental and
evolving state. There are only a few profiles that have been adapted to NixOS,
see here
<a href=https://discourse.nixos.org/t/apparmor-default-profiles/16780>Discourse on default-profiles</a>
Which guides you here
<a href=https://github.com/NixOS/nixpkgs/blob/2acaef7a85356329f750819a0e7c3bb4a98c13fe/nixos/modules/security/apparmor/includes.nix>apparmor/includes.nix</a>
where you can see some of the abstractions and tunables to follow progress.</p><p><strong>SELinux</strong>: Experimental, not fully integrated, recent progress for
advanced/curious users; expect rough edges and manual intervention if you want
to try it. Most find SELinux more complex to configure and maintain than
AppArmor.</p><p>This isn&rsquo;t meant to be a comprehensive guide, more to get people thinking about
security on NixOS.</p><p>See the following guide on hardening networking:</p><ul><li><a href=https://saylesss88.github.io/nix/hardening_networking.html>Hardening Networking</a></li></ul><h2 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h2><h3 id=advanced-hardening-with-nix-mineral-community-project>Advanced Hardening with <code>nix-mineral</code> (Community Project)<a hidden class=anchor aria-hidden=true href=#advanced-hardening-with-nix-mineral-community-project>#</a></h3><p>For users seeking a more comprehensive and opinionated approach to system
hardening beyond the built-in <code>hardened</code> profile, the community project
<a href=https://github.com/cynicsketch/nix-mineral><code>nix-mineral</code></a> offers a declarative
NixOS module.</p><p><code>nix-mineral</code> aims to apply a wide array of security configurations, focusing on
tweaking kernel parameters, system settings, and file permissions to reduce the
attack surface.</p><ul><li><strong>Community Project Status:</strong> <code>nix-mineral</code> is a community-maintained project
and is not officially part of the Nixpkgs repository or NixOS documentation.
Its development status is explicitly stated as &ldquo;Alpha software,&rdquo; meaning it
may introduce stability issues or unexpected behavior.</li></ul><p>For detailed information on <code>nix-mineral</code>&rsquo;s capabilities and current status,
refer directly to its
<a href=https://github.com/cynicsketch/nix-mineral>GitHub repository</a>.</p><ul><li><p><a href=https://hedgedoc.grimmauld.de/s/hWcvJEniW#>AppArmor and apparmor.d on NixOS</a></p></li><li><p><a href=https://tristanxr.com/post/selinux-on-nixos/>SELinux on NixOS</a></p></li><li><p><a href=https://xeiaso.net/blog/paranoid-nixos-2021-07-18/>Paranoid NixOS</a></p></li><li><p><a href=https://wiki.nixos.org/wiki/Security>NixOS Wiki Security</a></p></li><li><p><a href=https://nixos.org/manual/nixos/unstable/index.html#sec-luks-file-systems>Luks Encrypted File Systems</a></p></li><li><p><a href=https://discourse.nixos.org/t/a-modern-and-secure-desktop-setup/41154>Discourse A Modern and Secure Desktop</a></p></li><li><p><a href=https://notashelf.dev/posts/insecurities-remedies-i>notashelf NixOS Security 1 Systemd</a></p></li><li><p><a href=https://ryanseipp.com/post/hardening-nixos/>ryanseipp hardening-nixos</a></p></li><li><p><a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html>madaidans Linux Hardening Guide</a></p></li><li><p><a href=https://cybersecuritynews.com/hardening-linux-servers>Hardening-Linux-Servers</a></p></li><li><p><a href=https://linux-audit.com/linux-server-hardening-most-important-steps-to-secure-systems/>linux-audit Linux Server hardening best practices</a></p></li><li><p><a href=https://linux-audit.com/linux-security-guide-extended-version/>linux-audit Linux security guide extended</a></p></li><li><p><a href=https://wiki.archlinux.org/title/Security>Arch Wiki Security</a></p></li><li><p><a href=https://wiki.gentoo.org/wiki/Security_Handbook/Concepts>Gentoo Security_Handbook Concepts</a></p></li><li><p>STIGs are configuration standards developed by the Defense Information Systems
Agency (DISA) to secure systems and software for the U.S. Department of
Defense (DoD). They are considered a highly authoritative source for system
hardening.There are recommendations for hardening all kinds of software in the
<a href=https://stigviewer.com/stigs>Stig Viewer</a></p></li><li><p><a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmarks</a></p></li><li><p><a href=https://github.com/nsacyber>NSA Cybersecurity Directorate</a></p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>