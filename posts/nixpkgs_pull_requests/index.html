<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nixpkgs_pull_requests | NixOS Blog</title><meta name=keywords content><meta name=description content="Nixpkgs Pull Requests

     


Pull requests communicate changes to a branch in a repository. Once a pull
request is opened, you can review changes with collaborators and add follow-up
commits.


A pull request is a proposal to merge a set of changes from one branch
into another. In a pull request, collaborators can review and discuss the
proposed set of changes before they integrate the changes into the main
codebase.


Pull requests display the differences, or diffs, between the content in the
source branch and the content in the target branch."><meta name=author content><link rel=canonical href=https://tsawyer87.github.io/posts/nixpkgs_pull_requests/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/nixpkgs_pull_requests/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/nixpkgs_pull_requests/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Nixpkgs_pull_requests"><meta property="og:description" content="Nixpkgs Pull Requests Pull requests communicate changes to a branch in a repository. Once a pull request is opened, you can review changes with collaborators and add follow-up commits.
A pull request is a proposal to merge a set of changes from one branch into another. In a pull request, collaborators can review and discuss the proposed set of changes before they integrate the changes into the main codebase.
Pull requests display the differences, or diffs, between the content in the source branch and the content in the target branch."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-15T13:02:06-04:00"><meta property="article:modified_time" content="2025-05-15T13:02:06-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nixpkgs_pull_requests"><meta name=twitter:description content="Nixpkgs Pull Requests

     


Pull requests communicate changes to a branch in a repository. Once a pull
request is opened, you can review changes with collaborators and add follow-up
commits.


A pull request is a proposal to merge a set of changes from one branch
into another. In a pull request, collaborators can review and discuss the
proposed set of changes before they integrate the changes into the main
codebase.


Pull requests display the differences, or diffs, between the content in the
source branch and the content in the target branch."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Nixpkgs_pull_requests","item":"https://tsawyer87.github.io/posts/nixpkgs_pull_requests/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nixpkgs_pull_requests","name":"Nixpkgs_pull_requests","description":"Nixpkgs Pull Requests Pull requests communicate changes to a branch in a repository. Once a pull request is opened, you can review changes with collaborators and add follow-up commits.\nA pull request is a proposal to merge a set of changes from one branch into another. In a pull request, collaborators can review and discuss the proposed set of changes before they integrate the changes into the main codebase.\nPull requests display the differences, or diffs, between the content in the source branch and the content in the target branch.\n","keywords":[],"articleBody":"Nixpkgs Pull Requests Pull requests communicate changes to a branch in a repository. Once a pull request is opened, you can review changes with collaborators and add follow-up commits.\nA pull request is a proposal to merge a set of changes from one branch into another. In a pull request, collaborators can review and discuss the proposed set of changes before they integrate the changes into the main codebase.\nPull requests display the differences, or diffs, between the content in the source branch and the content in the target branch.\ngraph LR A[Your Local Repository] --\u003e B(Feature Branch); B --\u003e C{GitHub Repository}; C -- \"Open Pull Request\" --\u003e D[Pull Request on GitHub]; D -- \"Review \u0026 Discussion\" --\u003e D; D -- \"Merge\" --\u003e E(Main Branch on GitHub); E --\u003e F[Nixpkgs Users]; Explanation of the Diagram:\nA[Your Local Repository]: This represents the copy of the Nixpkgs repo on your computer where you make changes.\nB (Feature Branch): You create a dedicated branch (e.g.my-pack-update) to isolate your changes.\nC {GitHub Repository}: This is the central online repo for Nixpkgs on Github. You push your feature branch to this repo.\nC – “Open Pull Request” – D [Pull Request on Github]: You initiate a pull request from your feature branch to the main branch (usually master or main) through the GitHub interface.\nD [Pull Request on GitHub]: This is where collaborators can see your proposed changes, discuss them, and provide feedback.\nD – “Review \u0026 Discussion” –\u003e D: The pull request facilitates communication and potential revisions based on the review.\nD – “Merge” –\u003e E (Main Branch on GitHub): Once the changes are approved, they are merged into the main branch of the Nixpkgs repository.\nE (Main Branch on GitHub): The main branch now contains the integrated changes.\nE –\u003e F [Nixpkgs Users]): Eventually, these changes become available to all Nixpkgs users through updates to their Nix installations.\nFlakes often rely on having access to the full history of the Git repository to correctly determine dependencies, identify specific revisions of inputs, and evaluate the flake. Not in all situations will a shallow clone work and this is one of them.\nIf you have any changes to your local copy of Nixpkgs make sure to stash them before the following:\ngit stash -u This command saves your uncommited changes (including staged files) temporarily. You can restore them later with git stash pop Step 1 Clone Nixpkgs Locally\nIf you don’t have Nixpkgs locally, you’ll need to clone it:\ngit clone https://github.com/NixOS/nixpkgs.git Step 2 Find a Relevant Pull Request\nTo find specifig commits and releases:\nstatus.nixos.org provides the latest tested commits for each release - use when pinning to specific commits. List of active release channels - use when tracking latest channel versions.\nThe complete list of channels is available at nixos.org/channels\nTo find a relevant PR you can go to:\nNixpkgs Pull Requests\nThe following example actually uses the Nix Pull Requests the process is the same, but that is an important distinction.\nIn the Filters enter stack trace for this example.\nThe pull request I chose was 8623\nStep 3 Add the Remote Repository (if necessary)\nIf the pull request is from a different repository than your local clone (as in the case of the nix PR while working in a nixpkgs clone), you need to add that repository as a remote. It’s common to name the main Nixpkgs remote origin and other related repositories like nix as upstream.\nAssuming you are in your nixpkgs clone and want to test a PR from the nix repository:\ngit remote add upstream https://github.com/NixOS/nix.git Step 4 Fetch the Pull Request Changes\nFetch the Pull Request Information:\ngit fetch upstream refs/pull/8623/head:pr-8623 This command fetches the branch named head from the pull request 8623 in the upstream remote and creates a local branch named pr-8623 that tracks it. Output:\nremote: Enumerating objects: 104651, done. remote: Counting objects: 100% (45/45), done. remote: Compressing objects: 100% (27/27), done. remote: Total 104651 (delta 33), reused 20 (delta 18), pack-reused 104606 (from 1) Receiving objects: 100% (104651/104651), 61.64 MiB | 12.56 MiB/s, done. Resolving deltas: 100% (74755/74755), done. From https://github.com/NixOS/nix * [new ref] refs/pull/8623/head -\u003e pr-8623 * [new tag] 1.0 -\u003e 1.0 * [new tag] 1.1 -\u003e 1.1 * [new tag] 1.10 -\u003e 1.10 * [new tag] 1.11 -\u003e 1.11 * [new tag] 1.11.1 -\u003e 1.11.1 * [new tag] 1.2 -\u003e 1.2 * [new tag] 1.3 -\u003e 1.3 * [new tag] 1.4 -\u003e 1.4 * [new tag] 1.5 -\u003e 1.5 * [new tag] 1.5.1 -\u003e 1.5.1 * [new tag] 1.5.2 -\u003e 1.5.2 * [new tag] 1.5.3 -\u003e 1.5.3 * [new tag] 1.6 -\u003e 1.6 * [new tag] 1.6.1 -\u003e 1.6.1 * [new tag] 1.7 -\u003e 1.7 * [new tag] 1.8 -\u003e 1.8 * [new tag] 1.9 -\u003e 1.9 * [new tag] 2.0 -\u003e 2.0 * [new tag] 2.2 -\u003e 2.2 Step 5 Checkout the Local Branch:\ngit checkout pr-8623 Or with the gh cli:\ngh pr checkout 8623 Build and Test the Changes Now we want to see if the code changes introduced by the pull request actually build correctly within the Nix ecosystem. nix build Output:\nerror: builder for '/nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv' failed with exit code 2; last 25 log lines: \u003e \u003e _NIX_TEST_ACCEPT=1 make tests/functional/lang.sh.test \u003e \u003e to regenerate the files containing the expected output, \u003e and then view the git diff to decide whether a change is \u003e good/intentional or bad/unintentional. \u003e If the diff contains arbitrary or impure information, \u003e please improve the normalization that the test applies to the output. \u003e make: *** [mk/lib.mk:90: tests/functional/lang.sh.test] Error 1 \u003e make: *** Waiting for unfinished jobs.... \u003e ran test tests/functional/selfref-gc.sh... [PASS] \u003e ran test tests/functional/store-info.sh... [PASS] \u003e ran test tests/functional/suggestions.sh... [PASS] \u003e ran test tests/functional/path-from-hash-part.sh... [PASS] \u003e ran test tests/functional/gc-auto.sh... [PASS] \u003e ran test tests/functional/path-info.sh... [PASS] \u003e ran test tests/functional/flakes/show.sh... [PASS] \u003e ran test tests/functional/fetchClosure.sh... [PASS] \u003e ran test tests/functional/completions.sh... [PASS] \u003e ran test tests/functional/build.sh... [PASS] \u003e ran test tests/functional/impure-derivations.sh... [PASS] \u003e ran test tests/functional/build-delete.sh... [PASS] \u003e ran test tests/functional/build-remote-trustless-should-fail-0.sh... [PASS] \u003e ran test tests/functional/build-remote-trustless-should-pass-2.sh... [PASS] \u003e ran test tests/functional/nix-profile.sh... [PASS] For full logs, run: nix log /nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv nix build (Part of the Nix Unified CLI):\nDeclarative: when used within a Nix flake (flake.nix), nix build is a bit more declarative. It understands the outputs defined in your flake.\nClearer Output Paths: nix build typically places build outputs in the ./result directory by default (similar to nix-build’s result symlink)\nBetter Error Reporting: It gives more informative error messages.\nFuture Direction\nBenefits of using nix build:\nFlake Integration: nix build naturally understands the flake’s outputs.\nDevelopment Shells: When you are in a nix develop shell, nix build is the more idiomatic way to build packages defined in your dev environment.\nConsistency: Using the unified CLI promotes a more consistent workflow.\nNext Steps As you can see this build failed, as for why the build failed, the key part of the error message is:\nmake: *** [mk/lib.mk:90: tests/functional/lang.sh.test] Error 1 This suggests that one of the functional tests (lang.sh.test) failed. This happens when the expected output of the test doesn’t match the actual output. This can heppen when:\nThe test expectations are outdated due to changes in the codebase.\nThe test captures environment-specific or transient outputs that are not properly normalized.\nThe test includes impure or non-deterministic information, making it hard to verify.\nTo address this, _NIX_TEST_ACCEPT=1 is used as an override mechanism that tells the test framework: \u003e “Accept whatever output is generated as the new expected result.”\nThe message advises running:\n_NIX_TEST_ACCEPT=1 make tests/functional/lang.sh.test This will regenerate the expected output files, allowing you to inspect what changed with git diff: git diff tests/functional/lang.sh.test Verifies if Changes are Intentional: If the difference is reasonable and expected (due to a legitimate update in the logic), you can commit these changes to update the test suit. If not, you have to refine the test normalization process further. If the changes seem valid, commit them:\ngit add tests/functional/lang.sh.test git commit -m \"Update expected test output for lang.sh.test\" Running the following will provide the full logs:\nnix log /nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv Conclusion Testing Nixpkgs pull requests is a vital part of contributing to a healthy and reliable Nix ecosystem. By following these steps, you can help ensure that changes are well-vetted before being merged, ultimately benefiting all Nix users. Your efforts in testing contribute significantly to the quality and stability of Nixpkgs.\n","wordCount":"1394","inLanguage":"en","datePublished":"2025-05-15T13:02:06-04:00","dateModified":"2025-05-15T13:02:06-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/nixpkgs_pull_requests/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Nixpkgs_pull_requests</h1><div class=post-meta><span title='2025-05-15 13:02:06 -0400 EDT'>May 15, 2025</span></div></header><div class=post-content><h1 id=nixpkgs-pull-requests>Nixpkgs Pull Requests<a hidden class=anchor aria-hidden=true href=#nixpkgs-pull-requests>#</a></h1><figure><img loading=lazy src=/images/gruv16.png alt=window_view width=1000></figure><p><strong>Pull requests</strong> communicate changes to a branch in a repository. Once a pull
request is opened, you can review changes with collaborators and add follow-up
commits.</p><ul><li><p>A <strong>pull request</strong> is a proposal to merge a set of changes from one branch
into another. In a pull request, collaborators can review and discuss the
proposed set of changes before they integrate the changes into the main
codebase.</p></li><li><p>Pull requests display the differences, or diffs, between the content in the
source branch and the content in the target branch.</p></li></ul><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR
    A[Your Local Repository] --&gt; B(Feature Branch);
    B --&gt; C{GitHub Repository};
    C -- &#34;Open Pull Request&#34; --&gt; D[Pull Request on GitHub];
    D -- &#34;Review &amp; Discussion&#34; --&gt; D;
    D -- &#34;Merge&#34; --&gt; E(Main Branch on GitHub);
    E --&gt; F[Nixpkgs Users];
</code></pre><p><strong>Explanation of the Diagram</strong>:</p><ul><li><p><strong>A[Your Local Repository]</strong>: This represents the copy of the Nixpkgs repo on
your computer where you make changes.</p></li><li><p><strong>B (Feature Branch)</strong>: You create a dedicated branch (e.g.<code>my-pack-update</code>)
to isolate your changes.</p></li><li><p><strong>C {GitHub Repository}</strong>: This is the central online repo for Nixpkgs on
Github. You push your feature branch to this repo.</p></li><li><p><strong>C &ndash; &ldquo;Open Pull Request&rdquo; &ndash; D [Pull Request on Github]</strong>: You initiate a
pull request from your feature branch to the main branch (usually <code>master</code> or
<code>main</code>) through the GitHub interface.</p></li><li><p><strong>D [Pull Request on GitHub]</strong>: This is where collaborators can see your
proposed changes, discuss them, and provide feedback.</p></li><li><p><strong>D &ndash; &ldquo;Review & Discussion&rdquo; &ndash;> D</strong>: The pull request facilitates communication
and potential revisions based on the review.</p></li><li><p><strong>D &ndash; &ldquo;Merge&rdquo; &ndash;> E (Main Branch on GitHub)</strong>: Once the changes are approved,
they are merged into the main branch of the Nixpkgs repository.</p></li><li><p><strong>E (Main Branch on GitHub)</strong>: The main branch now contains the integrated
changes.</p></li><li><p><strong>E &ndash;> F [Nixpkgs Users]</strong>): Eventually, these changes become available to all
Nixpkgs users through updates to their Nix installations.</p></li></ul><p>Flakes often rely on having access to the full history of the Git repository
to correctly determine dependencies, identify specific revisions of inputs,
and evaluate the flake. Not in all situations will a shallow clone work and
this is one of them.</p><p>If you have any changes to your local copy of Nixpkgs make sure to stash them
before the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git stash -u
</span></span></code></pre></div><ul><li>This command saves your uncommited changes (including staged files)
temporarily. You can restore them later with <code>git stash pop</code></li></ul><p><strong>Step 1 Clone Nixpkgs Locally</strong></p><p>If you don&rsquo;t have Nixpkgs locally, you&rsquo;ll need to clone it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/NixOS/nixpkgs.git
</span></span></code></pre></div><p><strong>Step 2 Find a Relevant Pull Request</strong></p><p>To find specifig commits and releases:</p><p><a href=https://status.nixos.org/>status.nixos.org</a> provides the latest tested commits
for each release - use when pinning to specific commits. List of active release
channels - use when tracking latest channel versions.</p><p>The complete list of channels is available at <a href=https://channels.nixos.org/>nixos.org/channels</a></p><p>To find a relevant PR you can go to:</p><ul><li><p><a href=https://github.com/NixOS/nixpkgs/pulls>Nixpkgs Pull Requests</a></p></li><li><p>The following example actually uses the <a href=https://github.com/NixOS/nix/pulls>Nix Pull Requests</a>
the process is the same, but that is an important distinction.</p></li><li><p>In the Filters enter <code>stack trace</code> for this example.</p></li><li><p>The pull request I chose was <a href=https://github.com/nixos/nix/pull/8623>8623</a></p></li></ul><p><strong>Step 3 Add the Remote Repository (if necessary)</strong></p><p>If the pull request is from a different repository than your local clone
(as in the case of the <code>nix</code> PR while working in a <code>nixpkgs</code> clone), you need to
add that repository as a remote. It&rsquo;s common to name the main Nixpkgs remote
<code>origin</code> and other related repositories like <code>nix</code> as <code>upstream</code>.</p><p>Assuming you are in your <code>nixpkgs</code> clone and want to test a PR from the <code>nix</code>
repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git remote add upstream https://github.com/NixOS/nix.git
</span></span></code></pre></div><p><strong>Step 4 Fetch the Pull Request Changes</strong></p><p>Fetch the Pull Request Information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git fetch upstream refs/pull/8623/head:pr-8623
</span></span></code></pre></div><ul><li>This command fetches the branch named <code>head</code> from the pull request <code>8623</code> in
the <code>upstream</code> remote and creates a local branch named <code>pr-8623</code> that tracks it.</li></ul><p><strong>Output</strong>:</p><pre tabindex=0><code>remote: Enumerating objects: 104651, done.
remote: Counting objects: 100% (45/45), done.
remote: Compressing objects: 100% (27/27), done.
remote: Total 104651 (delta 33), reused 20 (delta 18), pack-reused 104606 (from 1)
Receiving objects: 100% (104651/104651), 61.64 MiB | 12.56 MiB/s, done.
Resolving deltas: 100% (74755/74755), done.
From https://github.com/NixOS/nix
 * [new ref]             refs/pull/8623/head -&gt; pr-8623
 * [new tag]             1.0                 -&gt; 1.0
 * [new tag]             1.1                 -&gt; 1.1
 * [new tag]             1.10                -&gt; 1.10
 * [new tag]             1.11                -&gt; 1.11
 * [new tag]             1.11.1              -&gt; 1.11.1
 * [new tag]             1.2                 -&gt; 1.2
 * [new tag]             1.3                 -&gt; 1.3
 * [new tag]             1.4                 -&gt; 1.4
 * [new tag]             1.5                 -&gt; 1.5
 * [new tag]             1.5.1               -&gt; 1.5.1
 * [new tag]             1.5.2               -&gt; 1.5.2
 * [new tag]             1.5.3               -&gt; 1.5.3
 * [new tag]             1.6                 -&gt; 1.6
 * [new tag]             1.6.1               -&gt; 1.6.1
 * [new tag]             1.7                 -&gt; 1.7
 * [new tag]             1.8                 -&gt; 1.8
 * [new tag]             1.9                 -&gt; 1.9
 * [new tag]             2.0                 -&gt; 2.0
 * [new tag]             2.2                 -&gt; 2.2
</code></pre><p><strong>Step 5 Checkout the Local Branch:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout pr-8623
</span></span></code></pre></div><p>Or with the <code>gh</code> cli:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gh pr checkout <span style=color:#ae81ff>8623</span>
</span></span></code></pre></div><h2 id=build-and-test-the-changes>Build and Test the Changes<a hidden class=anchor aria-hidden=true href=#build-and-test-the-changes>#</a></h2><ul><li>Now we want to see if the code changes introduced by the pull request actually
build correctly within the Nix ecosystem.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix build
</span></span></code></pre></div><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>error: builder <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;/nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv&#39;</span> failed with exit code 2;
</span></span><span style=display:flex><span>   last <span style=color:#ae81ff>25</span> log lines:
</span></span><span style=display:flex><span>   &gt;
</span></span><span style=display:flex><span>   &gt;         _NIX_TEST_ACCEPT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make tests/functional/lang.sh.test
</span></span><span style=display:flex><span>   &gt;
</span></span><span style=display:flex><span>   &gt;     to regenerate the files containing the expected output,
</span></span><span style=display:flex><span>   &gt;     and <span style=color:#66d9ef>then</span> view the git diff to decide whether a change is
</span></span><span style=display:flex><span>   &gt;     good/intentional or bad/unintentional.
</span></span><span style=display:flex><span>   &gt;     If the diff contains arbitrary or impure information,
</span></span><span style=display:flex><span>   &gt;     please improve the normalization that the test applies to the output.
</span></span><span style=display:flex><span>   &gt; make: *** <span style=color:#f92672>[</span>mk/lib.mk:90: tests/functional/lang.sh.test<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   &gt; make: *** Waiting <span style=color:#66d9ef>for</span> unfinished jobs....
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/selfref-gc.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/store-info.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/suggestions.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/path-from-hash-part.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/gc-auto.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/path-info.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/flakes/show.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/fetchClosure.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/completions.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/build.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/impure-derivations.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/build-delete.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/build-remote-trustless-should-fail-0.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/build-remote-trustless-should-pass-2.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   &gt; ran test tests/functional/nix-profile.sh... <span style=color:#f92672>[</span>PASS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   For full logs, run:
</span></span><span style=display:flex><span>     nix log /nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv
</span></span></code></pre></div><ul><li><p><strong><code>nix build</code></strong> (Part of the Nix Unified CLI):</p><ul><li><p>Declarative: when used within a Nix flake (<code>flake.nix</code>), <code>nix build</code> is a
bit more declarative. It understands the outputs defined in your flake.</p></li><li><p>Clearer Output Paths: <code>nix build</code> typically places build outputs in the
<code>./result</code> directory by default (similar to <code>nix-build</code>&rsquo;s <code>result</code> symlink)</p></li><li><p>Better Error Reporting: It gives more informative error messages.</p></li><li><p>Future Direction</p></li></ul></li></ul><p><strong>Benefits of using <code>nix build</code>:</strong></p><ul><li><p><strong>Flake Integration:</strong> <code>nix build</code> naturally understands the flake&rsquo;s outputs.</p></li><li><p><strong>Development Shells:</strong> When you are in a <code>nix develop</code> shell, <code>nix build</code> is
the more idiomatic way to build packages defined in your dev environment.</p></li><li><p><strong>Consistency:</strong> Using the unified CLI promotes a more consistent workflow.</p></li></ul><h3 id=next-steps>Next Steps<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h3><p>As you can see this build failed, as for why the build failed, the key part of
the error message is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make: *** <span style=color:#f92672>[</span>mk/lib.mk:90: tests/functional/lang.sh.test<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><ul><li>This suggests that one of the functional tests (<code>lang.sh.test</code>) failed. This
happens when the expected output of the test doesn&rsquo;t match the actual output.</li></ul><p>This can heppen when:</p><ol><li><p>The test expectations are outdated due to changes in the codebase.</p></li><li><p>The test captures environment-specific or transient outputs that are not
properly normalized.</p></li><li><p>The test includes impure or non-deterministic information, making it hard to
verify.</p></li></ol><p>To address this, _NIX_TEST_ACCEPT=1 is used as an override mechanism that tells
the test framework: > &ldquo;Accept whatever output is generated as the new expected
result.&rdquo;</p><p>The message advises running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>_NIX_TEST_ACCEPT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> make tests/functional/lang.sh.test
</span></span></code></pre></div><ul><li>This will regenerate the expected output files, allowing you to inspect what
changed with <code>git diff</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git diff tests/functional/lang.sh.test
</span></span></code></pre></div><ul><li><strong>Verifies if Changes are Intentional:</strong> If the difference is reasonable and
expected (due to a legitimate update in the logic), you can commit these changes
to update the test suit. If not, you have to refine the test normalization process
further.</li></ul><p>If the changes seem valid, commit them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git add tests/functional/lang.sh.test
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;Update expected test output for lang.sh.test&#34;</span>
</span></span></code></pre></div><p>Running the following will provide the full logs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix log /nix/store/rk86daqgf6a9v6pdx6vcc5b580lr9f09-nix-2.20.0pre20240115_20b4959.drv
</span></span></code></pre></div><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>Testing Nixpkgs pull requests is a vital part of contributing to a healthy and
reliable Nix ecosystem. By following these steps, you can help ensure that
changes are well-vetted before being merged, ultimately benefiting all Nix users.
Your efforts in testing contribute significantly to the quality and stability
of Nixpkgs.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>