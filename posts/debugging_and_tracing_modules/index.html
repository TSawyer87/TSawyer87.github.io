<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Debugging_and_tracing_modules | NixOS Blog</title><meta name=keywords content><meta name=description content="Debugging and Tracing NixOS Modules

     




Other related post if you haven&rsquo;t read my previous post on modules, that may
be helpful before reading this one:


nix-modules-explained


This post is my notes following Nix Hour 40. If it seems a little chaotic,
try watching one. They are hard to follow if you&rsquo;re not extremely
familiar with the concepts.


Nix Hour 40




Nix Code is particularly hard to debug because of (e.g. lazy evaluation,
declarative nature, layered modules)"><meta name=author content><link rel=canonical href=https://tsawyer87.github.io/posts/debugging_and_tracing_modules/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/debugging_and_tracing_modules/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/debugging_and_tracing_modules/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Debugging_and_tracing_modules"><meta property="og:description" content="Debugging and Tracing NixOS Modules Other related post if you haven’t read my previous post on modules, that may be helpful before reading this one:
nix-modules-explained
This post is my notes following Nix Hour 40. If it seems a little chaotic, try watching one. They are hard to follow if you’re not extremely familiar with the concepts.
Nix Hour 40
Nix Code is particularly hard to debug because of (e.g. lazy evaluation, declarative nature, layered modules)"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-15T10:08:17-04:00"><meta property="article:modified_time" content="2025-05-15T10:08:17-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging_and_tracing_modules"><meta name=twitter:description content="Debugging and Tracing NixOS Modules

     




Other related post if you haven&rsquo;t read my previous post on modules, that may
be helpful before reading this one:


nix-modules-explained


This post is my notes following Nix Hour 40. If it seems a little chaotic,
try watching one. They are hard to follow if you&rsquo;re not extremely
familiar with the concepts.


Nix Hour 40




Nix Code is particularly hard to debug because of (e.g. lazy evaluation,
declarative nature, layered modules)"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Debugging_and_tracing_modules","item":"https://tsawyer87.github.io/posts/debugging_and_tracing_modules/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Debugging_and_tracing_modules","name":"Debugging_and_tracing_modules","description":"Debugging and Tracing NixOS Modules Other related post if you haven\u0026rsquo;t read my previous post on modules, that may be helpful before reading this one:\nnix-modules-explained\nThis post is my notes following Nix Hour 40. If it seems a little chaotic, try watching one. They are hard to follow if you\u0026rsquo;re not extremely familiar with the concepts.\nNix Hour 40\nNix Code is particularly hard to debug because of (e.g. lazy evaluation, declarative nature, layered modules)\n","keywords":[],"articleBody":"Debugging and Tracing NixOS Modules Other related post if you haven’t read my previous post on modules, that may be helpful before reading this one:\nnix-modules-explained\nThis post is my notes following Nix Hour 40. If it seems a little chaotic, try watching one. They are hard to follow if you’re not extremely familiar with the concepts.\nNix Hour 40\nNix Code is particularly hard to debug because of (e.g. lazy evaluation, declarative nature, layered modules)\nThe following simple Nix code snippet illustrates a basic NixOS module definition and how options are declared and configured. We’ll use this example to demonstrate fundamental debugging techniques using nix-instantiate. let lib = import ; in lib.evalModules { modules = [ ({ lib, ... }: { options.foo = lib.mkOption { # type = lib.types.raw; type = lib.types.anything; # default = pkgs; }; config.foo = { bar = 10; list = [1 2 3 ]; baz = lib.mkDefault \"baz\"; }; }) { foo.baz = \"bar\"; } ]; } In the above code, adding lib to the function arguments isn’t required but if you were to move the module to another file it would fail without it because lib comes from outside of it. So it’s good practice to refer to lib in the modules themselves.\nYou should always assign a type to your options, if you don’t know which type to use you could use raw. raw is a type that doesn’t do any processing. So if you were to assign the entire packages set to the option e.g. default = pkgs; it wouldn’t recurseinto all the packages and try to evaluate them. There is also anything, that is useful if you do want to recurse into the values.\nThe following is an example of how you would run this inside vim/neovim, the rest of the examples will be from the command line:\n:!nix-instantiate --eval -A config.foo --strict Output:\n{ bar = 10; baz = \"bar\"; list = [ 1 2 3 ]; } To show the difference you could uncomment the raw type and comment the anything type and run the above command again you’ll see that you get an error:\nerror: The option 'foo' is defined multiple times while it's expected to be unique To execute this command on the command line:\nnix-instantiate --eval --strict -A config.foo It will show you the start of a trace. To get the full trace add:\nnix-instantiate --eval --strict -A config.foo --show-trace Example 2 In the previous example, we looked at a simplified module. Now, let’s examine a more realistic scenario involving a basic NixOS configuration file (configuration.nix).\nThis example will demonstrate how to use nix-instantiate to evaluate an entire system configuration and how --show-trace helps in diagnosing errors within this context.\nConsider the following configuration.nix file:\n# configuration.nix { lib, ... }: { boot.loader.grub.device = \"nodev\"; fileSystems.\"/\".device = \"/devst\"; system.stateVersion = \"24.11\"; } This configuration snippet sets the GRUB bootloader device, defines a root filesystem, and specifies the expected NixOS state version. To evaluate this entire system configuration, you can use nix-instantiate and point it to the entrypoint, providing our configuration.nix file as an argument. The -A system flag selects the top-level system attribute, which represents the instantiated system configuration. Run it in with:\nnix-instantiate '' --arg configuration ./configuration.nix -A system Output:\n/nix/store/kfcwvvpdbsb3xcks1s76id16i1mc3l5k-nixos-system-nixos-25.05pre-git.drv Ok, we can see that this successfully instantiates. Let’s introduce an error to trace:\n{ lib, ... }: { boot.loader.grub.device = \"nodev\"; fileSystems.\"/\".device = \"/devst\"; system.stateVersion = builtins.genList \"24.11\" null; } Output:\n(stack trace truncated; use '--show-trace' to show the full, detailed trace) error: expected an integer but found null: null Rerun the command with --show-trace appended:\nOr on the command line\nnix-instantiate '' --arg configuration ./configuration.nix -A system --show-trace This outputs a much longer trace than the first example. It shows you the file the error occured in and you can see that in this case they are a lot of internal functions. (e.g. at /nix/store/ccfwxygjrarahgfv5865x2f828sjr5h0- source/lib/attrsets.nix:1529:14:) To show your own error message you could do something like this:\n{lib, ...}: { boot.loader.grub.device = \"nodev\"; fileSystems.\"/\".device = \"/devst\"; system.stateVersion = builtins.addErrorContext \"AAAAAAAAAAAAAAAAA\" (builtins.genList \"24.11\" null); } Run it:\nnix-instantiate '' --arg configuration ./configuration.nix -A system --show-trace` Output:\n… while evaluating the attribute 'value' at /nix/store/ccfwxygjrarahgfv5865x2f828sjr5h0-source/lib/modules.nix:770:21: 769| inherit (module) file; 770| inherit value; | ^ 771| }) module.config … AAAAAAAAAAAAAAAAA … while calling the 'genList' builtin at /home/jr/tests/configuration.nix:4:71: 3| fileSystems.\"/\".device = \"/devst\"; 4| system.stateVersion = builtins.addErrorContext \"AAAAAAAAAAAAAAAAA\" (builtins.genList \"24.11\" null); | ^ 5| } … while evaluating the second argument passed to builtins.genList error: expected an integer but found null: null In the latest nix they actually inverted the error messages so the most relevant parts will be at the bottom. Example 3 Let’s consider another example, this time demonstrating the definition of configuration options using lib.mkOption within a module structure.\n# default.nix let lib = import ; in lib.evalModules { modules = [ ({ lib, ... }: { options.ints = lib.mkOption { type = lib.types.attrsOf lib.types.int; }; options.strings = lib.mkOption { type = lib.types.string; # type = lib.types.attrsOf lib.types.string; default = \"foo\"; }; }) ]; } Instantiate this with:\nnix-instantiate --eval --strict -A config.strings Output:\nevaluation warning: The type `types.string` is deprecated. See https://github.com/NixOS/nixpkgs/pull/66346 for better alternative types. \"foo\" Unfortunately you won’t get the same depreciation warning from lib.attrsOf Below is an interesting way to provide nixpkgs run it on the command line:\nexport NIX_PATH=nixpkgs=channel:nixpkgs-unstable echo $NIX_PATH Output:\nnixpkgs=channel:nixpkgs-unstable The next two commands are to check that after using the above way to provide nixpkgs-unstable that they both point to the same store path, the following command will fetch nixpkgs from the channel above:\nnix-instantiate --find-file nixpkgs Output 1️⃣\n/nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source nix-instantiate --eval channel:nixpkgs-unstable -A path Output: 2️⃣\n/nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source As you can see both commands produce the same store path Example 4 In our previous example, we encountered a deprecation warning for lib.types.string. This next example delves deeper into why that type was deprecated and demonstrates the consequences of its behavior, along with the recommended fix.\n# default.nix let lib = import ; in lib.evalModules { modules = [ ({lib, ...}: { options.ints = lib.mkOption { type = lib.types.attrsOf lib.types.int; }; options.strings = lib.mkOption { # type = lib.types.string; type = lib.types.attrsOf lib.types.string; default = { x = \"foo\"; }; }; config = { strings = lib.mkOptionDefault { x = \"bar\"; }; }; }) ]; } Evaluate it with:\nnix-instantiate --eval --strict -A config.strings types.string depricated because it silently concatenates strings\nThe above command has two options with the same priority level and evaluates to { x = \"foobar\"; }\nOutput:\nevaluation warning: The type `types.string` is deprecated. See https://github. com/NixOS/nixpkgs/pull/66346 for better alternative types. { x = \"foobar\"; } types.str was the replacement for the depricated types.string: # default.nix let lib = import ; in lib.evalModules { modules = [ ({lib, ...}: { options.ints = lib.mkOption { type = lib.types.attrsOf lib.types.int; }; options.strings = lib.mkOption { # type = lib.types.string; type = lib.types.attrsOf lib.types.str; # Sets the value with a lower priority: lib.mkOptionDefault default = { x = \"foo\"; }; }; config = { strings = lib.mkOptionDefault { x = \"bar\"; }; }; }) ]; } Output:\nerror: … while evaluating the attribute 'x' … while evaluating the attribute 'value' at /nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source/lib/modules.nix:1148:41: 1147| 1148| optionalValue = if isDefined then { value = mergedValue; } else { }; | ^ 1149| }; … while calling the 'foldl'' builtin at /nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source/lib/options.nix:508:8: 507| else 508| (foldl' ( | ^ 509| first: def: (stack trace truncated; use '--show-trace' to show the full, detailed trace) error: The option `strings.x' has conflicting definition values: - In `': \"foo\" - In `': \"bar\" Use `lib.mkForce value` or `lib.mkDefault value` to change the priority on any of these definitions. shell returned 1 Summary So types in the module system aren’t just types in the conventional sense but they also specify the emerging behavior of these values.\nIf we switch the type in the above example to types.lines you get this returned, { x = \"foo\\nbar\"; }\nmkOptionDefault isn’t typically something you should generally use, instead options have a default setting\nIf you want to make sure that you set a default but if the user specifies it, it shouldn’t get overridden. You should not set it in the following:\noptions.strings = lib.mkOption { type = lib.types.attrsOf lib.types.lines; default = { x = \"foo\"; }; } Because the above uses mkOptionDefault but instead in under the config attribute like the following:\n# ...snip... options.strings = lib.mkOption { type = lib.types.attrsOf lib.types.lines; # default = { # x = \"foo\"; # }; }; config = { strings = { x = lib.mkDefault \"foo\"; }; }; # ...snip... let lib = import ; in lib.evalModules { modules = [ ({lib, ...}: { options.ints = lib.mkOption { type = lib.types.attrsOf lib.types.int; }; options.strings = lib.mkOption { # type = lib.types.string; type = lib.types.attrsOf lib.types.str; # Sets the value with a lower priority: lib.mkOptionDefault #default = { # x = \"foo\"; #}; }; config.strings = { x = \"foo\"; }; }) { config.strings = { y = \"bar\"; }; } ]; } Output:\nThis works now because there’s no difference between x and y { x = \"foo\"; y = \"bar\"; } More Functionality between modules let lib = import ; in lib.evalModules { modules = [ ({lib, ...}: { options.ints = lib.mkOption { type = lib.types.attrsOf lib.types.int; }; options.strings = lib.mkOption { # type = lib.types.string; type = lib.types.attrsOf lib.types.str; # Sets the value with a lower priority: lib.mkOptionDefault #default = { # x = \"foo\"; #}; }; config.strings = { x = lib.mkDefault \"foo\"; }; }) { config.strings = { x = \"x\"; y = \"bar\"; }; } ]; } The above command would cause a conflict without the x = lib.mkDefault foo And this is typically what you want to do for defaults and modules in things like nested configuration. Output:\n{ x = \"x\"; y = \"bar\"; } Infinite recursion error A common pitfall is to introduce a hard to debug error infinite recursion when shadowing a name. The simplest example for this is: let a = 1; in rec { a = a; } 💡TIP: Avoid rec. Use let ... in Example:\nlet a = 1; in { a = a; b = a + 2; } We’ll separate the logic for this example, this will be the default.nix this is where having lib defined in your inline modules is helpful because you can just delete the section and paste it into your modules.nix:\n# default.nix let lib = import ; in lib.evalModules { modules = [ ./module.nix ]; } And in the module.nix:\n# module.nix { lib, pkgs, ...}: { options.etc = lib.mkOption { type = lib.types.attrsOf lib.types.path; default = { }; description = '' Specifies which paths are is /etc/ ''; }; config._module.args.pkgs = import { config = {}; overlays = []; }; config.etc.foo = pkgs.writeText \"foo\" '' foo configuration ''; } If you evaluate this with the following you will get an infinite recursion error. nix-instantiate --eval --strict -A config.etc This happens because --strict evaluates the etc, then it goes into the attrsOf, and the path nix repl nix-repl\u003e :l nix-repl\u003e hello.out.out.out In this example:\n:l loads the Nixpkgs library into the repl environment, making its definitions available.\nhello refers to the hello package definition within Nixpkgs. Packages in Nixpkgs are defined as derivations.\n.out is a common attribute name for the main output of a derivation (e.g., the installed package). Some packages, especially those with complex build processes or multiple outputs, might have nested output attributes. In the case of hello, accessing .out.out.out ultimately leads us to the derivation itself.\nThe key takeaway here is that when you evaluate a package in the nix repl, you’re often interacting with its derivation or one of its output paths in the Nix store. The «derivation ...» indicates that hello.out.out.out evaluates to a derivation – the blueprint for building the hello package. This is in contrast to --eval --strict, which tries to fully evaluate values, potentially leading to infinite recursion if it encounters a derivation that refers back to itself indirectly during attribute evaluation.\nOutput:\n«derivation /nix/store/b1vcpm321dwbwx6wj4n13l35f4y2wrfv-hello-2.12.1.drv» So it recurses through the entire thing and tries to evaluate its string. So we want to change the command from --eval --strict which is only based on evaluation to at least nix-instantiate which is based on derivations:\nnix-instantiate -A config.etc Output:\nwarning: you did not specify '--add-root'; the result might be removed by the garbage collector /nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv We don’t really have a derivation yet for example: # module.nix { lib, pkgs, ... }: { options.etc = lib.mkOption { type = lib.types.attrsOf (lib.types.attrsOf lib.types.path); default = {}; description = '' Specifies which paths are in /etc/ ''; }; config._module.args.pkgs = import { config = {}; overlays = []; }; config.etc.foo.bar = pkgs.writeText \"foo\" '' foo configuration ''; } Try to evaluate the above command with nix-instantiate -A config.etc and Nix doesn’t even try to build it. With nested attrsOf\nnix repl -f default.nix nix-repl\u003e config.etc { foo = { ... }; } nix-repl\u003e config.etc.foo { bar = «derivation /nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv»; } So config.foo is an attribute set and config.etc.foo is also an attribute set but it’s not a derivation by itself. So nix-instantiate does this one level of recursion here and it would have built foo value if it were a derivation. Example 5 We’ll use the same module.nix and default.nix from the previous example.\nBuilding More Complex Configurations with Modules In this next example, we’ll focus on a common task in system configuration: managing files within the /etc/ directory. We’ll define a module that allows us to specify the content of arbitrary files in /etc/ and then use a special Nix function to combine these individual file definitions into a single, manageable entity.\nWe’ll introduce a new option, options.etc, which will allow us to define the content of files within /etc/. Then, we’ll use pkgs.linkFarm to create a derivation that represents the entire /etc/ directory as a collection of symbolic links pointing to the individual file contents we’ve defined. This demonstrates how modules can abstract away the details of creating complex system configurations, providing a declarative and reproducible way to manage even fundamental aspects of the operating system.\nLet’s show how we can use Nix modules to declaratively manage the /etc/ directory\n# default.nix let lib = import ; in lib.evalModules { modules = [ ./module.nix ]; } # module.nix { lib, pkgs, config, ... }: { options.etc = lib.mkOption { type = lib.types.attrsOf (lib.types.attrsOf lib.types.path); default = {}; description = '' Specifies which paths are in /etc/ ''; }; options.etcCombined = lib.mkOption { type = lib.types.package; default = pkgs.linkFarm \"etc\" (lib.mapAttrsToList (name: value: { name = name; path = value; }) config.etc); }; config._module.args.pkgs = import { config = {}; overlays = []; }; config.etc.foo = pkgs.writeText \"foo\" '' foo configuration ''; config.etc.bar = pkgs.writeText \"bar\" '' bar configuration ''; } Run it with:\nnix-instantiate -A config.etcCombined Output:\n/nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv So we can see that it will instantiate, lets see if it will build: nix-build -A config.etcCombined Output:\nthese 3 derivations will be built: /nix/store/41yfxq4af1vrs0rrgfk5gc36kmjc7270-bar.drv /nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv /nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv building '/nix/store/41yfxq4af1vrs0rrgfk5gc36kmjc7270-bar.drv'... building '/nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv'... building '/nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv'... /nix/store/ca3wyk5m3qhy8n1nbn0181m29qvp1klp-etc nix-build -A config.etcCombined \u0026\u0026 ls result/ -laa Output:\n/nix/store/ca3wyk5m3qhy8n1nbn0181m29qvp1klp-etc dr-xr-xr-x - root 31 Dec 1969  . drwxrwxr-t - root 16 May 15:13  .. lrwxrwxrwx - root 31 Dec 1969  bar -\u003e /nix/store/1fsjyc2hmilab1qw6jfkf6cb767kz858-bar lrwxrwxrwx - root 31 Dec 1969  foo -\u003e /nix/store/wai5dycp0zx1lxg0rhpdxnydhiadpk05-foo We can see that foo and bar link to different derivations\nWhen trying to figure out which default to use for etcCombined infinisil went to the Nixpkgs Reference Manual. Make sure to go to the correct version.\n24.11pre-git\n25.05pre-git (i.e. unstable)\nOnce at the website press Ctrl+f and type symlinkjoin and hit enter.\nOr in your local copy of Nixpkgs you could go to nixpkgs/pkgs/build-support/ trivial-builders/default.nix. Then use your editors search feature, with nvim and helix you press /symlinkjoin or /linkFarm hit enter then press n to cycle to the next match. It will bring you to comments and up to date information.\n# linkFarm \"myexample\" [ { name = \"hello-test\"; path = pkgs.hello; } # { name = \"foobar\"; path = pkgs.stack; } ] Tests How to create a Derivation with passthru.tests outside of Nixpkgs and then run tests available to your package set? mkdir passthru-tests \u0026\u0026 cd passthru-tests Create a default.nix with the following:\n# default.nix let pkgs = import {}; package = pkgs.runCommand \"foo\" { passthru.tests.simple = pkgs.runCommand \"foo-test\" {} '' if [[ \"$(cat ${package})\" != \"foo\" ]]; then echo \"Result is not foo\" exit 1 fi touch $out ''; } '' echo foo \u003e $out ''; in package See if it will build:\nnix-build Try running the test:\nnix-build -A passthru.tests this derivation will be built: /nix/store/pqpqq9x1wnsabzbsb52z4g4y4zy6p7yx-foo-test.drv building '/nix/store/pqpqq9x1wnsabzbsb52z4g4y4zy6p7yx-foo-test.drv'... /nix/store/7bbw2ban0mgkh4d59yz3cnai4aavwvb6-foo-test Test 2 passthru.tests is the convention for defining tests associated with a derivation. The attributes in passthru are preserved and accessible after the derivation is built. let pkgs = import {}; package = pkgs.runCommand \"foo\" { passthru.tests.simple = pkgs.runCommand \"foo-test\" {} '' if [[ \"$(cat ${package})\" != \"foo\" ]]; then echo \"Result is not foo\" exit 1 fi touch $out ''; passthru.tests.version = pkgs.testers.testVersion { package = package; version = \"1.2\"; }; # pkgs.writeShellApplication script = '' #!${pkgs.runtimeShell} echo \"1.2\" ''; passAsFiles = [ \"script\" ]; } '' cp \"$scriptPath\" \"$out\" ''; in package Try to build it:\nnix-build -A passthru.tests testers.testVersion checks if an executable outputs a specific version string.\nnix-build -A passthru.tests specifically targets the derivations defined within the tests attribute of the main derivation.\nthese 3 derivations will be built: /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv /nix/store/s4iawjy5zpv89dbkc3zz7z3ngz4jq2cv-foo-test.drv /nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z-foo-test-version.drv building '/nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv'... cp: cannot stat '': No such file or directory error: builder for '/nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv' failed with exit code 1; last 1 log lines: \u003e cp: cannot stat '': No such file or directory For full logs, run: nix log /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv error: 1 dependencies of derivation '/nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z -foo-test-version.drv' failed to build error: build of '/nix/store/s4iawjy5zpv89dbkc3zz7z3ngz4jq2cv-foo-test.drv', '/nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z-foo-test-version.drv' failed Run nix-build with no arguments:\nnix-build nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq '.[].env' Output:\n{ \"__structuredAttrs\": \"\", \"buildCommand\": \"cp \\\"$scriptPath\\\" \\\"$out\\\"\\n\", \"buildInputs\": \"\", \"builder\": \"/nix/store/xg75pc4yyfd5n2fimhb98ps910q5lm5n-bash-5.2p37/bin/bash\", \"cmakeFlags\": \"\", \"configureFlags\": \"\", \"depsBuildBuild\": \"\", \"depsBuildBuildPropagated\": \"\", \"depsBuildTarget\": \"\", \"depsBuildTargetPropagated\": \"\", \"depsHostHost\": \"\", \"depsHostHostPropagated\": \"\", \"depsTargetTarget\": \"\", \"depsTargetTargetPropagated\": \"\", \"doCheck\": \"\", \"doInstallCheck\": \"\", \"enableParallelBuilding\": \"1\", \"enableParallelChecking\": \"1\", \"enableParallelInstalling\": \"1\", \"mesonFlags\": \"\", \"name\": \"foo\", \"nativeBuildInputs\": \"\", \"out\": \"/nix/store/9mcrnddb6lf1md14v4lj6s089i99l5k7-foo\", \"outputs\": \"out\", \"passAsFile\": \"buildCommand\", \"passAsFiles\": \"script\", \"patches\": \"\", \"propagatedBuildInputs\": \"\", \"propagatedNativeBuildInputs\": \"\", \"script\": \"#!/nix/store/xg75pc4yyfd5n2fimhb98ps910q5lm5n-bash-5.2p37/bin/bash\\necho \\\"1.2\\\"\\n\", \"stdenv\": \"/nix/store/lgydi1gl5wqcw6k4gyjbaxx7b40zxrsp-stdenv-linux\", \"strictDeps\": \"\", \"system\": \"x86_64-linux\" } nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq '.[].env.buildCommand' Output:\n\"cp \\\"$scriptPath\\\" \\\"$out\\\"\\n\" raw mode below nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq '.[].env.buildCommand' -r Output:\ncp \"$scriptPath\" \"$out\" It turns out the correct command was passAsFile not passAsFiles but that change wasn’t enough to fix it. passAsFiles expects a list of files, not a single file path. Running nix-build -A passthru.tests failed saying \u003e foo --version returned a non-zero exit code. let pkgs = import {}; package = pkgs.runCommand \"foo\" { #passthru.tests.simple = pkgs.runCommand \"foo-test\" {} '' # if [[ \"$(cat ${package})\" != \"foo\" ]]; then # echo \"Result is not foo\" # exit 1 # fi # touch $out #''; passthru.tests.version = pkgs.testers.testVersion { package = package; version = \"1.2\"; }; # pkgs.writeShellApplication script = '' #!${pkgs.runtimeShell} echo \"1.2\" ''; passAsFile = [\"script\"]; } '' mkdir -p \"$out/bin\" cp \"$scriptPath\" \"$out/bin/foo\" chmod +x \"$out/bin/foo\" ''; in package Build it:\nnix-build -A passthru.tests Output:\nthese 2 derivations will be built: /nix/store/lqrlcd64dmpzkggcfzlnsnwjd339czd3-foo.drv /nix/store/c3kw4xbdlrig08jrdm5wis1dmv2gnqsd-foo-test-version.drv building '/nix/store/lqrlcd64dmpzkggcfzlnsnwjd339czd3-foo.drv'... building '/nix/store/c3kw4xbdlrig08jrdm5wis1dmv2gnqsd-foo-test-version.drv'... 1.2 /nix/store/zsbk5zawak68ailvkwi2gad2bqbqmdz9-foo-test-version Key Takeaways for Debugging NixOS Modules nix-instantiate is Your Friend: Use nix-instantiate to evaluate your NixOS modules and pinpoint errors.\nUnlock Details with --show-trace: When errors occur, always append --show-trace to get a comprehensive stack trace, revealing the origin of the problem. Remember that in newer Nix versions, the most relevant parts of the trace are often at the bottom.\nUnderstand Option Types: Nix option types (raw, anything, string/str, lines, attrsOf) are not just about data types; they also dictate how values are merged and processed within the module system.\nBe Mindful of mkOptionDefault: While useful in specific scenarios, mkOptionDefault sets a lower priority default. For standard defaults that can be overridden by user configuration, define them directly within the config attribute using lib.mkDefault.\nUse builtins.addErrorContext: Enhance your custom error messages by providing specific context relevant to your module’s logic using builtins.addErrorContext.\nDerivations vs. Evaluation: Be aware of the difference between evaluating expressions (--eval --strict) and instantiating derivations (nix-instantiate). Strict evaluation can trigger infinite recursion if it encounters unevaluated derivations with cyclic dependencies during attribute access.\nExplore with nix repl: The nix repl allows you to interactively explore Nix expressions and the outputs of derivations, providing insights into the structure and values within Nixpkgs.\n","wordCount":"3448","inLanguage":"en","datePublished":"2025-05-15T10:08:17-04:00","dateModified":"2025-05-15T10:08:17-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/debugging_and_tracing_modules/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Debugging_and_tracing_modules</h1><div class=post-meta><span title='2025-05-15 10:08:17 -0400 EDT'>May 15, 2025</span></div></header><div class=post-content><h1 id=debugging-and-tracing-nixos-modules>Debugging and Tracing NixOS Modules<a hidden class=anchor aria-hidden=true href=#debugging-and-tracing-nixos-modules>#</a></h1><figure><img loading=lazy src=/images/gruv17.png alt=window_space width=1000></figure><ul><li><p>Other related post if you haven&rsquo;t read my previous post on modules, that may
be helpful before reading this one:</p><ul><li><p><a href=https://saylesss88.github.io/posts/nix_modules_explained/>nix-modules-explained</a></p></li><li><p>This post is my notes following Nix Hour 40. If it seems a little chaotic,
try watching one. They are hard to follow if you&rsquo;re not extremely
familiar with the concepts.</p></li><li><p><a href="https://www.youtube.com/watch?v=aLy8id4wr-M&amp;t=2120s">Nix Hour 40</a></p></li></ul></li></ul><p>Nix Code is particularly hard to <strong>debug</strong> because of (e.g. lazy evaluation,
declarative nature, layered modules)</p><ul><li>The following simple Nix code snippet illustrates a basic NixOS module
definition and how options are declared and configured. We&rsquo;ll use this example
to demonstrate fundamental debugging techniques using <code>nix-instantiate</code>.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>  modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    ({ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>      options<span style=color:#f92672>.</span>foo <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>        <span style=color:#75715e># type = lib.types.raw;</span>
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>anything;
</span></span><span style=display:flex><span>        <span style=color:#75715e># default = pkgs;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      config<span style=color:#f92672>.</span>foo <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        bar <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>        list <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> ];
</span></span><span style=display:flex><span>        baz <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#e6db74>&#34;baz&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      foo<span style=color:#f92672>.</span>baz <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>In the above code, adding <code>lib</code> to the function arguments isn&rsquo;t required but
if you were to move the module to another file it would fail without it
because <code>lib</code> comes from outside of it. So it&rsquo;s good practice to refer to <code>lib</code>
in the modules themselves.</p></li><li><p>You should <strong>always</strong> assign a type to your options, if you don&rsquo;t know which type
to use you could use <code>raw</code>. <code>raw</code> is a type that doesn&rsquo;t do any processing.
So if you were to assign the entire packages set to the option e.g.
<code>default = pkgs;</code> it wouldn&rsquo;t recurseinto all the packages and try to evaluate
them. There is also <code>anything</code>, that is useful if you do want to recurse into
the values.</p></li><li><p>The following is an example of how you would run this inside vim/neovim, the
rest of the examples will be from the command line:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=display:flex><span>:!<span style=color:#a6e22e>nix</span>-<span style=color:#a6e22e>instantiate</span> --<span style=color:#a6e22e>eval</span> -<span style=color:#a6e22e>A</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>foo</span> --<span style=color:#a6e22e>strict</span>
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span> bar <span style=color:#f92672>=</span> 10; baz <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>; list <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>]</span>; <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>To show the difference you could uncomment the <code>raw</code> type and comment the
<code>anything</code> type and run the above command again you&rsquo;ll see that you get an
error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>error: The option <span style=color:#e6db74>&#39;foo&#39;</span> is defined multiple times <span style=color:#66d9ef>while</span> it<span style=color:#960050;background-color:#1e0010>&#39;</span>s expected to be
</span></span><span style=display:flex><span>unique
</span></span></code></pre></div><p>To execute this command on the command line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval --strict -A config.foo
</span></span></code></pre></div><p>It will show you the start of a trace. To get the full trace add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval --strict -A config.foo --show-trace
</span></span></code></pre></div><h2 id=example-2>Example 2<a hidden class=anchor aria-hidden=true href=#example-2>#</a></h2><p>In the previous example, we looked at a simplified module. Now, let&rsquo;s examine a
more realistic scenario involving a basic NixOS configuration file
(<code>configuration.nix</code>).</p><p>This example will demonstrate how to use <code>nix-instantiate</code> to evaluate an entire
system configuration and how <code>--show-trace</code> helps in diagnosing errors within
this context.</p><p>Consider the following <code>configuration.nix</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>{ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>grub<span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nodev&#34;</span>;
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/devst&#34;</span>;
</span></span><span style=display:flex><span>  system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;24.11&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>This configuration snippet sets the GRUB bootloader device, defines a root
filesystem, and specifies the expected NixOS state version. To evaluate this
entire system configuration, you can use <code>nix-instantiate</code> and point it to the
<code>&lt;nixpkgs/nixos></code> entrypoint, providing our <code>configuration.nix</code> file as an
argument. The <code>-A system</code> flag selects the top-level <code>system</code> attribute, which
represents the instantiated system configuration.</li></ul><p><strong>Run</strong> it in with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate <span style=color:#e6db74>&#39;&lt;nixpkgs/nixos&gt;&#39;</span> --arg configuration ./configuration.nix -A system
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/nix/store/kfcwvvpdbsb3xcks1s76id16i1mc3l5k-nixos-system-nixos-25.05pre-git.drv
</span></span></code></pre></div><p>Ok, we can see that this successfully <em>instantiates</em>. Let&rsquo;s introduce an error
to trace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>grub<span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nodev&#34;</span>;
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/devst&#34;</span>;
</span></span><span style=display:flex><span>  system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> builtins<span style=color:#f92672>.</span>genList <span style=color:#e6db74>&#34;24.11&#34;</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>stack trace truncated; use <span style=color:#e6db74>&#39;--show-trace&#39;</span> to show the full, detailed trace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>error: expected an integer but found null: null
</span></span></code></pre></div><p>Rerun the command with <code>--show-trace</code> appended:</p><p>Or on the command line</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate <span style=color:#e6db74>&#39;&lt;nixpkgs/nixos&gt;&#39;</span> --arg configuration ./configuration.nix -A system --show-trace
</span></span></code></pre></div><ul><li>This outputs a much longer trace than the first example. It shows you the file
the error occured in and you can see that in this case they are a lot of
internal functions. (e.g. <code>at /nix/store/ccfwxygjrarahgfv5865x2f828sjr5h0- source/lib/attrsets.nix:1529:14:</code>)</li></ul><p>To show your own error message you could do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>grub<span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nodev&#34;</span>;
</span></span><span style=display:flex><span>  fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/devst&#34;</span>;
</span></span><span style=display:flex><span>  system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> builtins<span style=color:#f92672>.</span>addErrorContext <span style=color:#e6db74>&#34;AAAAAAAAAAAAAAAAA&#34;</span> (builtins<span style=color:#f92672>.</span>genList <span style=color:#e6db74>&#34;24.11&#34;</span> <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate <span style=color:#e6db74>&#39;&lt;nixpkgs/nixos&gt;&#39;</span> --arg configuration ./configuration.nix -A system --show-trace<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> … <span style=color:#66d9ef>while</span> evaluating the attribute <span style=color:#e6db74>&#39;value&#39;</span>
</span></span><span style=display:flex><span>     at /nix/store/ccfwxygjrarahgfv5865x2f828sjr5h0-source/lib/modules.nix:770:21:
</span></span><span style=display:flex><span>      769|             inherit <span style=color:#f92672>(</span>module<span style=color:#f92672>)</span> file;
</span></span><span style=display:flex><span>      770|             inherit value;
</span></span><span style=display:flex><span>         |                     ^
</span></span><span style=display:flex><span>      771|           <span style=color:#f92672>})</span> module.config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   … AAAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   … <span style=color:#66d9ef>while</span> calling the <span style=color:#e6db74>&#39;genList&#39;</span> builtin
</span></span><span style=display:flex><span>     at /home/jr/tests/configuration.nix:4:71:
</span></span><span style=display:flex><span>        3|   fileSystems.<span style=color:#e6db74>&#34;/&#34;</span>.device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/devst&#34;</span>;
</span></span><span style=display:flex><span>        4|   system.stateVersion <span style=color:#f92672>=</span> builtins.addErrorContext <span style=color:#e6db74>&#34;AAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>(</span>builtins.genList <span style=color:#e6db74>&#34;24.11&#34;</span> null<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>         |                                                                       ^
</span></span><span style=display:flex><span>        5| <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   … <span style=color:#66d9ef>while</span> evaluating the second argument passed to builtins.genList
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   error: expected an integer but found null: null
</span></span></code></pre></div><ul><li>In the latest nix they actually inverted the error messages so the most relevant
parts will be at the bottom.</li></ul><h2 id=example-3>Example 3<a hidden class=anchor aria-hidden=true href=#example-3>#</a></h2><p>Let&rsquo;s consider another example, this time demonstrating the definition of
configuration options using <code>lib.mkOption</code> within a module structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>  modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    ({ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>      options<span style=color:#f92672>.</span>ints <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>int;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>string;
</span></span><span style=display:flex><span>        <span style=color:#75715e># type = lib.types.attrsOf lib.types.string;</span>
</span></span><span style=display:flex><span>        default <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Instantiate</strong> this with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval --strict -A config.strings
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>evaluation warning: The type <span style=color:#e6db74>`</span>types.string<span style=color:#e6db74>`</span> is deprecated.
</span></span><span style=display:flex><span>See https://github.com/NixOS/nixpkgs/pull/66346 <span style=color:#66d9ef>for</span> better alternative types.
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;foo&#34;</span>
</span></span></code></pre></div><ul><li>Unfortunately you won&rsquo;t get the same depreciation warning from <code>lib.attrsOf</code></li></ul><p>Below is an interesting way to provide nixpkgs run it on the command line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export NIX_PATH<span style=color:#f92672>=</span>nixpkgs<span style=color:#f92672>=</span>channel:nixpkgs-unstable
</span></span><span style=display:flex><span>echo $NIX_PATH
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nixpkgs<span style=color:#f92672>=</span>channel:nixpkgs-unstable
</span></span></code></pre></div><p>The next two commands are to check that after using the above way to provide
<code>nixpkgs-unstable</code> that they both point to the same store path, the following
command will fetch nixpkgs from the channel above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --find-file nixpkgs
</span></span></code></pre></div><p><strong>Output</strong> 1️⃣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval channel:nixpkgs-unstable -A path
</span></span></code></pre></div><p><strong>Output</strong>: 2️⃣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source
</span></span></code></pre></div><ul><li>As you can see both commands produce the same store path</li></ul><h2 id=example-4>Example 4<a hidden class=anchor aria-hidden=true href=#example-4>#</a></h2><p>In our previous example, we encountered a deprecation warning for
<code>lib.types.string</code>. This next example delves deeper into why that type was
deprecated and demonstrates the consequences of its behavior, along with the
recommended fix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      ({lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>ints <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>int;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          <span style=color:#75715e># type = lib.types.string;</span>
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>string;
</span></span><span style=display:flex><span>          default <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOptionDefault {
</span></span><span style=display:flex><span>            x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Evaluate it with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval --strict -A config.strings
</span></span></code></pre></div><ul><li><p><code>types.string</code> depricated because it silently concatenates strings</p></li><li><p>The above command has two options with the same priority level and evaluates
to <code>{ x = "foobar"; }</code></p></li></ul><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>evaluation warning: The type <span style=color:#e6db74>`</span>types.string<span style=color:#e6db74>`</span> is deprecated. See https://github.
</span></span><span style=display:flex><span>com/NixOS/nixpkgs/pull/66346 <span style=color:#66d9ef>for</span> better alternative types.
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foobar&#34;</span>; <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><code>types.str</code> was the replacement for the depricated <code>types.string</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      ({lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>ints <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>int;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          <span style=color:#75715e># type = lib.types.string;</span>
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>str;
</span></span><span style=display:flex><span>          <span style=color:#75715e># Sets the value with a lower priority: lib.mkOptionDefault</span>
</span></span><span style=display:flex><span>          default <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOptionDefault {
</span></span><span style=display:flex><span>            x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>error:
</span></span><span style=display:flex><span>… <span style=color:#66d9ef>while</span> evaluating the attribute <span style=color:#e6db74>&#39;x&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>… <span style=color:#66d9ef>while</span> evaluating the attribute <span style=color:#e6db74>&#39;value&#39;</span>
</span></span><span style=display:flex><span> at /nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source/lib/modules.nix:1148:41:
</span></span><span style=display:flex><span> 1147|
</span></span><span style=display:flex><span> 1148|     optionalValue <span style=color:#f92672>=</span> <span style=color:#66d9ef>if</span> isDefined <span style=color:#66d9ef>then</span> <span style=color:#f92672>{</span> value <span style=color:#f92672>=</span> mergedValue; <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span> <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>     |                                         ^
</span></span><span style=display:flex><span> 1149|   <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>… <span style=color:#66d9ef>while</span> calling the <span style=color:#e6db74>&#39;foldl&#39;&#39; builtin
</span></span></span><span style=display:flex><span><span style=color:#e6db74> at /nix/store/ydrgwsibghsyx884qz97zbs1xs93yk11-source/lib/options.nix:508:8:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  507|     else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  508|       (foldl&#39;</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>     |        ^
</span></span><span style=display:flex><span>  509|         first: def:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>stack trace truncated; use <span style=color:#e6db74>&#39;--show-trace&#39;</span> to show the full, detailed trace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>error: The option <span style=color:#e6db74>`</span>strings.x<span style=color:#e6db74>&#39; has conflicting definition values:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- In `&lt;unknown-file&gt;&#39;</span>: <span style=color:#e6db74>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>- In <span style=color:#e6db74>`</span>&lt;unknown-file&gt;<span style=color:#960050;background-color:#1e0010>&#39;</span>: <span style=color:#e6db74>&#34;bar&#34;</span>
</span></span><span style=display:flex><span>Use <span style=color:#e6db74>`</span>lib.mkForce value<span style=color:#e6db74>`</span> or <span style=color:#e6db74>`</span>lib.mkDefault value<span style=color:#e6db74>`</span> to change the priority on any of these definitions.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>shell returned <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><ul><li><p>So types in the module system aren&rsquo;t just types in the conventional sense
but they also specify the emerging behavior of these values.</p></li><li><p>If we switch the type in the above example to <code>types.lines</code> you get this
returned, <code>{ x = "foo\nbar"; }</code></p></li><li><p><code>mkOptionDefault</code> isn&rsquo;t typically something you should generally use, instead
options have a <code>default</code> setting</p></li><li><p>If you want to make sure that you set a default but if the user specifies it,
it shouldn&rsquo;t get overridden. You should not set it in the following:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>lines;
</span></span><span style=display:flex><span>  default <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Because the above uses <code>mkOptionDefault</code> but instead in under the <code>config</code>
attribute like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># ...snip...</span>
</span></span><span style=display:flex><span>options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>lines;
</span></span><span style=display:flex><span>  <span style=color:#75715e># default = {</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># x = &#34;foo&#34;;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># };</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  strings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#75715e># ...snip...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      ({lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>ints <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>int;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          <span style=color:#75715e># type = lib.types.string;</span>
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>str;
</span></span><span style=display:flex><span>          <span style=color:#75715e># Sets the value with a lower priority: lib.mkOptionDefault</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#default = {</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#  x = &#34;foo&#34;;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#};</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        config<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        config<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p><strong>Output</strong>:</p><ul><li>This works now because there&rsquo;s no difference between <code>x</code> and <code>y</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span> x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>; y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>; <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=more-functionality-between-modules>More Functionality between modules<a hidden class=anchor aria-hidden=true href=#more-functionality-between-modules>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      ({lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>ints <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>int;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        options<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>          <span style=color:#75715e># type = lib.types.string;</span>
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>str;
</span></span><span style=display:flex><span>          <span style=color:#75715e># Sets the value with a lower priority: lib.mkOptionDefault</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#default = {</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#  x = &#34;foo&#34;;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#};</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        config<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          x <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkDefault <span style=color:#e6db74>&#34;foo&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        config<span style=color:#f92672>.</span>strings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x&#34;</span>;
</span></span><span style=display:flex><span>          y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li>The above command would cause a conflict without the <code>x = lib.mkDefault foo</code>
And this is typically what you want to do for defaults and modules in things
like nested configuration.</li></ul><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span> x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x&#34;</span>; y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>; <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=infinite-recursion-error>Infinite recursion error<a hidden class=anchor aria-hidden=true href=#infinite-recursion-error>#</a></h3><ol><li>A common pitfall is to introduce a hard to debug error <code>infinite recursion</code>
when shadowing a name. The simplest example for this is:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span> a <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>rec</span> { a <span style=color:#f92672>=</span> a; }
</span></span></code></pre></div><blockquote><p>💡<strong>TIP</strong>: Avoid <code>rec</code>. Use <code>let ... in</code>
Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span> a <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span> a <span style=color:#f92672>=</span> a;
</span></span><span style=display:flex><span> b <span style=color:#f92672>=</span> a <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></blockquote><p>We&rsquo;ll separate the logic for this example, this will be the <code>default.nix</code> this
is where having <code>lib</code> defined in your inline modules is helpful because you can
just delete the section and paste it into your <code>modules.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>./module.nix</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>And in the <code>module.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># module.nix</span>
</span></span><span style=display:flex><span>{ lib<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>etc <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>path;
</span></span><span style=display:flex><span>    default <span style=color:#f92672>=</span> { };
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Specifies which paths are is /etc/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>_module<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>etc<span style=color:#f92672>.</span>foo <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>writeText <span style=color:#e6db74>&#34;foo&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    foo configuration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>If you evaluate this with the following you will get an infinite recursion error.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate --eval --strict -A config.etc
</span></span></code></pre></div><ul><li>This happens because <code>--strict</code> evaluates the <code>etc</code>, then it goes into the
<code>attrsOf</code>, and the <code>path</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix repl
</span></span><span style=display:flex><span>nix-repl&gt; :l &lt;nixpkgs&gt;
</span></span><span style=display:flex><span>nix-repl&gt; hello.out.out.out
</span></span></code></pre></div><p>In this example:</p><ul><li><p><code>:l &lt;nixpkgs></code> loads the Nixpkgs library into the repl environment, making its
definitions available.</p></li><li><p><code>hello</code> refers to the <code>hello</code> package definition within Nixpkgs. Packages in
Nixpkgs are defined as <em>derivations</em>.</p></li><li><p><code>.out</code> is a common attribute name for the <em>main output</em> of a derivation
(e.g., the installed package). Some packages, especially those with complex
build processes or multiple outputs, might have nested output attributes.
In the case of <code>hello</code>, accessing <code>.out.out.out</code> ultimately leads us to the
<em>derivation</em> itself.</p></li></ul><p>The key takeaway here is that when you evaluate a package in the <code>nix repl</code>,
you&rsquo;re often interacting with its derivation or one of its output paths in the
Nix store. The <code>«derivation ...»</code> indicates that <code>hello.out.out.out</code> evaluates
to a derivation – the blueprint for building the <code>hello</code> package. This is in
contrast to <code>--eval --strict</code>, which tries to fully evaluate values, potentially
leading to infinite recursion if it encounters a derivation that refers back to
itself indirectly during attribute evaluation.</p><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>«derivation /nix/store/b1vcpm321dwbwx6wj4n13l35f4y2wrfv-hello-2.12.1.drv»
</span></span></code></pre></div><ul><li>So it recurses through the entire thing and tries to evaluate its string.</li></ul><p>So we want to change the command from <code>--eval --strict</code> which is only based on
evaluation to at least <code>nix-instantiate</code> which is based on derivations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate -A config.etc
</span></span></code></pre></div><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>warning: you did not specify <span style=color:#e6db74>&#39;--add-root&#39;</span>; the result might be removed by the garbage collector
</span></span><span style=display:flex><span>/nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv
</span></span></code></pre></div><ul><li>We don&rsquo;t really have a derivation yet for example:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># module.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>etc <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf (lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>path);
</span></span><span style=display:flex><span>    default <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Specifies which paths are in /etc/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>_module<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>etc<span style=color:#f92672>.</span>foo<span style=color:#f92672>.</span>bar <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>writeText <span style=color:#e6db74>&#34;foo&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    foo configuration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Try to evaluate the above command with <code>nix-instantiate -A config.etc</code> and Nix
doesn&rsquo;t even try to build it. With nested <code>attrsOf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix repl -f default.nix
</span></span><span style=display:flex><span>nix-repl&gt; config.etc
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  foo <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> ... <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>nix-repl&gt; config.etc.foo
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  bar <span style=color:#f92672>=</span> «derivation /nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv»;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>So <code>config.foo</code> is an attribute set and <code>config.etc.foo</code> is also an attribute
set but it&rsquo;s not a derivation by itself. So <code>nix-instantiate</code> does this one
level of recursion here and it would have built <code>foo</code> value if it were a
derivation.</li></ul><h3 id=example-5>Example 5<a hidden class=anchor aria-hidden=true href=#example-5>#</a></h3><p>We&rsquo;ll use the same <code>module.nix</code> and <code>default.nix</code> from the previous example.</p><p>Building More Complex Configurations with Modules
In this next example, we&rsquo;ll focus on a common task in system configuration:
managing files within the <code>/etc/</code> directory. We&rsquo;ll define a module that allows
us to specify the content of arbitrary files in <code>/etc/</code> and then use a special
Nix function to combine these individual file definitions into a single,
manageable entity.</p><p>We&rsquo;ll introduce a new option, <code>options.etc</code>, which will allow us to define the
content of files within <code>/etc/</code>. Then, we&rsquo;ll use <code>pkgs.linkFarm</code> to create a
derivation that represents the entire <code>/etc/</code> directory as a collection of
symbolic links pointing to the individual file contents we&rsquo;ve defined. This
demonstrates how modules can abstract away the details of creating complex
system configurations, providing a declarative and reproducible way to manage
even fundamental aspects of the operating system.</p><p>Let&rsquo;s show how we can use Nix modules to declaratively manage the <code>/etc/</code>
directory</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  lib <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs/lib&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>.</span>evalModules {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>./module.nix</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># module.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  lib<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: {
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>etc <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf (lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>attrsOf lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>path);
</span></span><span style=display:flex><span>    default <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Specifies which paths are in /etc/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>etcCombined <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>package;
</span></span><span style=display:flex><span>    default <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      pkgs<span style=color:#f92672>.</span>linkFarm <span style=color:#e6db74>&#34;etc&#34;</span>
</span></span><span style=display:flex><span>      (lib<span style=color:#f92672>.</span>mapAttrsToList (name: value: {
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> value;
</span></span><span style=display:flex><span>      }) config<span style=color:#f92672>.</span>etc);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>_module<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>etc<span style=color:#f92672>.</span>foo <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>writeText <span style=color:#e6db74>&#34;foo&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    foo configuration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>etc<span style=color:#f92672>.</span>bar <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>writeText <span style=color:#e6db74>&#34;bar&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    bar configuration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Run it with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-instantiate -A config.etcCombined
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv
</span></span></code></pre></div><ul><li>So we can see that it will instantiate, lets see if it will build:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build -A config.etcCombined
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>these <span style=color:#ae81ff>3</span> derivations will be built:
</span></span><span style=display:flex><span>/nix/store/41yfxq4af1vrs0rrgfk5gc36kmjc7270-bar.drv
</span></span><span style=display:flex><span>/nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv
</span></span><span style=display:flex><span>/nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/41yfxq4af1vrs0rrgfk5gc36kmjc7270-bar.drv&#39;</span>...
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/abyfp1rxk73p0n5kfilv7pawxwvc7hsg-foo.drv&#39;</span>...
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/3da61nmfk546qn2zpxsm57mq6vz6fjx8-etc.drv&#39;</span>...
</span></span><span style=display:flex><span>/nix/store/ca3wyk5m3qhy8n1nbn0181m29qvp1klp-etc
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build -A config.etcCombined <span style=color:#f92672>&amp;&amp;</span> ls result/ -laa
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/nix/store/ca3wyk5m3qhy8n1nbn0181m29qvp1klp-etc
</span></span><span style=display:flex><span>dr-xr-xr-x - root <span style=color:#ae81ff>31</span> Dec  <span style=color:#ae81ff>1969</span>  .
</span></span><span style=display:flex><span>drwxrwxr-t - root <span style=color:#ae81ff>16</span> May 15:13  ..
</span></span><span style=display:flex><span>lrwxrwxrwx - root <span style=color:#ae81ff>31</span> Dec  <span style=color:#ae81ff>1969</span>  bar -&gt; /nix/store/1fsjyc2hmilab1qw6jfkf6cb767kz858-bar
</span></span><span style=display:flex><span>lrwxrwxrwx - root <span style=color:#ae81ff>31</span> Dec  <span style=color:#ae81ff>1969</span>  foo -&gt; /nix/store/wai5dycp0zx1lxg0rhpdxnydhiadpk05-foo
</span></span></code></pre></div><ul><li><p>We can see that <code>foo</code> and <code>bar</code> link to different derivations</p></li><li><p>When trying to figure out which <code>default</code> to use for <code>etcCombined</code> infinisil
went to the Nixpkgs Reference Manual. Make sure to go to the correct version.</p><ul><li><p><a href=https://nixos.org/manual/nixpkgs/stable/>24.11pre-git</a></p></li><li><p><a href=https://nixos.org/manual/nixpkgs/unstable/>25.05pre-git</a> (i.e. unstable)</p></li><li><p>Once at the website press <code>Ctrl+f</code> and type <code>symlinkjoin</code> and hit enter.</p></li></ul></li></ul><p>Or in your local copy of Nixpkgs you could go to <code>nixpkgs/pkgs/build-support/ trivial-builders/default.nix</code>. Then use your editors search feature, with nvim
and helix you press <code>/symlinkjoin</code> or <code>/linkFarm</code> hit enter then press <code>n</code> to
cycle to the next match. It will bring you to comments and up to date
information.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># linkFarm &#34;myexample&#34; [ { name = &#34;hello-test&#34;; path = pkgs.hello; }</span>
</span></span><span style=display:flex><span><span style=color:#75715e># { name = &#34;foobar&#34;; path = pkgs.stack; } ]</span>
</span></span></code></pre></div><h3 id=tests>Tests<a hidden class=anchor aria-hidden=true href=#tests>#</a></h3><ul><li>How to create a Derivation with <code>passthru.tests</code> outside of Nixpkgs
and then run tests available to your package set?</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir passthru-tests <span style=color:#f92672>&amp;&amp;</span> cd passthru-tests
</span></span></code></pre></div><p>Create a <code>default.nix</code> with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  package <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>runCommand <span style=color:#e6db74>&#34;foo&#34;</span> {
</span></span><span style=display:flex><span>    passthru<span style=color:#f92672>.</span>tests<span style=color:#f92672>.</span>simple <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>runCommand <span style=color:#e6db74>&#34;foo-test&#34;</span> {} <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if [[ &#34;$(cat </span><span style=color:#e6db74>${</span>package<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34; != &#34;foo&#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;Result is not foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      touch $out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>  } <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo foo &gt; $out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>package
</span></span></code></pre></div><p>See if it will build:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build
</span></span></code></pre></div><p>Try running the test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build -A passthru.tests
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>this derivation will be built:
</span></span><span style=display:flex><span>/nix/store/pqpqq9x1wnsabzbsb52z4g4y4zy6p7yx-foo-test.drv
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/pqpqq9x1wnsabzbsb52z4g4y4zy6p7yx-foo-test.drv&#39;</span>...
</span></span><span style=display:flex><span>/nix/store/7bbw2ban0mgkh4d59yz3cnai4aavwvb6-foo-test
</span></span></code></pre></div><h3 id=test-2>Test 2<a hidden class=anchor aria-hidden=true href=#test-2>#</a></h3><ul><li><code>passthru.tests</code> is the convention for defining tests associated with a
derivation. The attributes in <code>passthru</code> are preserved and accessible after
the derivation is built.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  package <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>runCommand <span style=color:#e6db74>&#34;foo&#34;</span> {
</span></span><span style=display:flex><span>      passthru<span style=color:#f92672>.</span>tests<span style=color:#f92672>.</span>simple <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>runCommand <span style=color:#e6db74>&#34;foo-test&#34;</span> {} <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if [[ &#34;$(cat </span><span style=color:#e6db74>${</span>package<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34; != &#34;foo&#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Result is not foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        touch $out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      passthru<span style=color:#f92672>.</span>tests<span style=color:#f92672>.</span>version <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>testers<span style=color:#f92672>.</span>testVersion {
</span></span><span style=display:flex><span>         package <span style=color:#f92672>=</span> package;
</span></span><span style=display:flex><span>         version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.2&#34;</span>;
</span></span><span style=display:flex><span>     };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># pkgs.writeShellApplication</span>
</span></span><span style=display:flex><span>      script <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        #!</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>runtimeShell<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;1.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>      passAsFiles <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;script&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cp &#34;$scriptPath&#34; &#34;$out&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  package
</span></span></code></pre></div><p>Try to build it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build -A passthru.tests
</span></span></code></pre></div><ul><li><p><code>testers.testVersion</code> checks if an executable outputs a specific version string.</p></li><li><p><code>nix-build -A passthru.tests</code> specifically targets the derivations defined
within the tests attribute of the main derivation.</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>these <span style=color:#ae81ff>3</span> derivations will be built:
</span></span><span style=display:flex><span>  /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv
</span></span><span style=display:flex><span>  /nix/store/s4iawjy5zpv89dbkc3zz7z3ngz4jq2cv-foo-test.drv
</span></span><span style=display:flex><span>  /nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z-foo-test-version.drv
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv&#39;</span>...
</span></span><span style=display:flex><span>cp: cannot stat <span style=color:#e6db74>&#39;&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>error: builder <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;/nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv&#39;</span>
</span></span><span style=display:flex><span> failed with exit code 1;
</span></span><span style=display:flex><span>     last <span style=color:#ae81ff>1</span> log lines:
</span></span><span style=display:flex><span>     &gt; cp: cannot stat <span style=color:#e6db74>&#39;&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>     For full logs, run:
</span></span><span style=display:flex><span>       nix log /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv
</span></span><span style=display:flex><span>error: <span style=color:#ae81ff>1</span> dependencies of derivation <span style=color:#e6db74>&#39;/nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-foo-test-version.drv&#39;</span> failed to build
</span></span><span style=display:flex><span>error: build of <span style=color:#e6db74>&#39;/nix/store/s4iawjy5zpv89dbkc3zz7z3ngz4jq2cv-foo-test.drv&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;/nix/store/z3gi4pb8jn2h9rvk4dhba85fiphp5g4z-foo-test-version.drv&#39;</span> failed
</span></span></code></pre></div><p>Run <code>nix-build</code> with no arguments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq <span style=color:#e6db74>&#39;.[].env&#39;</span>
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;__structuredAttrs&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;buildCommand&#34;</span>: <span style=color:#e6db74>&#34;cp \&#34;$scriptPath\&#34; \&#34;$out\&#34;\n&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;buildInputs&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;builder&#34;</span>: <span style=color:#e6db74>&#34;/nix/store/xg75pc4yyfd5n2fimhb98ps910q5lm5n-bash-5.2p37/bin/bash&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;cmakeFlags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;configureFlags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsBuildBuild&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsBuildBuildPropagated&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsBuildTarget&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsBuildTargetPropagated&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsHostHost&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsHostHostPropagated&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsTargetTarget&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;depsTargetTargetPropagated&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;doCheck&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;doInstallCheck&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;enableParallelBuilding&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;enableParallelChecking&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;enableParallelInstalling&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;mesonFlags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;nativeBuildInputs&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;out&#34;</span>: <span style=color:#e6db74>&#34;/nix/store/9mcrnddb6lf1md14v4lj6s089i99l5k7-foo&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;outputs&#34;</span>: <span style=color:#e6db74>&#34;out&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;passAsFile&#34;</span>: <span style=color:#e6db74>&#34;buildCommand&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;passAsFiles&#34;</span>: <span style=color:#e6db74>&#34;script&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;patches&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;propagatedBuildInputs&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;propagatedNativeBuildInputs&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;script&#34;</span>: <span style=color:#e6db74>&#34;#!/nix/store/xg75pc4yyfd5n2fimhb98ps910q5lm5n-bash-5.2p37/bin/bash\necho \&#34;1.2\&#34;\n&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;stdenv&#34;</span>: <span style=color:#e6db74>&#34;/nix/store/lgydi1gl5wqcw6k4gyjbaxx7b40zxrsp-stdenv-linux&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;strictDeps&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;system&#34;</span>: <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;.[].env.buildCommand&#39;</span>
</span></span></code></pre></div><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#e6db74>&#34;cp \&#34;</span>$scriptPath<span style=color:#e6db74>\&#34; \&#34;</span>$out<span style=color:#e6db74>\&#34;\n&#34;</span>
</span></span></code></pre></div><ul><li>raw mode below</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix derivation show /nix/store/lyz86bd78p7f3yjy1qky6annmggymcwd-foo.drv | jq
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;.[].env.buildCommand&#39;</span> -r
</span></span></code></pre></div><p><strong>Output</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp <span style=color:#e6db74>&#34;</span>$scriptPath<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$out<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><ul><li>It turns out the correct command was <code>passAsFile</code> not <code>passAsFiles</code> but that
change wasn&rsquo;t enough to fix it. <code>passAsFiles</code> expects a list of files, not a
single file path. Running <code>nix-build -A passthru.tests</code> failed
saying <code>> foo --version returned a non-zero exit code.</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  package <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>runCommand <span style=color:#e6db74>&#34;foo&#34;</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>#passthru.tests.simple = pkgs.runCommand &#34;foo-test&#34; {} &#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#  if [[ &#34;$(cat ${package})&#34; != &#34;foo&#34; ]]; then</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#    echo &#34;Result is not foo&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#    exit 1</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#  fi</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#  touch $out</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#&#39;&#39;;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      passthru<span style=color:#f92672>.</span>tests<span style=color:#f92672>.</span>version <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>testers<span style=color:#f92672>.</span>testVersion {
</span></span><span style=display:flex><span>        package <span style=color:#f92672>=</span> package;
</span></span><span style=display:flex><span>        version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.2&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># pkgs.writeShellApplication</span>
</span></span><span style=display:flex><span>      script <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        #!</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>runtimeShell<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;1.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>      passAsFile <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;script&#34;</span>];
</span></span><span style=display:flex><span>    } <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mkdir -p &#34;$out/bin&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cp &#34;$scriptPath&#34; &#34;$out/bin/foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      chmod +x &#34;$out/bin/foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  package
</span></span></code></pre></div><p>Build it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-build -A passthru.tests
</span></span></code></pre></div><p><strong>Output:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>these <span style=color:#ae81ff>2</span> derivations will be built:
</span></span><span style=display:flex><span>  /nix/store/lqrlcd64dmpzkggcfzlnsnwjd339czd3-foo.drv
</span></span><span style=display:flex><span>  /nix/store/c3kw4xbdlrig08jrdm5wis1dmv2gnqsd-foo-test-version.drv
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/lqrlcd64dmpzkggcfzlnsnwjd339czd3-foo.drv&#39;</span>...
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/c3kw4xbdlrig08jrdm5wis1dmv2gnqsd-foo-test-version.drv&#39;</span>...
</span></span><span style=display:flex><span>1.2
</span></span><span style=display:flex><span>/nix/store/zsbk5zawak68ailvkwi2gad2bqbqmdz9-foo-test-version
</span></span></code></pre></div><h3 id=key-takeaways-for-debugging-nixos-modules>Key Takeaways for Debugging NixOS Modules<a hidden class=anchor aria-hidden=true href=#key-takeaways-for-debugging-nixos-modules>#</a></h3><ul><li><p><strong><code>nix-instantiate</code> is Your Friend:</strong> Use <code>nix-instantiate</code> to evaluate your
NixOS modules and pinpoint errors.</p></li><li><p><strong>Unlock Details with <code>--show-trace</code>:</strong> When errors occur, always append
<code>--show-trace</code> to get a comprehensive stack trace, revealing the origin of the
problem. Remember that in newer Nix versions, the most relevant parts of the
trace are often at the bottom.</p></li><li><p><strong>Understand Option Types:</strong> Nix option types (<code>raw</code>, <code>anything</code>, <code>string</code>/<code>str</code>,
<code>lines</code>, <code>attrsOf</code>) are not just about data types; they also dictate how values
are merged and processed within the module system.</p></li><li><p><strong>Be Mindful of <code>mkOptionDefault</code>:</strong> While useful in specific scenarios,
<code>mkOptionDefault</code> sets a lower priority default. For standard defaults that
can be overridden by user configuration, define them directly within the <code>config</code>
attribute using <code>lib.mkDefault</code>.</p></li><li><p><strong>Use <code>builtins.addErrorContext</code>:</strong> Enhance your custom error messages by
providing specific context relevant to your module&rsquo;s logic using
<code>builtins.addErrorContext</code>.</p></li><li><p><strong>Derivations vs. Evaluation:</strong> Be aware of the difference between evaluating
expressions (<code>--eval --strict</code>) and instantiating derivations (<code>nix-instantiate</code>).
Strict evaluation can trigger infinite recursion if it encounters unevaluated
derivations with cyclic dependencies during attribute access.</p></li><li><p><strong>Explore with <code>nix repl</code>:</strong> The <code>nix repl</code> allows you to interactively explore
Nix expressions and the outputs of derivations, providing insights into the
structure and values within Nixpkgs.</p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>