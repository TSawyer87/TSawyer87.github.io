<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building_your_config_as_a_package | NixOS Blog</title><meta name=keywords content><meta name=description content="Building your configuration as a Package

     




TL;DR This post demonstrates other ways to modularize your config as well as
going into more advanced outputs.


This allows you to build your configuration as a package allowing you to
separate the process of creating a configuration artifact and applying it to
the live system giving you a reusable artifact that can be used to deploy to
different systems. This can make it easier to isolate it from other parts of
your system making debugging easier."><meta name=author content="T Sawyer"><link rel=canonical href=https://tsawyer87.github.io/posts/building_your_config_as_a_package/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://tsawyer87.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tsawyer87.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tsawyer87.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tsawyer87.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tsawyer87.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tsawyer87.github.io/posts/building_your_config_as_a_package/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://tsawyer87.github.io/posts/building_your_config_as_a_package/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Building_your_config_as_a_package"><meta property="og:description" content="Building your configuration as a Package TL;DR This post demonstrates other ways to modularize your config as well as going into more advanced outputs.
This allows you to build your configuration as a package allowing you to separate the process of creating a configuration artifact and applying it to the live system giving you a reusable artifact that can be used to deploy to different systems. This can make it easier to isolate it from other parts of your system making debugging easier."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:21:54-04:00"><meta property="article:modified_time" content="2025-05-14T19:21:54-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building_your_config_as_a_package"><meta name=twitter:description content="Building your configuration as a Package

     




TL;DR This post demonstrates other ways to modularize your config as well as
going into more advanced outputs.


This allows you to build your configuration as a package allowing you to
separate the process of creating a configuration artifact and applying it to
the live system giving you a reusable artifact that can be used to deploy to
different systems. This can make it easier to isolate it from other parts of
your system making debugging easier."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tsawyer87.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Building_your_config_as_a_package","item":"https://tsawyer87.github.io/posts/building_your_config_as_a_package/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building_your_config_as_a_package","name":"Building_your_config_as_a_package","description":"Building your configuration as a Package TL;DR This post demonstrates other ways to modularize your config as well as going into more advanced outputs.\nThis allows you to build your configuration as a package allowing you to separate the process of creating a configuration artifact and applying it to the live system giving you a reusable artifact that can be used to deploy to different systems. This can make it easier to isolate it from other parts of your system making debugging easier.\n","keywords":[],"articleBody":"Building your configuration as a Package TL;DR This post demonstrates other ways to modularize your config as well as going into more advanced outputs.\nThis allows you to build your configuration as a package allowing you to separate the process of creating a configuration artifact and applying it to the live system giving you a reusable artifact that can be used to deploy to different systems. This can make it easier to isolate it from other parts of your system making debugging easier.\nThe following is a snip of my flake.nix:\n# flake.nix outputs = my-inputs @ { self, nixpkgs, treefmt-nix, ... }: let system = \"x86_64-linux\"; host = \"magic\"; userVars = { username = \"jr\"; gitUsername = \"TSawyer87\"; editor = \"hx\"; term = \"ghostty\"; keys = \"us\"; browser = \"firefox\"; flake = builtins.getEnv \"HOME\" + \"/my-nixos\"; }; inputs = my-inputs // { pkgs = import inputs.nixpkgs { inherit system; }; lib = { overlays = import ./lib/overlay.nix; nixOsModules = import ./nixos; homeModules = import ./home; inherit system; }; }; defaultConfig = import ./hosts/magic { inherit inputs; }; in { packages.${system} = { nixos = defaultConfig.config.system.build.toplevel; }; # NixOS configuration nixosConfigurations.${host} = lib.nixosSystem { inherit system; specialArgs = { inherit inputs system host userVars; }; modules = [ ./hosts/${host}/configuration.nix ]; }; }; } I didn’t want to change the name of inputs and effect other areas of my config so I first renamed @ inputs to @ my-inputs to make the merged attribute set use the original inputs name.\nNote, I’m still using home-manager as a module I just had to move it for all modules to be available inside the artifact built with nix build .#nixos\nBenefits of nixosConfiguration as a Package packages.x86_64-linux.nixos = self.nixosConfigurations.magic.config.system.build.toplevel;\nThe above expression exposes the toplevel derivation of nixosConfiguration.magic as a package, which is the complete system closure of your NixOS configuration. Here is the /hosts/magic/default.nix:\n# default.nix {inputs, ...}: inputs.nixpkgs.lib.nixosSystem { inherit (inputs.lib) system; specialArgs = {inherit inputs;}; modules = [./configuration.nix]; } Because we want all modules, not just NixOS modules this requires changing your configuration.nix to include your home-manager configuration. The core reason for this is that the packages.nixos output builds a NixOS system, and home-manager needs to be a part of that system’s definition to be included in the build. # configuration.nix { pkgs, inputs, host, system, userVars, ... }: { imports = [ ./hardware.nix ./security.nix ./users.nix inputs.lib.nixOsModules # inputs.nixos-hardware.nixosModules.common-gpu-amd inputs.nixos-hardware.nixosModules.common-cpu-amd inputs.stylix.nixosModules.stylix inputs.home-manager.nixosModules.home-manager ]; # Home-Manager Configuration needs to be here for home.packages to be available in the Configuration Package and VM i.e. `nix build .#nixos` home-manager = { useGlobalPkgs = true; useUserPackages = true; extraSpecialArgs = {inherit pkgs inputs host system userVars;}; users.jr = {...}: { imports = [ inputs.lib.homeModules ./home.nix ]; }; }; ############################################################################ nixpkgs.overlays = [inputs.lib.overlays]; [!NOTE]: inputs.lib.nixOsModules is equivalent to ../../home in my case and imports all of my nixOS modules. This comes from the flake.nix where I have nixOsModules = import ./nixos Which looks for a default.nix in the nixos directory.\nMy ~/my-nixos/nixos/default.nix looks like this:\n# default.nix {...}: { imports = [ ./drivers ./boot.nix ./utils.nix #..snip.. ]; } Usage and Deployment To build the package configuration run:\nnix build .#nixos sudo ./result/bin/switch-to-configuration switch Adding a Configuration VM Output Building on what we already have, add this under defaultConfig:\ndefaultConfig = import ./hosts/magic { inherit inputs; }; vmConfig = import ./lib/vms/nixos-vm.nix { nixosConfiguration = defaultConfig; inherit inputs; }; and under the line nixos = defaultConfig.config.system.build.toplevel add:\npackages.${system} = { # build and deploy with `nix build .#nixos` nixos = defaultConfig.config.system.build.toplevel; # Explicitly named Vm Configuration `nix build .#nixos-vm` nixos-vm = vmConfig.config.system.build.vm; } And in lib/vms/nixos-vm.nix:\n# nixos-vm.nix { inputs, nixosConfiguration, ... }: nixosConfiguration.extendModules { modules = [ ( {pkgs, ...}: { virtualisation.vmVariant = { virtualisation.forwardPorts = [ { from = \"host\"; host.port = 2222; guest.port = 22; } ]; imports = [ inputs.nixos-hardware.nixosModules.common-gpu-amd # hydenix-inputs.nixos-hardware.nixosModules.common-cpu-intel ]; virtualisation = { memorySize = 8192; cores = 6; diskSize = 20480; qemu = { options = [ \"-device virtio-vga-gl\" \"-display gtk,gl=on,grab-on-hover=on\" \"-usb -device usb-tablet\" \"-cpu host\" \"-enable-kvm\" \"-machine q35,accel=kvm\" \"-device intel-iommu\" \"-device ich9-intel-hda\" \"-device hda-output\" \"-vga none\" ]; }; }; #! you can set this to skip login for sddm # services.displayManager.autoLogin = { # enable = true; # user = \"jr\"; # }; services.xserver = { videoDrivers = [ \"virtio\" ]; }; system.stateVersion = \"24.11\"; }; # Enable SSH server services.openssh = { enable = true; settings = { PermitRootLogin = \"no\"; PasswordAuthentication = true; }; }; virtualisation.libvirtd.enable = true; environment.systemPackages = with pkgs; [ open-vm-tools spice-gtk spice-vdagent spice ]; services.qemuGuest.enable = true; services.spice-vdagentd = { enable = true; }; hardware.graphics.enable = true; # Enable verbose logging for home-manager # home-manager.verbose = true; } ) ]; } Uncomment and add your username to auto login. And an apps output that will build and deploy in one step with nix build .#deploy-nixos I’ll show packages and apps outputs for context:\n# flake.nix # Default package for tools packages.${system} = { default = pkgs.buildEnv { name = \"default-tools\"; paths = with pkgs; [helix git ripgrep nh]; }; # build and deploy with `nix build .#nixos` nixos = defaultConfig.config.system.build.toplevel; # Explicitly named Vm Configuration `nix build .#nixos-vm` nixos-vm = vmConfig.config.system.build.vm; }; apps.${system}.deploy-nixos = { type = \"app\"; program = toString (pkgs.writeScript \"deploy-nixos\" '' #!/bin/sh nix build .#nixos sudo ./result/bin/switch-to-configuration switch ''); meta = { description = \"Build and deploy NixOS configuration using nix build\"; license = lib.licenses.mit; maintainers = [ { name = userVars.gitUsername; email = userVars.gitEmail; } ]; }; }; Debugging Before switching configurations, verify what’s inside your built package: nix build .#nixos --dry-run nix build .#nixos-vm --dry-run nix show-derivation .#nixos Explore the Package Contents Once the build completes, you get a store path like /nix/store/...-nixos-system. You can explore the contents using:\nnix path-info -r .#nixos tree ./result ls -lh ./result/bin Instead of switching, test components:\nnix run .#nixos --help nix run .#nixos --version Load the flake into the repl:\nnixos-rebuild repl --flake . nix-repl\u003e flake.inputs nix-repl\u003e config.fonts.packages nix-repl\u003e config.system.build.toplevel nix-repl\u003e config.services.smartd.enable # true/false nix-repl\u003e flake.nixosConfigurations.nixos # confirm the built package nix-repl\u003e flake.nixosConfigurations.magic # Inspect host-specific config You can make a change to your configuration while in the repl and reload with :r Understanding Atomicity Atomicity means that a system update (e.g. changing configuration.nix or a flake-based toplevel package) either fully succeeds or leaves the system unchanged, preventing partial or inconsistent states.\nThe toplevel package is the entry point for your entire NixOS system, including the kernel, initrd, system services, and home-manager settings.\nBuilding with nix build .#nixos creates the toplevel derivation upfront, allowing you to inspect or copy it before activation:\nnix build .#nixos ls -l result In contrast, nixos-rebuild switch builds and activates in one step, similar to cargo run although both do involve the same toplevel derivation. The toplevel package can be copied to another NixOS machine:\nnix build .#nixos nix copy ./result --to ssh://jr@server # or for the vm nix build .#nixos-vm nix copy .#nixos-vm --to ssh://jr@server # activate the server ssh jr@server sudo /nix/store/...-nixos-system-magic/bin/switch-to-configuration switch I got the examples for building your configuration as a package and vm from the hydenix configuration and adapted them to my config.\nI got the examples for building your configuration as a package and vm from the hydenix configuration and adapted them to my config.\n","wordCount":"1206","inLanguage":"en","datePublished":"2025-05-14T19:21:54-04:00","dateModified":"2025-05-14T19:21:54-04:00","author":{"@type":"Person","name":"T Sawyer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tsawyer87.github.io/posts/building_your_config_as_a_package/"},"publisher":{"@type":"Organization","name":"NixOS Blog","logo":{"@type":"ImageObject","url":"https://tsawyer87.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tsawyer87.github.io/ accesskey=h title="NixOS Blog (Alt + H)">NixOS Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<a href=/index.xml title="RSS Feed"><img src=/rss.png alt="RSS Feed" style=width:24px;height:24px></a></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Building_your_config_as_a_package</h1><div class=post-meta><span title='2025-05-14 19:21:54 -0400 EDT'>May 14, 2025</span>&nbsp;·&nbsp;T Sawyer</div></header><div class=post-content><h1 id=building-your-configuration-as-a-package>Building your configuration as a Package<a hidden class=anchor aria-hidden=true href=#building-your-configuration-as-a-package>#</a></h1><figure><img loading=lazy src=/images/gruv4.png alt=gruv4 width=1000></figure><ul><li><p>TL;DR This post demonstrates other ways to modularize your config as well as
going into more advanced outputs.</p></li><li><p>This allows you to build your configuration as a package allowing you to
separate the process of creating a configuration artifact and applying it to
the live system giving you a reusable artifact that can be used to deploy to
different systems. This can make it easier to isolate it from other parts of
your system making debugging easier.</p></li></ul><p>The following is a snip of my <code>flake.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> my-inputs <span style=color:#f92672>@</span> {
</span></span><span style=display:flex><span>    self<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    treefmt-nix<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  }: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>    system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>    host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;magic&#34;</span>;
</span></span><span style=display:flex><span>    userVars <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jr&#34;</span>;
</span></span><span style=display:flex><span>      gitUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TSawyer87&#34;</span>;
</span></span><span style=display:flex><span>      editor <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hx&#34;</span>;
</span></span><span style=display:flex><span>      term <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ghostty&#34;</span>;
</span></span><span style=display:flex><span>      keys <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>;
</span></span><span style=display:flex><span>      browser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;firefox&#34;</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> builtins<span style=color:#f92672>.</span>getEnv <span style=color:#e6db74>&#34;HOME&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/my-nixos&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    inputs <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      my-inputs
</span></span><span style=display:flex><span>      <span style=color:#f92672>//</span> {
</span></span><span style=display:flex><span>        pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> inputs<span style=color:#f92672>.</span>nixpkgs {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        lib <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          overlays <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/overlay.nix</span>;
</span></span><span style=display:flex><span>          nixOsModules <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./nixos</span>;
</span></span><span style=display:flex><span>          homeModules <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./home</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    defaultConfig <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./hosts/magic</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> inputs;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span> {
</span></span><span style=display:flex><span>      packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        nixos <span style=color:#f92672>=</span> defaultConfig<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>toplevel;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>          <span style=color:#75715e># NixOS configuration</span>
</span></span><span style=display:flex><span>    nixosConfigurations<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>      specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>inherit</span> inputs system host userVars;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/$</span>{host}<span style=color:#e6db74>/configuration.nix</span>
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><ul><li><p>I didn&rsquo;t want to change the name of <code>inputs</code> and effect other areas of my
config so I first renamed <code>@ inputs</code> to <code>@ my-inputs</code> to make the merged
attribute set use the original <code>inputs</code> name.</p></li><li><p>Note, I&rsquo;m still using home-manager as a module I just had to move it for all
modules to be available inside the artifact built with <code>nix build .#nixos</code></p></li></ul><h2 id=benefits-of-nixosconfiguration-as-a-package>Benefits of nixosConfiguration as a Package<a hidden class=anchor aria-hidden=true href=#benefits-of-nixosconfiguration-as-a-package>#</a></h2><p><code>packages.x86_64-linux.nixos = self.nixosConfigurations.magic.config.system.build.toplevel;</code></p><ul><li>The above expression exposes the <code>toplevel</code> derivation of
<code>nixosConfiguration.magic</code> as a package, which is the complete system closure
of your NixOS configuration.</li></ul><p>Here is the <code>/hosts/magic/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span>{inputs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}:
</span></span><span style=display:flex><span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> (inputs<span style=color:#f92672>.</span>lib) system;
</span></span><span style=display:flex><span>  specialArgs <span style=color:#f92672>=</span> {<span style=color:#66d9ef>inherit</span> inputs;};
</span></span><span style=display:flex><span>  modules <span style=color:#f92672>=</span> [<span style=color:#e6db74>./configuration.nix</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Because we want all modules, not just NixOS modules this requires changing
your <code>configuration.nix</code> to include your home-manager configuration. The core
reason for this is that the <code>packages.nixos</code> output builds a NixOS system, and
home-manager needs to be a part of that system&rsquo;s definition to be included in
the build.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># configuration.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  host<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  system<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  userVars<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}: {
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./hardware.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./security.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./users.nix</span>
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixOsModules
</span></span><span style=display:flex><span>    <span style=color:#75715e># inputs.nixos-hardware.nixosModules.common-gpu-amd</span>
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>.</span>nixos-hardware<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>common-cpu-amd
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>.</span>stylix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>stylix
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>.</span>home-manager<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>home-manager
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Home-Manager Configuration needs to be here for home.packages to be available in the Configuration Package and VM i.e. `nix build .#nixos`</span>
</span></span><span style=display:flex><span>  home-manager <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    useGlobalPkgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    useUserPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    extraSpecialArgs <span style=color:#f92672>=</span> {<span style=color:#66d9ef>inherit</span> pkgs inputs host system userVars;};
</span></span><span style=display:flex><span>    users<span style=color:#f92672>.</span>jr <span style=color:#f92672>=</span> {<span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>      imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        inputs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>homeModules
</span></span><span style=display:flex><span>        <span style=color:#e6db74>./home.nix</span>
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#75715e>############################################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nixpkgs<span style=color:#f92672>.</span>overlays <span style=color:#f92672>=</span> [inputs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>overlays];
</span></span></code></pre></div><blockquote><p>[!NOTE]: <code>inputs.lib.nixOsModules</code> is equivalent to <code>../../home</code> in my case
and imports all of my nixOS modules. This comes from the <code>flake.nix</code> where I
have <code>nixOsModules = import ./nixos</code> Which looks for a <code>default.nix</code> in the
<code>nixos</code> directory.</p></blockquote><p>My <code>~/my-nixos/nixos/default.nix</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># default.nix</span>
</span></span><span style=display:flex><span>{<span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./drivers</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./boot.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./utils.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#..snip..</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=usage-and-deployment>Usage and Deployment<a hidden class=anchor aria-hidden=true href=#usage-and-deployment>#</a></h2><p>To build the package configuration run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix build <span style=color:#f92672>.</span><span style=color:#75715e>#nixos</span>
</span></span><span style=display:flex><span>sudo <span style=color:#e6db74>./result/bin/switch-to-configuration</span> switch
</span></span></code></pre></div><h2 id=adding-a-configuration-vm-output>Adding a Configuration VM Output<a hidden class=anchor aria-hidden=true href=#adding-a-configuration-vm-output>#</a></h2><p>Building on what we already have, add this under <code>defaultConfig</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>    defaultConfig <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./hosts/magic</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> inputs;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vmConfig <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/vms/nixos-vm.nix</span> {
</span></span><span style=display:flex><span>      nixosConfiguration <span style=color:#f92672>=</span> defaultConfig;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> inputs;
</span></span><span style=display:flex><span>    };
</span></span></code></pre></div><p>and under the line <code>nixos = defaultConfig.config.system.build.toplevel</code> add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e># build and deploy with `nix build .#nixos`</span>
</span></span><span style=display:flex><span>    nixos <span style=color:#f92672>=</span> defaultConfig<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>toplevel;
</span></span><span style=display:flex><span>    <span style=color:#75715e># Explicitly named Vm Configuration `nix build .#nixos-vm`</span>
</span></span><span style=display:flex><span>    nixos-vm <span style=color:#f92672>=</span> vmConfig<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>vm;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And in <code>lib/vms/nixos-vm.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># nixos-vm.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  nixosConfiguration<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}:
</span></span><span style=display:flex><span>nixosConfiguration<span style=color:#f92672>.</span>extendModules {
</span></span><span style=display:flex><span>  modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>      {pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span>}: {
</span></span><span style=display:flex><span>        virtualisation<span style=color:#f92672>.</span>vmVariant <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          virtualisation<span style=color:#f92672>.</span>forwardPorts <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              from <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;host&#34;</span>;
</span></span><span style=display:flex><span>              host<span style=color:#f92672>.</span>port <span style=color:#f92672>=</span> <span style=color:#ae81ff>2222</span>;
</span></span><span style=display:flex><span>              guest<span style=color:#f92672>.</span>port <span style=color:#f92672>=</span> <span style=color:#ae81ff>22</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ];
</span></span><span style=display:flex><span>          imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            inputs<span style=color:#f92672>.</span>nixos-hardware<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>common-gpu-amd
</span></span><span style=display:flex><span>            <span style=color:#75715e># hydenix-inputs.nixos-hardware.nixosModules.common-cpu-intel</span>
</span></span><span style=display:flex><span>          ];
</span></span><span style=display:flex><span>          virtualisation <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            memorySize <span style=color:#f92672>=</span> <span style=color:#ae81ff>8192</span>;
</span></span><span style=display:flex><span>            cores <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span>            diskSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>20480</span>;
</span></span><span style=display:flex><span>            qemu <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>              options <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-device virtio-vga-gl&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-display gtk,gl=on,grab-on-hover=on&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-usb -device usb-tablet&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-cpu host&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-enable-kvm&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-machine q35,accel=kvm&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-device intel-iommu&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-device ich9-intel-hda&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-device hda-output&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;-vga none&#34;</span>
</span></span><span style=display:flex><span>              ];
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>          <span style=color:#75715e>#! you can set this to skip login for sddm</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># services.displayManager.autoLogin = {</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#   enable = true;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>#   user = &#34;jr&#34;;</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># };</span>
</span></span><span style=display:flex><span>          services<span style=color:#f92672>.</span>xserver <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            videoDrivers <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;virtio&#34;</span>
</span></span><span style=display:flex><span>            ];
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;24.11&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Enable SSH server</span>
</span></span><span style=display:flex><span>        services<span style=color:#f92672>.</span>openssh <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            PermitRootLogin <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;no&#34;</span>;
</span></span><span style=display:flex><span>            PasswordAuthentication <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        virtualisation<span style=color:#f92672>.</span>libvirtd<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>          open-vm-tools
</span></span><span style=display:flex><span>          spice-gtk
</span></span><span style=display:flex><span>          spice-vdagent
</span></span><span style=display:flex><span>          spice
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>        services<span style=color:#f92672>.</span>qemuGuest<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        services<span style=color:#f92672>.</span>spice-vdagentd <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        hardware<span style=color:#f92672>.</span>graphics<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Enable verbose logging for home-manager</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># home-manager.verbose = true;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Uncomment and add your username to auto login.</li></ul><p>And an <code>apps</code> output that will build and deploy in one step with
<code>nix build .#deploy-nixos</code> I&rsquo;ll show <code>packages</code> and <code>apps</code> outputs for
context:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>   <span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Default package for tools</span>
</span></span><span style=display:flex><span>    packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      default <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>buildEnv {
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-tools&#34;</span>;
</span></span><span style=display:flex><span>        paths <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [helix git ripgrep nh];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#75715e># build and deploy with `nix build .#nixos`</span>
</span></span><span style=display:flex><span>      nixos <span style=color:#f92672>=</span> defaultConfig<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>toplevel;
</span></span><span style=display:flex><span>      <span style=color:#75715e># Explicitly named Vm Configuration `nix build .#nixos-vm`</span>
</span></span><span style=display:flex><span>      nixos-vm <span style=color:#f92672>=</span> vmConfig<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>vm;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    apps<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>deploy-nixos <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;app&#34;</span>;
</span></span><span style=display:flex><span>      program <span style=color:#f92672>=</span> toString (pkgs<span style=color:#f92672>.</span>writeScript <span style=color:#e6db74>&#34;deploy-nixos&#34;</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        #!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        nix build .#nixos
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sudo ./result/bin/switch-to-configuration switch
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>);
</span></span><span style=display:flex><span>      meta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build and deploy NixOS configuration using nix build&#34;</span>;
</span></span><span style=display:flex><span>        license <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>licenses<span style=color:#f92672>.</span>mit;
</span></span><span style=display:flex><span>        maintainers <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> userVars<span style=color:#f92672>.</span>gitUsername;
</span></span><span style=display:flex><span>            email <span style=color:#f92672>=</span> userVars<span style=color:#f92672>.</span>gitEmail;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span></code></pre></div><h3 id=debugging>Debugging<a hidden class=anchor aria-hidden=true href=#debugging>#</a></h3><ul><li>Before switching configurations, verify what&rsquo;s inside your built package:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix build .#nixos --dry-run
</span></span><span style=display:flex><span>nix build .#nixos-vm --dry-run
</span></span><span style=display:flex><span>nix show-derivation .#nixos
</span></span></code></pre></div><ul><li>Explore the Package Contents</li></ul><p>Once the build completes, you get a store path like
<code>/nix/store/...-nixos-system</code>. You can explore the contents using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix path-info -r .#nixos
</span></span><span style=display:flex><span>tree ./result
</span></span><span style=display:flex><span>ls -lh ./result/bin
</span></span></code></pre></div><p>Instead of switching, test components:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix run .#nixos --help
</span></span><span style=display:flex><span>nix run .#nixos --version
</span></span></code></pre></div><p>Load the flake into the repl:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nixos-rebuild repl --flake .
</span></span><span style=display:flex><span>nix-repl&gt; flake.inputs
</span></span><span style=display:flex><span>nix-repl&gt; config.fonts.packages
</span></span><span style=display:flex><span>nix-repl&gt; config.system.build.toplevel
</span></span><span style=display:flex><span>nix-repl&gt; config.services.smartd.enable <span style=color:#75715e># true/false</span>
</span></span><span style=display:flex><span>nix-repl&gt; flake.nixosConfigurations.nixos <span style=color:#75715e># confirm the built package</span>
</span></span><span style=display:flex><span>nix-repl&gt; flake.nixosConfigurations.magic <span style=color:#75715e># Inspect host-specific config</span>
</span></span></code></pre></div><ul><li>You can make a change to your configuration while in the repl and reload with
<code>:r</code></li></ul><h3 id=understanding-atomicity>Understanding Atomicity<a hidden class=anchor aria-hidden=true href=#understanding-atomicity>#</a></h3><ul><li><p>Atomicity means that a system update (e.g. changing <code>configuration.nix</code> or a
flake-based <code>toplevel</code> package) either fully succeeds or leaves the system
unchanged, preventing partial or inconsistent states.</p></li><li><p>The <code>toplevel</code> package is the entry point for your entire NixOS system,
including the kernel, initrd, system services, and <code>home-manager</code> settings.</p></li><li><p>Building with <code>nix build .#nixos</code> creates the <code>toplevel</code> derivation upfront,
allowing you to inspect or copy it before activation:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix build <span style=color:#f92672>.</span><span style=color:#75715e>#nixos</span>
</span></span><span style=display:flex><span>ls <span style=color:#960050;background-color:#1e0010>-</span>l result
</span></span></code></pre></div><ul><li>In contrast, <code>nixos-rebuild switch</code> builds and activates in one step, similar
to <code>cargo run</code> although both do involve the same <code>toplevel</code> derivation.</li></ul><p>The <code>toplevel</code> package can be copied to another NixOS machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix build <span style=color:#f92672>.</span><span style=color:#75715e>#nixos</span>
</span></span><span style=display:flex><span>nix copy <span style=color:#e6db74>./result</span> <span style=color:#960050;background-color:#1e0010>--</span>to <span style=color:#e6db74>ssh://jr@server</span>
</span></span><span style=display:flex><span><span style=color:#75715e># or for the vm</span>
</span></span><span style=display:flex><span>nix build <span style=color:#f92672>.</span><span style=color:#75715e>#nixos-vm</span>
</span></span><span style=display:flex><span>nix copy <span style=color:#f92672>.</span><span style=color:#75715e>#nixos-vm --to ssh://jr@server</span>
</span></span><span style=display:flex><span><span style=color:#75715e># activate the server</span>
</span></span><span style=display:flex><span>ssh jr<span style=color:#f92672>@</span>server
</span></span><span style=display:flex><span>sudo <span style=color:#e6db74>/nix/store/...-nixos-system-magic/bin/switch-to-configuration</span> switch
</span></span></code></pre></div><ul><li><p>I got the examples for building your configuration as a package and vm from
the <a href="https://github.com/richen604/hydenix/tree/main?tab=readme-ov-file">hydenix</a>
configuration and adapted them to <a href=https://github.com/saylesss88/flake>my config</a>.</p></li><li><p>I got the examples for building your configuration as a package and vm from
the <a href="https://github.com/richen604/hydenix/tree/main?tab=readme-ov-file">hydenix</a>
configuration and adapted them to <a href=https://github.com/saylesss88/flake>my config</a>.</p></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tsawyer87.github.io/>NixOS Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>